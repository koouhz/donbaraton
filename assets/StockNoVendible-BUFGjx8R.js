import{r as i,s as d,j as e,X as L,P as N,i as E,b as P}from"./index-hR7h3xft.js";import{n,F as V,L as W}from"./index-BTmhdvE4.js";import{T as C}from"./triangle-alert-B_IWcPwx.js";import{R as F}from"./refresh-cw-SHhOlYLT.js";import{S as M}from"./search-BOrDwhaZ.js";import{F as U}from"./file-text-yG9jYhSI.js";import{T as k}from"./trash-2-C990xH84.js";import{C as q}from"./clock-B7rEP_ha.js";function Z(){const[l,D]=i.useState([]),[R,f]=i.useState(!0),[x,S]=i.useState(""),[u,z]=i.useState(""),[c,g]=i.useState("");i.useEffect(()=>{h()},[x,u]);const h=async()=>{f(!0);try{const{data:o,error:r}=await d.rpc("fn_leer_stock_no_vendible",{p_estado:x||null,p_motivo:u||null});if(r)throw r;D(o||[])}catch(o){console.error("Error al cargar stock no vendible:",o),n.error("Error al cargar datos")}finally{f(!1)}},y=async(o,r)=>{try{if(r==="RECUPERADO"){const{data:s,error:j}=await d.from("stock_no_vendible").select("id_producto, cantidad, estado").eq("id_registro",o).single();if(j){console.error("Error al obtener registro:",j),n.error("Error al obtener datos del producto");return}if(s&&s.estado!=="RECUPERADO"){const{data:m,error:I}=await d.from("productos").select("stock_actual").eq("id_producto",s.id_producto).single();if(!I&&m){const O=(m.stock_actual||0)+s.cantidad,{error:v}=await d.from("productos").update({stock_actual:O}).eq("id_producto",s.id_producto);if(v){console.error("Error al actualizar stock:",v),n.error("Error al devolver producto al inventario");return}const B=Date.now(),T=Math.floor(Math.random()*1e3);await d.from("movimientos_inventario").insert({id_movimiento:`MOV-REC-${B}-${T}`,id_producto:s.id_producto,tipo:"ENTRADA",cantidad:s.cantidad,documento:o,motivo:"RECUPERACION_STOCK_NO_VENDIBLE",fecha_hora:new Date().toISOString()}),n.success(`Producto recuperado y devuelto al inventario (+${s.cantidad} unidades)`)}}else if(s&&s.estado==="RECUPERADO"){n.error("Este producto ya fue recuperado anteriormente");return}}const{error:a}=await d.from("stock_no_vendible").update({estado:r}).eq("id_registro",o);if(a)throw a;r!=="RECUPERADO"&&n.success(`Estado actualizado a: ${r}`),h()}catch(a){console.error("Error al actualizar estado:",a),n.error("Error al actualizar estado")}},w=o=>o==="DAÑADO"?{background:"#ffebee",color:"#c62828",icon:e.jsx(C,{size:14})}:{background:"#fff3e0",color:"#ef6c00",icon:e.jsx(P,{size:14})},_=o=>{switch(o){case"PENDIENTE":return{background:"#fff8e1",color:"#f57f17",icon:e.jsx(q,{size:14})};case"DESCARTADO":return{background:"#ffebee",color:"#c62828",icon:e.jsx(k,{size:14})};case"RECUPERADO":return{background:"#e8f5e9",color:"#2e7d32",icon:e.jsx(E,{size:14})};default:return{background:"#f5f5f5",color:"#666"}}},A=o=>new Date(o).toLocaleDateString("es-BO",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}),b=l.filter(o=>!c||o.producto?.toLowerCase().includes(c.toLowerCase())||o.codigo_interno?.toLowerCase().includes(c.toLowerCase())),p={total:l.length,danados:l.filter(o=>o.motivo==="DAÑADO").length,vencidos:l.filter(o=>o.motivo==="VENCIDO").length,pendientes:l.filter(o=>o.estado==="PENDIENTE").length};return e.jsxs("div",{style:t.container,children:[e.jsx(V,{position:"top-right"}),e.jsxs("div",{style:t.header,children:[e.jsxs("h2",{style:t.title,children:[e.jsx(C,{size:28,color:"#ef6c00"}),"Stock No Vendible"]}),e.jsxs("button",{style:t.refreshButton,onClick:h,children:[e.jsx(F,{size:18}),"Actualizar"]})]}),e.jsxs("div",{style:t.statsGrid,children:[e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #ef6c00"},children:[e.jsx("span",{style:t.statValue,children:p.total}),e.jsx("span",{style:t.statLabel,children:"Total Registros"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #c62828"},children:[e.jsx("span",{style:t.statValue,children:p.danados}),e.jsx("span",{style:t.statLabel,children:"Dañados"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #f57f17"},children:[e.jsx("span",{style:t.statValue,children:p.vencidos}),e.jsx("span",{style:t.statLabel,children:"Vencidos"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #1976d2"},children:[e.jsx("span",{style:t.statValue,children:p.pendientes}),e.jsx("span",{style:t.statLabel,children:"Pendientes"})]})]}),e.jsxs("div",{style:t.filtersSection,children:[e.jsxs("div",{style:t.searchBox,children:[e.jsx(M,{size:18,color:"#999"}),e.jsx("input",{type:"text",placeholder:"Buscar producto...",value:c,onChange:o=>g(o.target.value),style:t.searchInput}),c&&e.jsx("button",{style:t.clearButton,onClick:()=>g(""),children:e.jsx(L,{size:16})})]}),e.jsxs("select",{style:t.select,value:u,onChange:o=>z(o.target.value),children:[e.jsx("option",{value:"",children:"Todos los motivos"}),e.jsx("option",{value:"DAÑADO",children:"Dañados"}),e.jsx("option",{value:"VENCIDO",children:"Vencidos"})]}),e.jsxs("select",{style:t.select,value:x,onChange:o=>S(o.target.value),children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"PENDIENTE",children:"Pendientes"}),e.jsx("option",{value:"DESCARTADO",children:"Descartados"}),e.jsx("option",{value:"RECUPERADO",children:"Recuperados"})]})]}),R?e.jsxs("div",{style:t.loadingState,children:[e.jsx(W,{size:40,style:{animation:"spin 1s linear infinite"}}),e.jsx("span",{children:"Cargando stock no vendible..."})]}):b.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(N,{size:60,color:"#ccc"}),e.jsx("h3",{children:"No hay registros"}),e.jsx("p",{children:"No se encontraron productos en stock no vendible"})]}):e.jsx("div",{style:t.tableContainer,children:e.jsxs("table",{style:t.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.th,children:"Producto"}),e.jsx("th",{style:t.th,children:"Código"}),e.jsx("th",{style:t.th,children:"Cantidad"}),e.jsx("th",{style:t.th,children:"Motivo"}),e.jsx("th",{style:t.th,children:"Estado"}),e.jsx("th",{style:t.th,children:"Fecha"}),e.jsx("th",{style:t.th,children:"Devolución"}),e.jsx("th",{style:t.th,children:"Acciones"})]})}),e.jsx("tbody",{children:b.map(o=>{const r=w(o.motivo),a=_(o.estado);return e.jsxs("tr",{style:t.tr,children:[e.jsx("td",{style:t.td,children:e.jsx("strong",{children:o.producto})}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:t.codigo,children:o.codigo_interno})}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:t.cantidad,children:o.cantidad})}),e.jsx("td",{style:t.td,children:e.jsxs("span",{style:{...t.badge,background:r.background,color:r.color},children:[r.icon,o.motivo]})}),e.jsx("td",{style:t.td,children:e.jsxs("span",{style:{...t.badge,background:a.background,color:a.color},children:[a.icon,o.estado]})}),e.jsx("td",{style:t.td,children:e.jsx("small",{children:A(o.fecha)})}),e.jsx("td",{style:t.td,children:e.jsxs("span",{style:t.devolucionRef,children:[e.jsx(U,{size:14}),o.devolucion_origen||"-"]})}),e.jsx("td",{style:t.td,children:o.estado==="PENDIENTE"&&e.jsxs("div",{style:t.actionButtons,children:[e.jsx("button",{style:t.btnDescartar,onClick:()=>y(o.id,"DESCARTADO"),title:"Marcar como descartado",children:e.jsx(k,{size:14})}),e.jsx("button",{style:t.btnRecuperar,onClick:()=>y(o.id,"RECUPERADO"),title:"Marcar como recuperado",children:e.jsx(E,{size:14})})]})})]},o.id)})})]})}),e.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `})]})}const t={container:{padding:"20px",maxWidth:"1400px",margin:"0 auto"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px",flexWrap:"wrap",gap:"15px"},title:{display:"flex",alignItems:"center",gap:"12px",fontSize:"24px",fontWeight:"700",color:"#333",margin:0},refreshButton:{display:"flex",alignItems:"center",gap:"8px",padding:"10px 16px",background:"#f5f5f5",color:"#333",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"500",cursor:"pointer"},statsGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))",gap:"15px",marginBottom:"20px"},statCard:{background:"white",borderRadius:"12px",padding:"20px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},statValue:{fontSize:"28px",fontWeight:"700",color:"#333",display:"block"},statLabel:{fontSize:"13px",color:"#6c757d",marginTop:"5px",display:"block"},filtersSection:{display:"flex",gap:"12px",marginBottom:"20px",flexWrap:"wrap"},searchBox:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 15px",background:"white",borderRadius:"10px",border:"1px solid #e9ecef",flex:"1",minWidth:"250px"},searchInput:{border:"none",outline:"none",fontSize:"14px",flex:1},clearButton:{background:"none",border:"none",cursor:"pointer",color:"#999",padding:"2px"},select:{padding:"10px 15px",border:"1px solid #e9ecef",borderRadius:"10px",fontSize:"14px",background:"white",minWidth:"160px"},tableContainer:{background:"white",borderRadius:"12px",overflow:"hidden",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},table:{width:"100%",borderCollapse:"collapse"},th:{padding:"14px 16px",textAlign:"left",background:"#f8f9fa",color:"#495057",fontWeight:"600",fontSize:"13px",borderBottom:"2px solid #e9ecef"},tr:{borderBottom:"1px solid #f0f0f0",transition:"background 0.2s"},td:{padding:"14px 16px",fontSize:"14px",color:"#333"},badge:{display:"inline-flex",alignItems:"center",gap:"5px",padding:"5px 10px",borderRadius:"6px",fontSize:"12px",fontWeight:"600"},codigo:{fontFamily:"monospace",background:"#f5f5f5",padding:"3px 8px",borderRadius:"4px",fontSize:"12px"},cantidad:{fontWeight:"700",fontSize:"16px",color:"#ef6c00"},devolucionRef:{display:"flex",alignItems:"center",gap:"5px",color:"#666",fontSize:"12px"},actionButtons:{display:"flex",gap:"8px"},btnDescartar:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",background:"#ffebee",color:"#c62828",border:"none",borderRadius:"8px",cursor:"pointer"},btnRecuperar:{display:"flex",alignItems:"center",justifyContent:"center",width:"32px",height:"32px",background:"#e8f5e9",color:"#2e7d32",border:"none",borderRadius:"8px",cursor:"pointer"},loadingState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",color:"#6c757d",gap:"15px"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",background:"white",borderRadius:"12px",color:"#6c757d",textAlign:"center"}};export{Z as default};
