import{c as J,r as s,s as C,j as e,o as Q,E as X,b as K,i as A,X as Y}from"./index-hR7h3xft.js";import{n as p,F as Z,L as E}from"./index-BTmhdvE4.js";import{U as ee}from"./user-vBIlvuDL.js";import{D as O}from"./dollar-sign-DePuN86F.js";import{F as D}from"./file-text-yG9jYhSI.js";import{W as te}from"./wallet-D5478MVw.js";import{C as re}from"./credit-card--OOGtDUL.js";import{T as j}from"./triangle-alert-B_IWcPwx.js";import{S as ae}from"./save-CVL2Myj-.js";const se=[["rect",{width:"14",height:"20",x:"5",y:"2",rx:"2",ry:"2",key:"1yt0o3"}],["path",{d:"M12 18h.01",key:"mhygvu"}]],ie=J("smartphone",se),oe=["administrador","gerente","admin","supervisor"];function ge(){const[z,H]=s.useState([]),[V,w]=s.useState(!0),[b,_]=s.useState(!1),[n,G]=s.useState(null),[I,N]=s.useState(null),[x,k]=s.useState("GLOBAL"),[c,R]=s.useState(""),[B,L]=s.useState(""),[v,U]=s.useState(""),[$,f]=s.useState(!1),S=()=>{try{const r=localStorage.getItem("user");if(r)return JSON.parse(r)}catch(r){console.error("Error al obtener usuario:",r)}return null},g=()=>{const r=S();if(!r)return!1;const a=(r.rol||r.roles?.nombre||r.cargo||"").toLowerCase();return oe.includes(a)},P=()=>{const r=localStorage.getItem("user");if(r)try{const a=JSON.parse(r);return{id:a.usuario_id||1,username:a.username||"admin"}}catch{return{id:1,username:"admin"}}return{id:1,username:"admin"}};s.useEffect(()=>{const r=S();N(r),F()},[v,x]);const F=async()=>{w(!0);try{const r=S(),u=g()&&x==="GLOBAL",o=new Date().toISOString().split("T")[0],l={p_fecha:v||null,p_id_usuario:null},m={p_fecha:o,p_id_usuario:null};!u&&r?.usuario_id&&(l.p_id_usuario=r.usuario_id,m.p_id_usuario=r.usuario_id);const[h,y]=await Promise.all([C.rpc("fn_leer_cierres_caja_cajero",l),C.rpc("fn_resumen_caja_cajero",m)]);h.error&&console.error("Error cierres:",h.error),y.error&&console.error("Error resumen:",y.error),H(h.data||[]),G(y.data?.[0]||null)}catch(r){console.error("Error:",r),p.error("Error al cargar datos")}finally{w(!1)}},M=async()=>{if(!c){p.error("Ingrese el efectivo fÃ­sico contado");return}_(!0);try{const r=P(),a=parseFloat(c),u=n?.total_recaudado||0,o=a-u,l=new Date,m=l.toTimeString().split(" ")[0],h=l.toISOString().split("T")[0],{data:y,error:W}=await C.rpc("fn_registrar_cierre_caja",{p_id_usuario:r.id,p_fecha:h,p_hora_cierre:m,p_total_efectivo:a,p_diferencia:o,p_observaciones:B.trim()||null});W?p.error(W.message||"Error al crear cierre"):(o!==0?p(`Cierre registrado con diferencia de ${o>=0?"+":""}${o.toFixed(2)} Bs`,{icon:o>=0?"ðŸ“ˆ":"ðŸ“‰",duration:5e3}):p.success("Â¡Cierre de caja perfecto! Sin diferencias"),f(!1),R(""),L(""),F())}catch{p.error("Error al procesar cierre")}finally{_(!1)}},d=r=>`Bs ${parseFloat(r||0).toFixed(2)}`,q=(r,a)=>{if(!r)return"--";const u={day:"2-digit",month:"short",year:"numeric"},o=new Date(r+"T00:00:00").toLocaleDateString("es-BO",u),l=a?.substring(0,5)||"";return l?`${o} - ${l}`:o},T=n?.total_recaudado||0,i=c?parseFloat(c)-T:0;return e.jsxs("div",{style:t.container,children:[e.jsx(Z,{position:"top-right"}),e.jsxs("header",{style:t.header,children:[e.jsxs("div",{children:[e.jsxs("h1",{style:t.title,children:[e.jsx(Q,{size:28,style:{marginRight:"12px"}}),"Cierre de Caja"]}),e.jsxs("p",{style:t.subtitle,children:[g()?"Cuadre de efectivo diario - Todos los cierres":`Mis cierres de caja${I?.nombres?` - ${I.nombres}`:""}`," - ",new Date().toLocaleDateString("es-BO",{weekday:"long",day:"numeric",month:"long",year:"numeric"})]})]}),g()&&e.jsxs("div",{style:t.switchContainer,children:[e.jsxs("button",{style:{...t.switchButton,...x==="GLOBAL"?t.switchActive:t.switchInactive},onClick:()=>k("GLOBAL"),children:[e.jsx(X,{size:16})," SupervisiÃ³n"]}),e.jsxs("button",{style:{...t.switchButton,...x==="PERSONAL"?t.switchActive:t.switchInactive},onClick:()=>k("PERSONAL"),children:[e.jsx(ee,{size:16})," Mi Caja"]})]}),(x==="PERSONAL"||!g())&&e.jsxs("button",{style:t.primaryButton,onClick:()=>f(!0),children:[e.jsx(O,{size:18}),"Nuevo Cierre"]})]}),e.jsxs("div",{style:t.summarySection,children:[e.jsx("h2",{style:t.sectionTitle,children:"ðŸ’° Resumen del DÃ­a"}),e.jsxs("div",{style:t.summaryGrid,children:[e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:t.cardIcon,children:e.jsx(D,{size:24})}),e.jsxs("div",{children:[e.jsx("span",{style:t.cardLabel,children:"Total Ventas"}),e.jsx("span",{style:t.cardValue,children:n?.total_ventas||0})]})]}),e.jsxs("div",{style:{...t.summaryCard,...t.cardHighlight},children:[e.jsx("div",{style:{...t.cardIcon,background:"#e8f5e9"},children:e.jsx(te,{size:24,color:"#1a5d1a"})}),e.jsxs("div",{children:[e.jsx("span",{style:t.cardLabel,children:"Efectivo"}),e.jsx("span",{style:{...t.cardValue,color:"#1a5d1a",fontSize:"22px"},children:d(n?.total_efectivo)})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:{...t.cardIcon,background:"#e3f2fd"},children:e.jsx(re,{size:24,color:"#1565c0"})}),e.jsxs("div",{children:[e.jsxs("span",{style:t.cardLabel,children:["Tarjeta (",n?.cant_tarjeta||0,")"]}),e.jsx("span",{style:t.cardValue,children:d(n?.total_tarjeta)})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:{...t.cardIcon,background:"#fff3e0"},children:e.jsx(ie,{size:24,color:"#e65100"})}),e.jsxs("div",{children:[e.jsxs("span",{style:t.cardLabel,children:["QR (",n?.cant_qr||0,")"]}),e.jsx("span",{style:t.cardValue,children:d(n?.total_qr)})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:{...t.cardIcon,background:"#f3e5f5"},children:e.jsx(O,{size:24,color:"#7b1fa2"})}),e.jsxs("div",{children:[e.jsx("span",{style:t.cardLabel,children:"Total Recaudado"}),e.jsx("span",{style:{...t.cardValue,fontWeight:"700"},children:d(n?.total_recaudado)})]})]})]})]}),e.jsxs("div",{style:t.section,children:[e.jsxs("div",{style:t.sectionHeader,children:[e.jsx("h2",{style:t.sectionTitleAlt,children:"ðŸ“‹ Historial de Cierres"}),e.jsx("input",{type:"date",value:v,onChange:r=>U(r.target.value),style:t.dateInput})]}),V?e.jsx("div",{style:t.loadingState,children:e.jsx(E,{size:40,style:{animation:"spin 1s linear infinite",color:"#1a5d1a"}})}):z.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(D,{size:48,style:{color:"#ccc"}}),e.jsx("p",{children:"No hay cierres de caja registrados"})]}):e.jsx("div",{style:t.tableContainer,children:e.jsxs("table",{style:t.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.th,children:"Fecha y Hora"}),e.jsx("th",{style:t.th,children:"Usuario"}),e.jsx("th",{style:{...t.th,textAlign:"right"},children:"Efectivo"}),e.jsx("th",{style:{...t.th,textAlign:"right"},children:"Diferencia"}),e.jsx("th",{style:{...t.th,textAlign:"center"},children:"Estado"}),e.jsx("th",{style:t.th,children:"Observaciones"})]})}),e.jsx("tbody",{children:z.map((r,a)=>e.jsxs("tr",{style:t.tr,children:[e.jsx("td",{style:t.td,children:e.jsxs("div",{style:t.fechaCell,children:[e.jsx(K,{size:16,style:{color:"#6c757d"}}),e.jsx("span",{style:t.fechaText,children:q(r.fecha,r.hora)})]})}),e.jsx("td",{style:t.td,children:r.usuario||"Usuario"}),e.jsx("td",{style:{...t.td,textAlign:"right",fontWeight:"600"},children:d(r.efectivo)}),e.jsxs("td",{style:{...t.td,textAlign:"right",fontWeight:"600",color:r.diferencia===0?"#2e7d32":r.diferencia>0?"#1565c0":"#c62828"},children:[r.diferencia>=0?"+":"",d(r.diferencia)]}),e.jsx("td",{style:{...t.td,textAlign:"center"},children:r.diferencia===0?e.jsxs("span",{style:t.badgeSuccess,children:[e.jsx(A,{size:14})," Cuadrado"]}):r.diferencia>0?e.jsxs("span",{style:t.badgeInfo,children:[e.jsx(j,{size:14})," Sobrante"]}):e.jsxs("span",{style:t.badgeDanger,children:[e.jsx(j,{size:14})," Faltante"]})}),e.jsx("td",{style:{...t.td,color:"#6c757d",fontSize:"13px"},children:r.observaciones||"-"})]},r.id||a))})]})})]}),$&&e.jsx("div",{style:t.modalOverlay,onClick:()=>f(!1),children:e.jsxs("div",{style:t.modal,onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{style:t.modalHeader,children:[e.jsx("h2",{style:t.modalTitle,children:"Nuevo Cierre de Caja"}),e.jsx("button",{style:t.closeButton,onClick:()=>f(!1),children:e.jsx(Y,{size:20})})]}),e.jsxs("div",{style:t.modalBody,children:[e.jsxs("div",{style:t.sistemaBox,children:[e.jsxs("div",{children:[e.jsx("span",{style:t.sistemaLabel,children:"Total Recaudado segÃºn sistema"}),e.jsx("p",{style:t.sistemaHint,children:"(Efectivo + Tarjeta + QR)"})]}),e.jsx("span",{style:t.sistemaValue,children:d(T)})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Total Declarado (Efectivo y Comprobantes)"}),e.jsx("input",{type:"number",value:c,onChange:r=>R(r.target.value),style:t.montoInput,placeholder:"0.00",step:"0.5",min:"0",autoFocus:!0})]}),c&&e.jsxs("div",{style:{...t.diferenciaBox,background:i===0?"#e8f5e9":i>0?"#e3f2fd":"#ffebee",borderColor:i===0?"#a5d6a7":i>0?"#90caf9":"#ef9a9a"},children:[e.jsx("div",{style:t.diferenciaLabel,children:i===0?e.jsxs(e.Fragment,{children:[e.jsx(A,{size:20,color:"#2e7d32"})," ",e.jsx("span",{style:{color:"#2e7d32"},children:"Â¡Cuadre Perfecto!"})]}):i>0?e.jsxs(e.Fragment,{children:[e.jsx(j,{size:20,color:"#1565c0"})," ",e.jsx("span",{style:{color:"#1565c0"},children:"Hay un sobrante"})]}):e.jsxs(e.Fragment,{children:[e.jsx(j,{size:20,color:"#c62828"})," ",e.jsx("span",{style:{color:"#c62828"},children:"Hay un faltante"})]})}),e.jsxs("span",{style:{...t.diferenciaValue,color:i===0?"#2e7d32":i>0?"#1565c0":"#c62828"},children:[i>=0?"+":"",d(i)]})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Observaciones (opcional)"}),e.jsx("textarea",{value:B,onChange:r=>L(r.target.value),style:t.textarea,placeholder:"Ej: Faltante debido a error en cambio...",rows:2})]})]}),e.jsxs("div",{style:t.modalFooter,children:[e.jsx("button",{style:t.cancelButton,onClick:()=>f(!1),disabled:b,children:"Cancelar"}),e.jsx("button",{style:t.saveButton,onClick:M,disabled:b||!c,children:b?e.jsxs(e.Fragment,{children:[e.jsx(E,{size:16,style:{animation:"spin 1s linear infinite"}})," Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ae,{size:16})," Registrar Cierre"]})})]})]})}),e.jsx("style",{children:"@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }"})]})}const t={container:{padding:"20px",maxWidth:"1200px",margin:"0 auto"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"25px",flexWrap:"wrap",gap:"15px"},title:{margin:0,fontSize:"28px",fontWeight:"700",color:"#1a5d1a",display:"flex",alignItems:"center"},subtitle:{margin:"8px 0 0 0",color:"#6c757d",fontSize:"14px"},primaryButton:{display:"flex",alignItems:"center",gap:"8px",padding:"12px 20px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"600",cursor:"pointer",boxShadow:"0 4px 12px rgba(26,93,26,0.3)"},switchContainer:{display:"flex",background:"#e9ecef",borderRadius:"20px",padding:"4px",gap:"4px",marginLeft:"auto",marginRight:"15px"},switchButton:{padding:"8px 16px",borderRadius:"16px",border:"none",cursor:"pointer",fontSize:"13px",fontWeight:"600",transition:"all 0.2s",display:"flex",alignItems:"center",gap:"6px"},switchActive:{background:"white",color:"#1a5d1a",boxShadow:"0 2px 4px rgba(0,0,0,0.1)"},switchInactive:{background:"transparent",color:"#6c757d"},summarySection:{marginBottom:"25px"},sectionTitle:{margin:"0 0 15px 0",fontSize:"18px",fontWeight:"600",color:"#333"},sectionTitleAlt:{margin:0,fontSize:"18px",fontWeight:"600",color:"#333"},summaryGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:"15px"},summaryCard:{display:"flex",alignItems:"center",gap:"15px",padding:"18px",background:"white",borderRadius:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},cardHighlight:{border:"2px solid #a5d6a7"},cardIcon:{padding:"10px",background:"#f8f9fa",borderRadius:"10px"},cardLabel:{display:"block",fontSize:"13px",color:"#6c757d",marginBottom:"2px"},cardValue:{display:"block",fontSize:"18px",fontWeight:"600",color:"#333"},section:{background:"white",borderRadius:"16px",padding:"25px",boxShadow:"0 2px 12px rgba(0,0,0,0.05)"},sectionHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px",flexWrap:"wrap",gap:"15px"},dateInput:{padding:"8px 12px",border:"1px solid #e9ecef",borderRadius:"8px",fontSize:"14px"},tableContainer:{overflowX:"auto"},table:{width:"100%",borderCollapse:"collapse"},th:{textAlign:"left",padding:"12px 15px",background:"#f8f9fa",borderBottom:"2px solid #e9ecef",fontSize:"13px",fontWeight:"600",color:"#6c757d",textTransform:"uppercase"},tr:{borderBottom:"1px solid #f0f0f0"},td:{padding:"14px 15px",fontSize:"14px",verticalAlign:"middle"},fechaCell:{display:"flex",alignItems:"center",gap:"8px"},fechaText:{fontWeight:"500"},badgeSuccess:{display:"inline-flex",alignItems:"center",gap:"4px",padding:"4px 10px",background:"#e8f5e9",color:"#2e7d32",borderRadius:"20px",fontSize:"12px",fontWeight:"500"},badgeInfo:{display:"inline-flex",alignItems:"center",gap:"4px",padding:"4px 10px",background:"#e3f2fd",color:"#1565c0",borderRadius:"20px",fontSize:"12px",fontWeight:"500"},badgeDanger:{display:"inline-flex",alignItems:"center",gap:"4px",padding:"4px 10px",background:"#ffebee",color:"#c62828",borderRadius:"20px",fontSize:"12px",fontWeight:"500"},loadingState:{display:"flex",justifyContent:"center",padding:"60px"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",padding:"60px",color:"#6c757d",gap:"15px"},modalOverlay:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:"20px"},modal:{background:"white",borderRadius:"16px",width:"100%",maxWidth:"480px"},modalHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"20px 25px",borderBottom:"1px solid #e9ecef",background:"linear-gradient(135deg, #f8f9fa, #e8f5e9)",borderRadius:"16px 16px 0 0"},modalTitle:{margin:0,fontSize:"20px",fontWeight:"600",color:"#1a5d1a"},closeButton:{background:"none",border:"none",cursor:"pointer",color:"#6c757d",padding:"5px"},modalBody:{padding:"25px"},sistemaBox:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"20px",background:"linear-gradient(135deg, #f8f9fa, #e8f5e9)",borderRadius:"12px",marginBottom:"25px",border:"1px solid #e9ecef"},sistemaLabel:{fontSize:"14px",fontWeight:"500",color:"#333"},sistemaHint:{margin:"4px 0 0 0",fontSize:"12px",color:"#6c757d"},sistemaValue:{fontSize:"28px",fontWeight:"700",color:"#1a5d1a"},formGroup:{marginBottom:"20px"},label:{display:"block",marginBottom:"8px",fontSize:"14px",fontWeight:"500",color:"#333"},montoInput:{width:"100%",padding:"16px",fontSize:"24px",textAlign:"center",border:"2px solid #e9ecef",borderRadius:"12px",boxSizing:"border-box",transition:"border-color 0.2s"},diferenciaBox:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"15px 20px",borderRadius:"12px",marginBottom:"20px",border:"2px solid"},diferenciaLabel:{display:"flex",alignItems:"center",gap:"8px",fontWeight:"600"},diferenciaValue:{fontSize:"24px",fontWeight:"700"},textarea:{width:"100%",padding:"12px 15px",border:"2px solid #e9ecef",borderRadius:"10px",fontSize:"14px",resize:"vertical",boxSizing:"border-box",fontFamily:"inherit"},modalFooter:{display:"flex",justifyContent:"flex-end",gap:"12px",padding:"20px 25px",borderTop:"1px solid #e9ecef",background:"#f8f9fa",borderRadius:"0 0 16px 16px"},cancelButton:{padding:"10px 20px",background:"white",border:"1px solid #e9ecef",borderRadius:"8px",fontSize:"14px",cursor:"pointer",color:"#6c757d"},saveButton:{display:"flex",alignItems:"center",gap:"8px",padding:"10px 20px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:"500",cursor:"pointer"}};export{ge as default};
