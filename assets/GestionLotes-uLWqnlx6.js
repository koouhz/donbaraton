import{c as $,r as a,s as p,j as e,b as H,P as E,X as _,i as j,C as v}from"./index-hR7h3xft.js";import{n as r,F as X,L as J}from"./index-BTmhdvE4.js";import{R as K}from"./refresh-cw-SHhOlYLT.js";import{T as D}from"./triangle-alert-B_IWcPwx.js";import{S as Q}from"./search-BOrDwhaZ.js";import{T as I}from"./trash-2-C990xH84.js";import{C as A}from"./clock-B7rEP_ha.js";import{A as U}from"./archive-h_kyx3SE.js";const Y=[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]],Z=$("pen-line",Y);function le(){const[c,B]=a.useState([]),[g,R]=a.useState([]),[O,C]=a.useState(!0),[h,T]=a.useState(""),[i,w]=a.useState(""),[f,z]=a.useState("lotes"),[q,b]=a.useState(null),[y,u]=a.useState("");a.useEffect(()=>{x()},[h]);const x=async()=>{C(!0);try{let o=p.from("lotes").select(`
                    *,
                    productos (nombre, codigo_interno)
                `).order("fecha_vencimiento",{ascending:!0});h&&(o=o.eq("estado",h));const{data:s,error:n}=await o;if(n)throw n;B(s||[]);const{data:m,error:k}=await p.from("movimientos_inventario").select(`
                    id_movimiento,
                    id_producto,
                    tipo,
                    cantidad,
                    lote,
                    fecha_vencimiento,
                    fecha_hora,
                    productos (nombre, codigo_interno)
                `).not("fecha_vencimiento","is",null).order("fecha_vencimiento",{ascending:!0}).limit(100);if(k)throw k;R(m||[])}catch(o){console.error("Error al cargar datos:",o),r.error("Error al cargar datos")}finally{C(!1)}},l=new Date;l.setHours(0,0,0,0);const d={total:c.length,activos:c.filter(o=>o.estado==="ACTIVO").length,vencidos:c.filter(o=>new Date(o.fecha_vencimiento)<l||o.estado==="VENCIDO").length,proximos:c.filter(o=>{const s=new Date(o.fecha_vencimiento),n=new Date;return n.setDate(n.getDate()+7),s>=l&&s<=n&&o.estado==="ACTIVO"}).length,movVencidos:g.filter(o=>new Date(o.fecha_vencimiento)<l).length},S=c.filter(o=>!i||o.productos?.nombre?.toLowerCase().includes(i.toLowerCase())||o.productos?.codigo_interno?.toLowerCase().includes(i.toLowerCase())||o.lote?.toLowerCase().includes(i.toLowerCase())),L=g.filter(o=>!i||o.productos?.nombre?.toLowerCase().includes(i.toLowerCase())||o.lote?.toLowerCase().includes(i.toLowerCase())),W=o=>{const s=new Date(o.fecha_vencimiento);if(s<l||o.estado==="VENCIDO")return{bg:"#ffebee",color:"#c62828",icon:e.jsx(v,{size:14}),texto:"VENCIDO"};const n=new Date;return n.setDate(n.getDate()+7),s<=n?{bg:"#fff8e1",color:"#f57f17",icon:e.jsx(A,{size:14}),texto:"PRÓXIMO"}:o.estado==="AGOTADO"?{bg:"#f5f5f5",color:"#666",icon:e.jsx(U,{size:14}),texto:"AGOTADO"}:{bg:"#e8f5e9",color:"#2e7d32",icon:e.jsx(j,{size:14}),texto:"ACTIVO"}},V=o=>o?new Date(o).toLocaleDateString("es-BO",{day:"2-digit",month:"short",year:"numeric"}):"-",N=o=>{if(!o)return null;const n=new Date(o)-l;return Math.ceil(n/(1e3*60*60*24))},F=async o=>{if(window.confirm("¿Está seguro de eliminar este lote? Esta acción no se puede deshacer."))try{const{error:s}=await p.from("lotes").delete().eq("id_lote",o);if(s)throw s;r.success("Lote eliminado correctamente"),x()}catch(s){console.error("Error al eliminar lote:",s),r.error("Error al eliminar lote")}},M=async(o,s)=>{try{const{error:n}=await p.from("lotes").update({estado:s}).eq("id_lote",o);if(n)throw n;r.success(`Lote marcado como ${s}`),x()}catch(n){console.error("Error al actualizar lote:",n),r.error("Error al actualizar lote")}},G=async o=>{if(!y){r.error("Seleccione una fecha");return}try{const{error:s}=await p.from("lotes").update({fecha_vencimiento:y}).eq("id_lote",o);if(s)throw s;r.success("Fecha de vencimiento actualizada"),b(null),u(""),x()}catch(s){console.error("Error al actualizar fecha:",s),r.error("Error al actualizar fecha")}},P=async o=>{if(window.confirm("¿Eliminar este registro de vencimiento? Esto desbloqueará la venta del producto."))try{const{error:s}=await p.from("movimientos_inventario").update({fecha_vencimiento:null}).eq("id_movimiento",o);if(s)throw s;r.success("Registro de vencimiento eliminado"),x()}catch(s){console.error("Error:",s),r.error("Error al eliminar registro")}};return e.jsxs("div",{style:t.container,children:[e.jsx(X,{position:"top-right"}),e.jsxs("div",{style:t.header,children:[e.jsxs("h2",{style:t.title,children:[e.jsx(H,{size:28,color:"#1a5d1a"}),"Gestión de Lotes y Vencimientos"]}),e.jsxs("button",{style:t.refreshButton,onClick:x,children:[e.jsx(K,{size:18}),"Actualizar"]})]}),e.jsxs("div",{style:t.statsGrid,children:[e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #1a5d1a"},children:[e.jsx("span",{style:t.statValue,children:d.total}),e.jsx("span",{style:t.statLabel,children:"Total Lotes"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #2e7d32"},children:[e.jsx("span",{style:t.statValue,children:d.activos}),e.jsx("span",{style:t.statLabel,children:"Activos"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #f57f17"},children:[e.jsx("span",{style:t.statValue,children:d.proximos}),e.jsx("span",{style:t.statLabel,children:"Próximos a Vencer"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #c62828"},children:[e.jsx("span",{style:t.statValue,children:d.vencidos}),e.jsx("span",{style:t.statLabel,children:"Vencidos"})]}),e.jsxs("div",{style:{...t.statCard,borderLeft:"4px solid #e65100"},children:[e.jsx("span",{style:t.statValue,children:d.movVencidos}),e.jsx("span",{style:t.statLabel,children:"Mov. Bloqueantes"})]})]}),e.jsxs("div",{style:t.tabs,children:[e.jsxs("button",{style:{...t.tab,...f==="lotes"?t.tabActive:{}},onClick:()=>z("lotes"),children:[e.jsx(E,{size:16}),"Lotes (",c.length,")"]}),e.jsxs("button",{style:{...t.tab,...f==="movimientos"?t.tabActive:{}},onClick:()=>z("movimientos"),children:[e.jsx(D,{size:16}),"Movimientos con Vencimiento (",g.length,")",d.movVencidos>0&&e.jsx("span",{style:t.badge,children:d.movVencidos})]})]}),e.jsxs("div",{style:t.filtersSection,children:[e.jsxs("div",{style:t.searchBox,children:[e.jsx(Q,{size:18,color:"#999"}),e.jsx("input",{type:"text",placeholder:"Buscar producto o lote...",value:i,onChange:o=>w(o.target.value),style:t.searchInput}),i&&e.jsx("button",{style:t.clearButton,onClick:()=>w(""),children:e.jsx(_,{size:16})})]}),f==="lotes"&&e.jsxs("select",{style:t.select,value:h,onChange:o=>T(o.target.value),children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"ACTIVO",children:"Activos"}),e.jsx("option",{value:"VENCIDO",children:"Vencidos"}),e.jsx("option",{value:"AGOTADO",children:"Agotados"})]})]}),O?e.jsxs("div",{style:t.loadingState,children:[e.jsx(J,{size:40,style:{animation:"spin 1s linear infinite"}}),e.jsx("span",{children:"Cargando lotes..."})]}):f==="lotes"?S.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(E,{size:60,color:"#ccc"}),e.jsx("h3",{children:"No hay lotes"}),e.jsx("p",{children:"No se encontraron lotes con los filtros seleccionados"})]}):e.jsx("div",{style:t.tableContainer,children:e.jsxs("table",{style:t.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.th,children:"Producto"}),e.jsx("th",{style:t.th,children:"Lote"}),e.jsx("th",{style:t.th,children:"Vencimiento"}),e.jsx("th",{style:t.th,children:"Días"}),e.jsx("th",{style:t.th,children:"Cantidad"}),e.jsx("th",{style:t.th,children:"Estado"}),e.jsx("th",{style:t.th,children:"Acciones"})]})}),e.jsx("tbody",{children:S.map(o=>{const s=W(o),n=N(o.fecha_vencimiento);return e.jsxs("tr",{style:t.tr,children:[e.jsxs("td",{style:t.td,children:[e.jsx("strong",{children:o.productos?.nombre||"N/A"}),e.jsx("br",{}),e.jsx("small",{style:{color:"#6c757d"},children:o.productos?.codigo_interno})]}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:t.loteCode,children:o.lote})}),e.jsx("td",{style:t.td,children:q===o.id_lote?e.jsxs("div",{style:{display:"flex",gap:"5px",alignItems:"center"},children:[e.jsx("input",{type:"date",value:y,onChange:m=>u(m.target.value),style:t.dateInput}),e.jsx("button",{style:t.btnSaveSmall,onClick:()=>G(o.id_lote),children:e.jsx(j,{size:14})}),e.jsx("button",{style:t.btnCancelSmall,onClick:()=>{b(null),u("")},children:e.jsx(_,{size:14})})]}):V(o.fecha_vencimiento)}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:{fontWeight:"700",color:n<0?"#c62828":n<=7?"#f57f17":"#2e7d32"},children:n!==null?n<0?`${Math.abs(n)}d vencido`:`${n}d`:"-"})}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:t.cantidad,children:o.cantidad})}),e.jsx("td",{style:t.td,children:e.jsxs("span",{style:{...t.estadoBadge,background:s.bg,color:s.color},children:[s.icon,s.texto]})}),e.jsx("td",{style:t.td,children:e.jsxs("div",{style:t.actionButtons,children:[e.jsx("button",{style:t.btnEdit,onClick:()=>{b(o.id_lote),u(o.fecha_vencimiento)},title:"Editar fecha",children:e.jsx(Z,{size:14})}),o.estado!=="VENCIDO"&&e.jsx("button",{style:t.btnVencer,onClick:()=>M(o.id_lote,"VENCIDO"),title:"Marcar como vencido",children:e.jsx(v,{size:14})}),e.jsx("button",{style:t.btnDelete,onClick:()=>F(o.id_lote),title:"Eliminar lote",children:e.jsx(I,{size:14})})]})})]},o.id_lote)})})]})}):L.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(j,{size:60,color:"#2e7d32"}),e.jsx("h3",{children:"Sin registros bloqueantes"}),e.jsx("p",{children:"No hay movimientos con fechas de vencimiento que bloqueen ventas"})]}):e.jsxs("div",{style:t.tableContainer,children:[e.jsxs("div",{style:t.infoBox,children:[e.jsx(D,{size:18,color:"#e65100"}),e.jsxs("span",{children:["Estos registros en ",e.jsx("strong",{children:"movimientos_inventario"})," contienen fechas de vencimiento que pueden bloquear ventas. Elimina los registros vencidos para desbloquear los productos."]})]}),e.jsxs("table",{style:t.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.th,children:"Producto"}),e.jsx("th",{style:t.th,children:"Tipo"}),e.jsx("th",{style:t.th,children:"Lote"}),e.jsx("th",{style:t.th,children:"Vencimiento"}),e.jsx("th",{style:t.th,children:"Estado"}),e.jsx("th",{style:t.th,children:"Cantidad"}),e.jsx("th",{style:t.th,children:"Acción"})]})}),e.jsx("tbody",{children:L.map(o=>{const n=new Date(o.fecha_vencimiento)<l;return e.jsxs("tr",{style:{...t.tr,background:n?"#fff8f8":"transparent"},children:[e.jsxs("td",{style:t.td,children:[e.jsx("strong",{children:o.productos?.nombre||"N/A"}),e.jsx("br",{}),e.jsx("small",{style:{color:"#6c757d"},children:o.productos?.codigo_interno})]}),e.jsx("td",{style:t.td,children:o.tipo}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:t.loteCode,children:o.lote||"-"})}),e.jsx("td",{style:t.td,children:V(o.fecha_vencimiento)}),e.jsx("td",{style:t.td,children:e.jsxs("span",{style:{...t.estadoBadge,background:n?"#ffebee":"#fff8e1",color:n?"#c62828":"#f57f17"},children:[n?e.jsx(v,{size:14}):e.jsx(A,{size:14}),n?"VENCIDO":"ACTIVO"]})}),e.jsx("td",{style:t.td,children:o.cantidad}),e.jsx("td",{style:t.td,children:e.jsxs("button",{style:t.btnDeleteRed,onClick:()=>P(o.id_movimiento),title:"Eliminar registro de vencimiento",children:[e.jsx(I,{size:14}),"Eliminar"]})})]},o.id_movimiento)})})]})]}),e.jsx("style",{children:`
                @keyframes spin {
                    from { transform: rotate(0deg); }
                    to { transform: rotate(360deg); }
                }
            `})]})}const t={container:{padding:"20px",maxWidth:"1400px",margin:"0 auto"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px",flexWrap:"wrap",gap:"15px"},title:{display:"flex",alignItems:"center",gap:"12px",fontSize:"24px",fontWeight:"700",color:"#333",margin:0},refreshButton:{display:"flex",alignItems:"center",gap:"8px",padding:"10px 16px",background:"#f5f5f5",color:"#333",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"500",cursor:"pointer"},statsGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(140px, 1fr))",gap:"15px",marginBottom:"20px"},statCard:{background:"white",borderRadius:"12px",padding:"18px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},statValue:{fontSize:"28px",fontWeight:"700",color:"#333",display:"block"},statLabel:{fontSize:"12px",color:"#6c757d",marginTop:"5px",display:"block"},tabs:{display:"flex",gap:"10px",marginBottom:"20px",flexWrap:"wrap"},tab:{display:"flex",alignItems:"center",gap:"8px",padding:"12px 20px",background:"#f5f5f5",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"500",cursor:"pointer",color:"#666"},tabActive:{background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white"},badge:{background:"#c62828",color:"white",padding:"2px 8px",borderRadius:"10px",fontSize:"11px",fontWeight:"700",marginLeft:"5px"},filtersSection:{display:"flex",gap:"12px",marginBottom:"20px",flexWrap:"wrap"},searchBox:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 15px",background:"white",borderRadius:"10px",border:"1px solid #e9ecef",flex:"1",minWidth:"250px"},searchInput:{border:"none",outline:"none",fontSize:"14px",flex:1},clearButton:{background:"none",border:"none",cursor:"pointer",color:"#999",padding:"2px"},select:{padding:"10px 15px",border:"1px solid #e9ecef",borderRadius:"10px",fontSize:"14px",background:"white",minWidth:"160px"},tableContainer:{background:"white",borderRadius:"12px",overflow:"hidden",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},table:{width:"100%",borderCollapse:"collapse"},th:{padding:"14px 16px",textAlign:"left",background:"#f8f9fa",color:"#495057",fontWeight:"600",fontSize:"13px",borderBottom:"2px solid #e9ecef"},tr:{borderBottom:"1px solid #f0f0f0",transition:"background 0.2s"},td:{padding:"14px 16px",fontSize:"14px",color:"#333"},loteCode:{fontFamily:"monospace",background:"#f5f5f5",padding:"3px 8px",borderRadius:"4px",fontSize:"12px"},cantidad:{fontWeight:"700",fontSize:"16px",color:"#1a5d1a"},estadoBadge:{display:"inline-flex",alignItems:"center",gap:"5px",padding:"5px 10px",borderRadius:"6px",fontSize:"12px",fontWeight:"600"},dateInput:{padding:"6px 10px",border:"1px solid #ddd",borderRadius:"6px",fontSize:"13px"},actionButtons:{display:"flex",gap:"6px"},btnEdit:{display:"flex",alignItems:"center",justifyContent:"center",width:"30px",height:"30px",background:"#e3f2fd",color:"#1565c0",border:"none",borderRadius:"6px",cursor:"pointer"},btnVencer:{display:"flex",alignItems:"center",justifyContent:"center",width:"30px",height:"30px",background:"#fff8e1",color:"#f57f17",border:"none",borderRadius:"6px",cursor:"pointer"},btnDelete:{display:"flex",alignItems:"center",justifyContent:"center",width:"30px",height:"30px",background:"#ffebee",color:"#c62828",border:"none",borderRadius:"6px",cursor:"pointer"},btnDeleteRed:{display:"flex",alignItems:"center",gap:"5px",padding:"6px 12px",background:"#ffebee",color:"#c62828",border:"1px solid #ffcdd2",borderRadius:"6px",cursor:"pointer",fontSize:"12px",fontWeight:"500"},btnSaveSmall:{display:"flex",alignItems:"center",justifyContent:"center",width:"26px",height:"26px",background:"#e8f5e9",color:"#2e7d32",border:"none",borderRadius:"4px",cursor:"pointer"},btnCancelSmall:{display:"flex",alignItems:"center",justifyContent:"center",width:"26px",height:"26px",background:"#ffebee",color:"#c62828",border:"none",borderRadius:"4px",cursor:"pointer"},infoBox:{display:"flex",alignItems:"center",gap:"12px",padding:"15px 20px",background:"#fff8e1",borderBottom:"1px solid #ffe082",fontSize:"13px",color:"#5d4037"},loadingState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",color:"#6c757d",gap:"15px"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",background:"white",borderRadius:"12px",color:"#6c757d",textAlign:"center"}};export{le as default};
