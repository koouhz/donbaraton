import{c as Q,r as s,s as S,j as e,P as v,X as O,i as F,k as Z,b as ee}from"./index-hR7h3xft.js";import{n as a,F as oe,L as te}from"./index-BTmhdvE4.js";import{S as U}from"./scan-B9_8egjJ.js";import{F as re}from"./file-text-yG9jYhSI.js";import{T as ne}from"./trash-2-C990xH84.js";import{T as se}from"./triangle-alert-B_IWcPwx.js";import{M as ie}from"./minus-B_PItDwv.js";import{P as ae}from"./plus-5-QD-99n.js";import{C as le,a as ce}from"./circle-arrow-up-CYSuU9gB.js";const de=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],pe=Q("hash",de);function ve(){const[H,W]=s.useState([]),[ue,k]=s.useState(!0),[m,C]=s.useState(!1),[x,g]=s.useState(""),[n,A]=s.useState(null),[p,I]=s.useState(null),[u,T]=s.useState("AJUSTE+"),[l,z]=s.useState(""),[E,h]=s.useState(""),[_,w]=s.useState(""),[D,y]=s.useState(""),[b,R]=s.useState(""),[B,P]=s.useState(""),f=s.useRef(null),$=()=>{const t=localStorage.getItem("user");if(t)try{const r=JSON.parse(t);return{id:r.usuario_id||1,username:r.username||"admin"}}catch{return{id:1,username:"admin"}}return{id:1,username:"admin"}};s.useEffect(()=>{L(),setTimeout(()=>f.current?.focus(),100)},[]),s.useEffect(()=>{if(p){const t=setTimeout(()=>I(null),3e3);return()=>clearTimeout(t)}},[p]);const L=async()=>{k(!0);try{const{data:t,error:r}=await S.rpc("fn_listar_productos",{p_buscar:null});if(r)throw r;W(t||[])}catch(t){console.error("Error:",t),a.error("Error al cargar productos")}finally{k(!1)}},G=async()=>{try{const{data:t,error:r}=await S.rpc("fn_obtener_ultimo_lote");if(r)throw r;return t||"LOT-001"}catch(t){return console.error("Error generando lote:",t),`LOT-${new Date().getTime().toString().slice(-6)}`}},J=()=>{const t=new Date,r=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),d=String(t.getDate()).padStart(2,"0"),X=t.getTime().toString().slice(-4);return`DOC-${r}${i}${d}-${X}`},N=t=>t.trim()?H.find(i=>i.codigo_barras===t.trim()||i.codigo_interno?.toLowerCase()===t.trim().toLowerCase()):null,V=async t=>{if(t.key==="Enter"){t.preventDefault();const r=N(x);if(r){A(r),I(r);const i=await G(),d=J();h(i),y(d),a.success(`Producto seleccionado: ${r.nombre}`)}else a.error(`Producto no encontrado: ${x}`);g(""),f.current?.focus()}},j=()=>{A(null),z(""),h(""),w(""),y(""),R(""),P(""),g(""),T("AJUSTE+"),f.current?.focus()},q=()=>n?!l||parseInt(l)<=0?(a.error("Ingrese una cantidad v谩lida"),!1):b.trim()?["SALIDA","AJUSTE-","MERMA","DAO","DEVOLUCION_PROVEEDOR"].includes(u)&&parseInt(l)>n.stock_actual?(a.error(`Stock insuficiente. Disponible: ${n.stock_actual}`),!1):!0:(a.error("El motivo es obligatorio"),!1):(a.error("Debe seleccionar un producto"),!1),Y=async()=>{if(q()){C(!0);try{const t=$(),{data:r,error:i}=await S.rpc("fn_ajustar_inventario",{p_id_producto:n.id_producto,p_tipo:u,p_cantidad:parseInt(l),p_username:t.username,p_lote:E.trim()||null,p_fecha_vencimiento:_||null,p_documento:D.trim()||null,p_motivo:b.trim(),p_observaciones:B.trim()||null});if(i)console.error("Error al ajustar inventario:",i),a.error(i.message||"Error al registrar ajuste");else{a.success("隆Ajuste registrado exitosamente!");const d=["ENTRADA","AJUSTE+","DEVOLUCION_VENTA"].includes(u);a.success(`${d?"+":"-"}${l} unidades ${n.nombre}`,{duration:4e3,icon:d?"":""}),j(),L()}}catch(t){console.error("Error:",t),a.error("Error al procesar el ajuste")}finally{C(!1)}}},K=t=>`Bs ${parseFloat(t||0).toFixed(2)}`,M=t=>{const r={ENTRADA:{icon:e.jsx(ce,{size:20}),color:"#2e7d32",bg:"#e8f5e9",label:"Entrada Manual",simbolo:"+"},SALIDA:{icon:e.jsx(le,{size:20}),color:"#d32f2f",bg:"#ffebee",label:"Salida Manual",simbolo:"-"},"AJUSTE+":{icon:e.jsx(ae,{size:20}),color:"#1565c0",bg:"#e3f2fd",label:"Ajuste Positivo",simbolo:"+"},"AJUSTE-":{icon:e.jsx(ie,{size:20}),color:"#e65100",bg:"#fff3e0",label:"Ajuste Negativo",simbolo:"-"},MERMA:{icon:e.jsx(se,{size:20}),color:"#c62828",bg:"#ffebee",label:"Merma",simbolo:"-"},DAO:{icon:e.jsx(ne,{size:20}),color:"#c62828",bg:"#ffebee",label:"Producto Da帽ado",simbolo:"-"}};return r[t]||r["AJUSTE+"]},c=M(u);return e.jsxs("div",{style:o.container,children:[e.jsx(oe,{position:"top-center"}),e.jsx("header",{style:o.header,children:e.jsxs("div",{children:[e.jsxs("h1",{style:o.title,children:[e.jsx(v,{size:28,style:{marginRight:"12px"}}),"Ajustes de Inventario"]}),e.jsx("p",{style:o.subtitle,children:"Registrar ingresos, egresos y ajustes de stock"})]})}),e.jsxs("div",{style:o.layout,children:[e.jsxs("div",{style:o.leftPanel,children:[e.jsxs("div",{style:o.scannerSection,children:[e.jsxs("h2",{style:o.panelTitle,children:[e.jsx(U,{size:24}),"Escanear Producto"]}),e.jsxs("div",{style:o.scannerBox,children:[e.jsx("div",{style:o.scannerIcon,children:e.jsx(U,{size:32})}),e.jsx("input",{ref:f,type:"text",placeholder:"Escanee o ingrese el c贸digo de barras...",value:x,onChange:t=>g(t.target.value),onKeyDown:V,style:o.scannerInput,autoFocus:!0}),x&&e.jsx("button",{onClick:()=>g(""),style:o.clearButton,children:e.jsx(O,{size:18})})]}),e.jsxs("p",{style:o.scannerHint,children:["Escanee el c贸digo de barras o escriba el c贸digo y presione ",e.jsx("strong",{children:"Enter"})]}),p&&e.jsxs("div",{style:o.feedbackCard,children:[e.jsx(F,{size:20,style:{color:"#2e7d32"}}),e.jsxs("div",{children:[e.jsx("strong",{children:p.nombre}),e.jsxs("span",{style:o.feedbackStock,children:["Stock actual: ",p.stock_actual]})]})]})]}),n&&e.jsxs("div",{style:o.productoCard,children:[e.jsxs("div",{style:o.productoHeader,children:[e.jsx(v,{size:20,style:{color:"#1a5d1a"}}),e.jsx("h3",{style:o.productoTitulo,children:"Producto Seleccionado"})]}),e.jsxs("div",{style:o.productoInfo,children:[e.jsx("strong",{children:n.nombre}),e.jsxs("div",{style:o.productoMeta,children:[e.jsxs("span",{children:["C贸digo: ",n.codigo_interno]}),e.jsxs("span",{children:["Stock: ",e.jsx("strong",{children:n.stock_actual})]}),e.jsxs("span",{children:["Precio: ",K(n.precio_venta)]})]})]}),e.jsx("button",{style:o.changeProductBtn,onClick:j,children:"Cambiar Producto"})]}),e.jsxs("div",{style:o.instructionsCard,children:[e.jsx("h4",{style:o.instructionsTitle,children:" Instrucciones"}),e.jsxs("ol",{style:o.instructionsList,children:[e.jsx("li",{children:"Escanee el c贸digo de barras del producto"}),e.jsx("li",{children:"Seleccione el tipo de movimiento"}),e.jsx("li",{children:"Ingrese cantidad, lote y motivo"}),e.jsx("li",{children:"Confirme el ajuste"})]})]})]}),e.jsxs("div",{style:o.rightPanel,children:[e.jsx("div",{style:o.formHeader,children:e.jsxs("h2",{style:o.panelTitle,children:[e.jsx(Z,{size:20}),"Registro de Ajuste"]})}),e.jsx("div",{style:o.formBody,children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:o.formSection,children:[e.jsx("label",{style:o.label,children:"Tipo de Movimiento *"}),e.jsx("div",{style:o.tipoGrid,children:["ENTRADA","SALIDA","AJUSTE+","AJUSTE-","MERMA","DAO"].map(t=>{const r=M(t);return e.jsxs("button",{style:{...o.tipoBtn,...u===t?{background:r.bg,borderColor:r.color,color:r.color}:{}},onClick:()=>T(t),children:[r.icon,r.label]},t)})})]}),e.jsxs("div",{style:{...o.tipoIndicator,background:c.bg,borderColor:c.color},children:[c.icon,e.jsxs("span",{style:{color:c.color,fontWeight:"600"},children:[c.label," (",c.simbolo,")"]})]}),e.jsxs("div",{style:o.formGroup,children:[e.jsx("label",{style:o.label,children:"Cantidad *"}),e.jsxs("div",{style:o.cantidadInput,children:[e.jsx(pe,{size:18,style:{color:"#6c757d"}}),e.jsx("input",{type:"number",min:"1",value:l,onChange:t=>z(t.target.value),placeholder:"Ej: 50",style:o.input}),e.jsx("span",{style:o.inputHint,children:"unidades"})]}),n&&e.jsxs("span",{style:o.stockInfo,children:["Stock actual: ",e.jsx("strong",{children:n.stock_actual})]})]}),e.jsxs("div",{style:o.formGroup,children:[e.jsx("label",{style:o.label,children:"Lote"}),e.jsx("input",{type:"text",value:E,onChange:t=>h(t.target.value),placeholder:"Autogenerado",style:o.input,readOnly:!0}),e.jsx("span",{style:o.fieldHint,children:"Se genera autom谩ticamente"})]}),e.jsxs("div",{style:o.formGroup,children:[e.jsxs("label",{style:o.label,children:["Fecha de Vencimiento",n?.controla_vencimiento&&e.jsx("span",{style:{color:"#c62828",marginLeft:"4px"},children:"*"})]}),e.jsxs("div",{style:o.dateInput,children:[e.jsx(ee,{size:18,style:{color:"#6c757d"}}),e.jsx("input",{type:"date",value:_,onChange:t=>w(t.target.value),style:o.input,min:new Date().toISOString().split("T")[0],required:n?.controla_vencimiento})]}),n?.controla_vencimiento&&e.jsx("span",{style:{fontSize:"11px",color:"#c62828",marginTop:"4px",display:"block"},children:"锔 Producto perecedero - fecha obligatoria"})]}),e.jsxs("div",{style:o.formGroup,children:[e.jsx("label",{style:o.label,children:"N潞 Documento / Remito"}),e.jsxs("div",{style:o.docInput,children:[e.jsx(re,{size:18,style:{color:"#6c757d"}}),e.jsx("input",{type:"text",value:D,onChange:t=>y(t.target.value),placeholder:"Autogenerado",style:o.input,readOnly:!0})]}),e.jsx("span",{style:o.fieldHint,children:"Se genera autom谩ticamente"})]}),e.jsxs("div",{style:o.formGroup,children:[e.jsx("label",{style:o.label,children:"Motivo *"}),e.jsx("input",{type:"text",value:b,onChange:t=>R(t.target.value),placeholder:"Ej: Conteo f铆sico, Correcci贸n de inventario",style:o.input,required:!0})]}),e.jsxs("div",{style:o.formGroup,children:[e.jsx("label",{style:o.label,children:"Observaciones (Opcional)"}),e.jsx("textarea",{value:B,onChange:t=>P(t.target.value),placeholder:"Informaci贸n adicional sobre el ajuste",style:o.textarea,rows:3})]}),e.jsxs("div",{style:o.formActions,children:[e.jsxs("button",{style:o.cancelBtn,onClick:j,disabled:m,children:[e.jsx(O,{size:18}),"Cancelar"]}),e.jsx("button",{style:o.submitBtn,onClick:Y,disabled:m,children:m?e.jsxs(e.Fragment,{children:[e.jsx(te,{size:18,style:{animation:"spin 1s linear infinite"}}),"Procesando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(F,{size:18}),"Confirmar Ajuste"]})})]})]}):e.jsxs("div",{style:o.emptyState,children:[e.jsx(v,{size:48,style:{color:"#ccc"}}),e.jsx("p",{children:"Escanee un producto para comenzar"}),e.jsx("span",{children:"Use el esc谩ner de c贸digo de barras"})]})})]})]}),e.jsx("style",{children:`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `})]})}const o={container:{padding:"20px",maxWidth:"1400px",margin:"0 auto"},header:{marginBottom:"20px"},title:{margin:0,fontSize:"28px",fontWeight:"700",color:"#1a5d1a",display:"flex",alignItems:"center"},subtitle:{margin:"8px 0 0 0",color:"#6c757d",fontSize:"14px"},layout:{display:"grid",gridTemplateColumns:"400px 1fr",gap:"20px"},leftPanel:{display:"flex",flexDirection:"column",gap:"20px"},scannerSection:{background:"white",borderRadius:"12px",padding:"20px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},panelTitle:{display:"flex",alignItems:"center",gap:"10px",margin:"0 0 15px 0",fontSize:"16px",fontWeight:"600",color:"#1a5d1a"},scannerBox:{position:"relative",display:"flex",alignItems:"center",gap:"10px",padding:"15px",background:"linear-gradient(135deg, #f8f9fa, #e8f5e9)",border:"2px solid #1a5d1a",borderRadius:"12px",marginBottom:"10px"},scannerIcon:{color:"#1a5d1a"},scannerInput:{flex:1,border:"none",outline:"none",fontSize:"15px",fontWeight:"500",background:"transparent",color:"#1a5d1a"},clearButton:{background:"none",border:"none",cursor:"pointer",color:"#6c757d",padding:"4px",display:"flex",alignItems:"center"},scannerHint:{fontSize:"13px",color:"#6c757d",margin:0},feedbackCard:{display:"flex",alignItems:"center",gap:"12px",padding:"15px",background:"#e8f5e9",borderRadius:"10px",marginTop:"15px",border:"1px solid #c8e6c9"},feedbackStock:{display:"block",fontSize:"12px",color:"#6c757d",marginTop:"4px"},productoCard:{background:"white",borderRadius:"12px",padding:"20px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)",border:"2px solid #1a5d1a"},productoHeader:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"12px"},productoTitulo:{margin:0,fontSize:"14px",fontWeight:"600",color:"#1a5d1a"},productoInfo:{marginBottom:"15px"},productoMeta:{display:"flex",flexDirection:"column",gap:"4px",fontSize:"13px",color:"#6c757d",marginTop:"8px"},changeProductBtn:{width:"100%",padding:"10px",background:"#fff3e0",color:"#e65100",border:"1px solid #ffcc80",borderRadius:"8px",fontSize:"14px",fontWeight:"500",cursor:"pointer"},instructionsCard:{background:"linear-gradient(135deg, #e3f2fd, #e8f5e9)",borderRadius:"12px",padding:"20px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},instructionsTitle:{margin:"0 0 12px 0",fontSize:"14px",fontWeight:"600",color:"#1a5d1a"},instructionsList:{margin:0,paddingLeft:"20px",color:"#495057",fontSize:"13px",lineHeight:"1.8"},rightPanel:{background:"white",borderRadius:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)",overflow:"hidden"},formHeader:{padding:"20px",borderBottom:"2px solid #e9ecef",background:"linear-gradient(135deg, #f8f9fa, #e8f5e9)"},formBody:{padding:"25px",maxHeight:"calc(100vh - 250px)",overflowY:"auto"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",color:"#6c757d",gap:"15px",textAlign:"center"},formSection:{marginBottom:"25px"},label:{display:"block",fontSize:"14px",fontWeight:"600",color:"#333",marginBottom:"8px"},tipoGrid:{display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"10px"},tipoBtn:{display:"flex",alignItems:"center",gap:"8px",padding:"12px 16px",background:"white",border:"2px solid #e9ecef",borderRadius:"10px",fontSize:"13px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s",color:"#495057"},tipoIndicator:{display:"flex",alignItems:"center",gap:"10px",padding:"12px 16px",borderRadius:"10px",marginBottom:"20px",border:"2px solid"},formGroup:{marginBottom:"20px"},input:{flex:1,padding:"12px 15px",border:"1px solid #e9ecef",borderRadius:"8px",fontSize:"14px",outline:"none",width:"100%"},textarea:{width:"100%",padding:"12px 15px",border:"1px solid #e9ecef",borderRadius:"8px",fontSize:"14px",outline:"none",resize:"vertical"},cantidadInput:{display:"flex",alignItems:"center",gap:"10px",padding:" 12px 15px",border:"1px solid #e9ecef",borderRadius:"8px",background:"white"},inputHint:{fontSize:"13px",color:"#6c757d",fontWeight:"500"},stockInfo:{display:"block",fontSize:"12px",color:"#6c757d",marginTop:"6px"},fieldHint:{display:"block",fontSize:"11px",color:"#28a745",marginTop:"4px",fontStyle:"italic"},dateInput:{display:"flex",alignItems:"center",gap:"10px",padding:"12px 15px",border:"1px solid #e9ecef",borderRadius:"8px"},docInput:{display:"flex",alignItems:"center",gap:"10px",padding:"12px 15px",border:"1px solid #e9ecef",borderRadius:"8px"},formActions:{display:"flex",gap:"12px",marginTop:"30px"},cancelBtn:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",padding:"14px",background:"#f8f9fa",color:"#6c757d",border:"1px solid #e9ecef",borderRadius:"10px",fontSize:"15px",fontWeight:"600",cursor:"pointer"},submitBtn:{flex:2,display:"flex",alignItems:"center",justifyContent:"center",gap:"8px",padding:"14px",background:"#1a5d1a",color:"white",border:"none",borderRadius:"10px",fontSize:"15px",fontWeight:"600",cursor:"pointer"}};export{ve as default};
