import{u as M,r as a,s as z,j as e,S as u,E as N,n as w,X as Z,b as $,P as J}from"./index-hR7h3xft.js";import{n as k,F as q,L as R}from"./index-BTmhdvE4.js";import{W as X}from"./wallet-D5478MVw.js";import{D as I}from"./dollar-sign-DePuN86F.js";import{T as Y}from"./trending-up-BgkhDZTu.js";import{C as D}from"./clock-B7rEP_ha.js";import{U as _}from"./user-vBIlvuDL.js";const K=["administrador","gerente","admin"];function le(){const d=M(),[r,B]=a.useState([]),[V,y]=a.useState(!0),[m,W]=a.useState(0),[L,c]=a.useState(!1),[n,E]=a.useState(null),[j,A]=a.useState([]),[O,b]=a.useState(!1),[v,P]=a.useState(null),p=new Date().toISOString().split("T")[0],x=()=>{try{const s=localStorage.getItem("user");if(s)return JSON.parse(s)}catch(s){console.error("Error al obtener usuario:",s)}return null},g=()=>{const s=x();if(!s)return!1;const o=(s.rol||s.roles?.nombre||s.cargo||"").toLowerCase();return K.includes(o)};a.useEffect(()=>{const s=x();P(s),U()},[]);const U=async()=>{y(!0);try{const s=x(),o=g();console.log("=== DEBUG CAJA ==="),console.log("Usuario completo:",s),console.log("Rol detectado:",s?.rol||s?.roles?.nombre||s?.cargo),console.log("¿Puede ver todo?:",o),console.log("Usuario ID:",s?.usuario_id);const i={p_fecha_inicio:p,p_fecha_fin:p,p_id_usuario:null};console.log("Fecha enviada (hoy):",p),!o&&s?.usuario_id?(i.p_id_usuario=s.usuario_id,console.log("Filtrando ventas por usuario:",s.usuario_id)):console.log("Mostrando TODAS las ventas (rol admin/gerente)");const{data:C,error:f}=await z.rpc("fn_leer_ventas_cajero",i);if(f)throw console.error("Error RPC fn_leer_ventas_cajero:",f),f;console.log("Ventas recibidas:",C?.length||0);const T=(C||[]).filter(h=>h.estado);B(T),W(T.reduce((h,G)=>h+parseFloat(G.total||0),0))}catch(s){console.error("Error:",s),k.error("Error al cargar ventas")}finally{y(!1)}},l=s=>`Bs ${parseFloat(s||0).toFixed(2)}`,S=s=>{if(!s)return"--:--";const o=s.toString().includes("Z")?s:s+"Z";return new Date(o).toLocaleTimeString("es-BO",{hour:"2-digit",minute:"2-digit",hour12:!0})},F=s=>{if(!s)return"--/--/----";const o=s.toString().includes("Z")?s:s+"Z";return new Date(o).toLocaleDateString("es-BO",{day:"2-digit",month:"2-digit",year:"numeric"})},H=async s=>{E(s),c(!0),b(!0);try{const{data:o,error:i}=await z.from("detalle_ventas").select(`
          *,
          productos (nombre, codigo_interno, marca)
        `).eq("id_venta",s.id);i||A(o||[])}catch(o){console.error("Error:",o),k.error("Error al cargar detalles")}finally{b(!1)}};return e.jsxs("div",{style:t.container,children:[e.jsx(q,{position:"top-right"}),e.jsxs("header",{style:t.header,children:[e.jsxs("div",{children:[e.jsxs("h1",{style:t.title,children:[e.jsx(X,{size:28,style:{marginRight:"12px"}}),"Caja"]}),e.jsx("p",{style:t.subtitle,children:g()?"Resumen de todas las operaciones del día":`Mis ventas del día${v?.nombres?` - ${v.nombres}`:""}`})]}),e.jsxs("div",{style:t.headerActions,children:[e.jsxs("button",{style:t.primaryButton,onClick:()=>d("/ventas"),children:[e.jsx(u,{size:18}),"Nueva Venta"]}),e.jsxs("button",{style:t.secondaryButton,onClick:()=>d("/cierre-caja"),children:[e.jsx(I,{size:18}),"Cierre de Caja"]})]})]}),e.jsxs("div",{style:t.statsGrid,children:[e.jsxs("div",{style:{...t.statCard,borderTop:"4px solid #1a5d1a"},children:[e.jsx(u,{size:32,style:{color:"#1a5d1a"}}),e.jsxs("div",{children:[e.jsx("span",{style:t.statValue,children:r.length}),e.jsx("span",{style:t.statLabel,children:"Ventas Hoy"})]})]}),e.jsxs("div",{style:{...t.statCard,borderTop:"4px solid #2e7d32"},children:[e.jsx(I,{size:32,style:{color:"#2e7d32"}}),e.jsxs("div",{children:[e.jsx("span",{style:{...t.statValue,color:"#2e7d32"},children:l(m)}),e.jsx("span",{style:t.statLabel,children:"Total Recaudado"})]})]}),e.jsxs("div",{style:{...t.statCard,borderTop:"4px solid #1565c0"},children:[e.jsx(Y,{size:32,style:{color:"#1565c0"}}),e.jsxs("div",{children:[e.jsx("span",{style:{...t.statValue,color:"#1565c0"},children:l(r.length>0?m/r.length:0)}),e.jsx("span",{style:t.statLabel,children:"Promedio por Venta"})]})]})]}),e.jsxs("div",{style:t.section,children:[e.jsxs("h2",{style:t.sectionTitle,children:[e.jsx(D,{size:20}),"Ventas de Hoy"]}),V?e.jsx("div",{style:t.loadingState,children:e.jsx(R,{size:40,style:{animation:"spin 1s linear infinite",color:"#1a5d1a"}})}):r.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(u,{size:48,style:{color:"#ccc"}}),e.jsx("p",{children:"No hay ventas registradas hoy"}),e.jsx("button",{style:t.primaryButton,onClick:()=>d("/ventas"),children:"Iniciar Primera Venta"})]}):e.jsx("div",{style:t.ventasList,children:r.map((s,o)=>e.jsxs("div",{style:t.ventaCard,children:[e.jsxs("div",{style:t.ventaTime,children:[e.jsx(D,{size:16}),S(s.fecha)]}),e.jsx("div",{style:t.ventaCliente,children:s.cliente||"Cliente General"}),g()&&e.jsxs("div",{style:t.ventaCajero,children:[e.jsx(_,{size:14,style:{marginRight:"4px"}}),s.cajero||"Sin asignar"]}),e.jsx("div",{style:t.ventaComprobante,children:s.comprobante}),e.jsx("div",{style:t.ventaTotal,children:l(s.total)}),e.jsxs("button",{style:t.detalleButton,onClick:()=>H(s),children:[e.jsx(N,{size:16}),"Detalles"]})]},s.id||o))})]}),L&&n&&e.jsx("div",{style:t.modalOverlay,onClick:()=>c(!1),children:e.jsxs("div",{style:t.modal,onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{style:t.modalHeader,children:[e.jsxs("h3",{style:t.modalTitle,children:[e.jsx(w,{size:20}),"Detalle de Venta"]}),e.jsx("button",{style:t.closeButton,onClick:()=>c(!1),children:e.jsx(Z,{size:20})})]}),e.jsxs("div",{style:t.modalBody,children:[e.jsxs("div",{style:t.ventaInfo,children:[e.jsxs("div",{style:t.infoRow,children:[e.jsxs("span",{style:t.infoLabel,children:[e.jsx(w,{size:14})," Ticket:"]}),e.jsx("span",{style:t.infoValue,children:n.id})]}),e.jsxs("div",{style:t.infoRow,children:[e.jsxs("span",{style:t.infoLabel,children:[e.jsx($,{size:14})," Fecha:"]}),e.jsxs("span",{style:t.infoValue,children:[F(n.fecha)," - ",S(n.fecha)]})]}),e.jsxs("div",{style:t.infoRow,children:[e.jsxs("span",{style:t.infoLabel,children:[e.jsx(_,{size:14})," Cliente:"]}),e.jsx("span",{style:t.infoValue,children:n.cliente||"Cliente General"})]}),e.jsxs("div",{style:t.infoRow,children:[e.jsx("span",{style:t.infoLabel,children:"Comprobante:"}),e.jsx("span",{style:t.infoValue,children:n.comprobante})]})]}),e.jsxs("h4",{style:t.productosTitle,children:[e.jsx(J,{size:16}),"Productos (",j.length,")"]}),O?e.jsx("div",{style:{textAlign:"center",padding:"30px"},children:e.jsx(R,{size:32,style:{animation:"spin 1s linear infinite",color:"#1a5d1a"}})}):e.jsxs("table",{style:t.detalleTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.detalleTh,children:"Producto"}),e.jsx("th",{style:t.detalleTh,children:"Cant."}),e.jsx("th",{style:t.detalleTh,children:"P. Unit."}),e.jsx("th",{style:t.detalleTh,children:"Subtotal"})]})}),e.jsx("tbody",{children:j.map((s,o)=>e.jsxs("tr",{children:[e.jsxs("td",{style:t.detalleTd,children:[e.jsx("strong",{children:s.productos?.nombre||"Producto"}),e.jsx("span",{style:{display:"block",fontSize:"11px",color:"#6c757d"},children:s.productos?.codigo_interno})]}),e.jsx("td",{style:{...t.detalleTd,textAlign:"center"},children:s.cantidad}),e.jsx("td",{style:t.detalleTd,children:l(s.precio_unitario)}),e.jsx("td",{style:{...t.detalleTd,fontWeight:"600"},children:l(s.subtotal)})]},o))})]}),e.jsxs("div",{style:t.totalRow,children:[e.jsx("span",{children:"TOTAL"}),e.jsx("strong",{children:l(n.total)})]})]})]})}),e.jsx("style",{children:"@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }"})]})}const t={container:{padding:"20px",maxWidth:"1200px",margin:"0 auto"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"25px",flexWrap:"wrap",gap:"15px"},title:{margin:0,fontSize:"28px",fontWeight:"700",color:"#1a5d1a",display:"flex",alignItems:"center"},subtitle:{margin:"8px 0 0 0",color:"#6c757d",fontSize:"14px"},headerActions:{display:"flex",gap:"12px",flexWrap:"wrap"},primaryButton:{display:"flex",alignItems:"center",gap:"8px",padding:"12px 20px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"600",cursor:"pointer"},secondaryButton:{display:"flex",alignItems:"center",gap:"8px",padding:"12px 20px",background:"white",color:"#1a5d1a",border:"2px solid #1a5d1a",borderRadius:"10px",fontSize:"14px",fontWeight:"600",cursor:"pointer"},statsGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(250px, 1fr))",gap:"20px",marginBottom:"25px"},statCard:{display:"flex",alignItems:"center",gap:"20px",padding:"25px",background:"white",borderRadius:"16px",boxShadow:"0 2px 12px rgba(0,0,0,0.05)"},statValue:{display:"block",fontSize:"32px",fontWeight:"700",color:"#1a5d1a"},statLabel:{fontSize:"14px",color:"#6c757d"},section:{background:"white",borderRadius:"16px",padding:"25px",marginBottom:"25px",boxShadow:"0 2px 12px rgba(0,0,0,0.05)"},sectionTitle:{display:"flex",alignItems:"center",gap:"10px",margin:"0 0 20px 0",fontSize:"18px",fontWeight:"600",color:"#333"},ventasList:{display:"flex",flexDirection:"column",gap:"10px"},ventaCard:{display:"grid",gridTemplateColumns:"100px 1fr 130px 120px 100px auto",alignItems:"center",gap:"15px",padding:"15px 20px",background:"#f8f9fa",borderRadius:"10px"},ventaTime:{display:"flex",alignItems:"center",gap:"8px",color:"#6c757d",fontSize:"14px"},ventaCliente:{fontWeight:"500",color:"#333"},ventaCajero:{display:"flex",alignItems:"center",fontSize:"13px",color:"#1565c0",background:"#e3f2fd",padding:"4px 10px",borderRadius:"6px",fontWeight:"500"},ventaComprobante:{fontSize:"13px",color:"#6c757d"},ventaTotal:{fontWeight:"700",color:"#1a5d1a",textAlign:"right",fontSize:"16px"},detalleButton:{display:"flex",alignItems:"center",gap:"6px",padding:"8px 14px",background:"#e8f5e9",border:"none",borderRadius:"8px",cursor:"pointer",color:"#1a5d1a",fontSize:"13px",fontWeight:"500"},loadingState:{display:"flex",justifyContent:"center",padding:"60px"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",padding:"60px",color:"#6c757d",gap:"15px"},modalOverlay:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:"20px"},modal:{background:"white",borderRadius:"16px",width:"100%",maxWidth:"550px",maxHeight:"90vh",overflow:"hidden",display:"flex",flexDirection:"column"},modalHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"20px 25px",borderBottom:"1px solid #e9ecef",background:"linear-gradient(135deg, #f8f9fa, #e8f5e9)"},modalTitle:{margin:0,fontSize:"18px",fontWeight:"600",color:"#1a5d1a",display:"flex",alignItems:"center",gap:"10px"},closeButton:{background:"none",border:"none",cursor:"pointer",color:"#6c757d"},modalBody:{padding:"25px",overflowY:"auto",flex:1},ventaInfo:{background:"#f8f9fa",borderRadius:"10px",padding:"15px",marginBottom:"20px"},infoRow:{display:"flex",justifyContent:"space-between",padding:"8px 0",borderBottom:"1px solid #e9ecef"},infoLabel:{display:"flex",alignItems:"center",gap:"8px",color:"#6c757d",fontSize:"14px"},infoValue:{fontWeight:"500",color:"#333",fontSize:"14px"},productosTitle:{display:"flex",alignItems:"center",gap:"8px",margin:"0 0 15px 0",fontSize:"16px",fontWeight:"600",color:"#333"},detalleTable:{width:"100%",borderCollapse:"collapse",marginBottom:"20px"},detalleTh:{padding:"10px 12px",textAlign:"left",background:"#f8f9fa",fontSize:"12px",fontWeight:"600",color:"#333"},detalleTd:{padding:"10px 12px",borderBottom:"1px solid #e9ecef",fontSize:"13px"},totalRow:{display:"flex",justifyContent:"space-between",padding:"15px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",borderRadius:"10px",color:"white",fontSize:"18px",fontWeight:"700"}};export{le as default};
