import{r as a,s as h,j as e,B as A,X as B,q as F,n as re}from"./index-hR7h3xft.js";import{n as l,F as oe,L as w}from"./index-BTmhdvE4.js";import{P as M}from"./plus-5-QD-99n.js";import{S as le}from"./search-BOrDwhaZ.js";import{U as G}from"./user-vBIlvuDL.js";import{P as ie}from"./phone-ebSa-qFB.js";import{M as ae}from"./mail-B4i4lRn3.js";import{S as se}from"./square-pen-23WKRUQ4.js";import{T as ne}from"./trash-2-C990xH84.js";import{S as de}from"./save-CVL2Myj-.js";function _e(){const[g,D]=a.useState([]),[H,z]=a.useState(!0),[y,u]=a.useState(!1),[c,E]=a.useState(""),[O,d]=a.useState(!1),[m,j]=a.useState(null),[o,s]=a.useState({nombres:"",apellido_paterno:"",apellido_materno:"",ci_nit:"",telefono:"",email:"",direccion:""}),[P,I]=a.useState(!1),[p,k]=a.useState(null),[f,b]=a.useState([]),[$,T]=a.useState(!1),_=()=>{const r=localStorage.getItem("user");if(r)try{return JSON.parse(r).username||"admin"}catch{return"admin"}return"admin"};a.useEffect(()=>{x()},[]);const x=async()=>{z(!0);try{const{data:r,error:i}=await h.rpc("fn_listar_clientes",{p_busqueda:c||null});if(i)console.error("Error:",i),l.error("Error al cargar clientes");else{const n=(r||[]).sort((Y,ee)=>{const te=parseInt((Y.id_cliente||"").replace(/\D/g,"")||"0");return parseInt((ee.id_cliente||"").replace(/\D/g,"")||"0")-te});D(n)}}catch(r){console.error("Error:",r),l.error("Error de conexión")}finally{z(!1)}};a.useEffect(()=>{const r=setTimeout(()=>{x()},300);return()=>clearTimeout(r)},[c]);const v=/^[a-zA-ZáéíóúÁÉÍÓÚñÑ\s-]+$/,L=/^[0-9A-Z-]{7,12}$/i,X=/^\d{8}$/,U=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,R=()=>o.nombres.trim()?v.test(o.nombres.trim())?o.apellido_paterno&&!v.test(o.apellido_paterno.trim())?(l.error("El apellido paterno solo puede contener letras"),!1):o.apellido_materno&&!v.test(o.apellido_materno.trim())?(l.error("El apellido materno solo puede contener letras"),!1):o.ci_nit.trim()?L.test(o.ci_nit.trim())?o.telefono&&!X.test(o.telefono.trim())?(l.error("El teléfono debe tener exactamente 8 dígitos numéricos"),!1):o.email&&!U.test(o.email.trim())?(l.error("El formato del correo electrónico es inválido"),!1):!0:(l.error("El CI/NIT debe tener entre 7 y 12 caracteres alfanuméricos"),!1):(l.error("El CI/NIT es obligatorio"),!1):(l.error("El nombre solo puede contener letras y espacios"),!1):(l.error("El nombre es obligatorio"),!1),q=async()=>{if(R()){u(!0);try{const{data:r,error:i}=await h.rpc("fn_crear_cliente",{p_nombres:o.nombres.trim(),p_apellido_paterno:o.apellido_paterno.trim()||null,p_apellido_materno:o.apellido_materno.trim()||null,p_ci_nit:o.ci_nit.trim(),p_telefono:o.telefono.trim()||null,p_email:o.email.trim()||null,p_direccion:o.direccion.trim()||null,p_usuario_auditoria:_()});i?i.message.includes("ya existe")?l.error("El CI/NIT ya está registrado"):l.error(i.message||"Error al crear cliente"):(l.success("Cliente creado exitosamente"),d(!1),C(),x())}catch{l.error("Error al crear cliente")}finally{u(!1)}}},Z=async()=>{if(R()){u(!0);try{const{error:r}=await h.rpc("fn_actualizar_cliente",{p_id:m.id_cliente,p_nombres:o.nombres.trim(),p_apellido_paterno:o.apellido_paterno.trim()||null,p_apellido_materno:o.apellido_materno.trim()||null,p_ci_nit:o.ci_nit.trim(),p_telefono:o.telefono.trim()||null,p_email:o.email.trim()||null,p_direccion:o.direccion.trim()||null,p_usuario_auditoria:_()});r?r.message.includes("ya está registrado")?l.error("El CI/NIT ya está registrado para otro cliente"):l.error(r.message||"Error al actualizar"):(l.success("Cliente actualizado exitosamente"),d(!1),C(),x())}catch{l.error("Error al actualizar")}finally{u(!1)}}},J=async(r,i)=>{if(window.confirm(`¿Eliminar el cliente "${i}"?`))try{const{error:n}=await h.rpc("fn_eliminar_cliente",{p_id:r,p_usuario_auditoria:_()});n?l.error(n.message||"Error al eliminar"):(l.success("Cliente eliminado"),x())}catch{l.error("Error al eliminar")}},V=r=>{j(r),s({nombres:r.nombres||"",apellido_paterno:r.apellido_paterno||"",apellido_materno:r.apellido_materno||"",ci_nit:r.ci_nit||"",telefono:r.telefono||"",email:r.email||"",direccion:r.direccion||""}),d(!0)},N=()=>{j(null),C(),d(!0)},C=()=>{s({nombres:"",apellido_paterno:"",apellido_materno:"",ci_nit:"",telefono:"",email:"",direccion:""}),j(null)},K=async r=>{k(r),I(!0),T(!0);try{const{data:i,error:n}=await h.rpc("fn_historial_compras_cliente_detalle",{p_id_cliente:r.id_cliente});if(n)throw n;b(i||[])}catch(i){console.error("Error historial:",i),l.error("Error al cargar historial de compras"),b([])}finally{T(!1)}},S=()=>{I(!1),k(null),b([])},Q=r=>new Date(r).toLocaleDateString("es-BO",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),W=r=>new Intl.NumberFormat("es-BO",{style:"currency",currency:"BOB"}).format(r||0);return e.jsxs("div",{style:t.container,children:[e.jsx(oe,{position:"top-right"}),e.jsxs("header",{style:t.header,children:[e.jsxs("div",{children:[e.jsxs("h1",{style:t.title,children:[e.jsx(A,{size:28,style:{marginRight:"12px"}}),"Clientes"]}),e.jsxs("p",{style:t.subtitle,children:["Gestión de clientes • ",g.length," registros"]})]}),e.jsxs("button",{style:t.primaryButton,onClick:N,children:[e.jsx(M,{size:18}),"Nuevo Cliente"]})]}),e.jsx("div",{style:t.toolbar,children:e.jsxs("div",{style:t.searchBox,children:[e.jsx(le,{size:18,style:{color:"#6c757d"}}),e.jsx("input",{type:"text",placeholder:"Buscar por nombre o CI/NIT...",value:c,onChange:r=>E(r.target.value),style:t.searchInput}),c&&e.jsx("button",{onClick:()=>E(""),style:t.clearButton,children:e.jsx(B,{size:16})})]})}),e.jsx("div",{style:t.tableContainer,children:H?e.jsxs("div",{style:t.loadingState,children:[e.jsx(w,{size:40,style:{animation:"spin 1s linear infinite",color:"#1a5d1a"}}),e.jsx("p",{children:"Cargando clientes..."})]}):g.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(A,{size:48,style:{color:"#ccc"}}),e.jsx("p",{children:c?"No se encontraron resultados":"No hay clientes registrados"}),!c&&e.jsxs("button",{style:t.primaryButton,onClick:N,children:[e.jsx(M,{size:18})," Crear primer cliente"]})]}):e.jsxs("table",{style:t.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.th,children:"Nombres"}),e.jsx("th",{style:t.th,children:"Ap. Paterno"}),e.jsx("th",{style:t.th,children:"Ap. Materno"}),e.jsx("th",{style:t.th,children:"CI/NIT"}),e.jsx("th",{style:t.th,children:"Teléfono"}),e.jsx("th",{style:t.th,children:"Email"}),e.jsx("th",{style:{...t.th,textAlign:"center"},children:"Acciones"})]})}),e.jsx("tbody",{children:g.map(r=>e.jsxs("tr",{style:t.tr,children:[e.jsx("td",{style:t.td,children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"10px"},children:[e.jsx("div",{style:t.avatar,children:e.jsx(G,{size:16})}),e.jsx("strong",{children:`${r.nombres} ${r.apellido_paterno||""} ${r.apellido_materno||""}`.trim()})]})}),e.jsx("td",{style:t.td,children:r.apellido_paterno||e.jsx("span",{style:{color:"#999"},children:"-"})}),e.jsx("td",{style:t.td,children:r.apellido_materno||e.jsx("span",{style:{color:"#999"},children:"-"})}),e.jsx("td",{style:t.td,children:e.jsx("span",{style:t.ciBadge,children:r.ci_nit})}),e.jsx("td",{style:t.td,children:r.telefono?e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(ie,{size:14,style:{color:"#1a5d1a"}})," ",r.telefono]}):e.jsx("span",{style:{color:"#999"},children:"-"})}),e.jsx("td",{style:t.td,children:r.email?e.jsxs("span",{style:{display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(ae,{size:14,style:{color:"#1976d2"}}),e.jsx("span",{style:{maxWidth:"180px",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},title:r.email,children:r.email})]}):e.jsx("span",{style:{color:"#999"},children:"-"})}),e.jsx("td",{style:{...t.td,textAlign:"center"},children:e.jsxs("div",{style:t.actionButtons,children:[e.jsx("button",{type:"button",style:t.historyButton,onClick:()=>K(r),title:"Ver historial de compras",children:e.jsx(F,{size:16})}),e.jsx("button",{type:"button",style:t.editButton,onClick:()=>V(r),title:"Editar cliente",children:e.jsx(se,{size:16})}),e.jsx("button",{type:"button",style:t.deleteButton,onClick:()=>J(r.id_cliente,r.nombre_completo),title:"Eliminar cliente",children:e.jsx(ne,{size:16})})]})})]},r.id_cliente))})]})}),O&&e.jsx("div",{style:t.modalOverlay,onClick:()=>d(!1),children:e.jsxs("div",{style:t.modal,onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{style:t.modalHeader,children:[e.jsx("h2",{style:t.modalTitle,children:m?"Editar Cliente":"Nuevo Cliente"}),e.jsx("button",{style:t.closeButton,onClick:()=>d(!1),children:e.jsx(B,{size:20})})]}),e.jsxs("div",{style:t.modalBody,children:[e.jsxs("div",{style:t.formRow,children:[e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Nombres *"}),e.jsx("input",{type:"text",value:o.nombres,onChange:r=>s({...o,nombres:r.target.value}),style:t.input,placeholder:"Nombres"})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Apellido Paterno"}),e.jsx("input",{type:"text",value:o.apellido_paterno,onChange:r=>s({...o,apellido_paterno:r.target.value}),style:t.input,placeholder:"Apellido Paterno"})]})]}),e.jsxs("div",{style:t.formRow,children:[e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Apellido Materno"}),e.jsx("input",{type:"text",value:o.apellido_materno,onChange:r=>s({...o,apellido_materno:r.target.value}),style:t.input,placeholder:"Apellido Materno"})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"CI/NIT *"}),e.jsx("input",{type:"text",value:o.ci_nit,onChange:r=>s({...o,ci_nit:r.target.value}),style:t.input,placeholder:"Carnet o NIT"})]})]}),e.jsx("div",{style:t.formRow,children:e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Teléfono"}),e.jsx("input",{type:"tel",value:o.telefono,onChange:r=>s({...o,telefono:r.target.value}),style:t.input,placeholder:"Número de teléfono"})]})}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Email"}),e.jsx("input",{type:"email",value:o.email,onChange:r=>s({...o,email:r.target.value}),style:t.input,placeholder:"correo@ejemplo.com"})]}),e.jsxs("div",{style:t.formGroup,children:[e.jsx("label",{style:t.label,children:"Dirección"}),e.jsx("input",{type:"text",value:o.direccion,onChange:r=>s({...o,direccion:r.target.value}),style:t.input,placeholder:"Dirección del cliente"})]})]}),e.jsxs("div",{style:t.modalFooter,children:[e.jsx("button",{style:t.cancelButton,onClick:()=>d(!1),disabled:y,children:"Cancelar"}),e.jsx("button",{style:t.saveButton,onClick:m?Z:q,disabled:y,children:y?e.jsxs(e.Fragment,{children:[e.jsx(w,{size:16,style:{animation:"spin 1s linear infinite"}})," Guardando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{size:16})," ",m?"Actualizar":"Crear"]})})]})]})}),P&&p&&e.jsx("div",{style:t.modalOverlay,onClick:S,children:e.jsxs("div",{style:{...t.modal,maxWidth:"800px"},onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{style:t.modalHeader,children:[e.jsxs("h2",{style:t.modalTitle,children:[e.jsx(F,{size:22,style:{marginRight:"10px"}}),"Historial de Compras"]}),e.jsx("button",{style:t.closeButton,onClick:S,children:e.jsx(B,{size:20})})]}),e.jsxs("div",{style:t.modalBody,children:[e.jsxs("div",{style:t.clienteInfoBox,children:[e.jsx(G,{size:20,style:{color:"#1a5d1a"}}),e.jsxs("div",{children:[e.jsx("strong",{children:`${p.nombres} ${p.apellido_paterno||""} ${p.apellido_materno||""}`.trim()}),e.jsxs("span",{style:{display:"block",fontSize:"12px",color:"#6c757d"},children:["CI/NIT: ",p.ci_nit]})]})]}),$?e.jsxs("div",{style:t.loadingState,children:[e.jsx(w,{size:32,style:{animation:"spin 1s linear infinite",color:"#1a5d1a"}}),e.jsx("p",{children:"Cargando historial..."})]}):f.length===0?e.jsxs("div",{style:t.emptyState,children:[e.jsx(re,{size:48,style:{color:"#ccc"}}),e.jsx("p",{children:"No hay compras registradas para este cliente"})]}):e.jsxs("div",{style:{overflowX:"auto",marginTop:"15px"},children:[e.jsxs("table",{style:t.historialTable,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:t.historialTh,children:"Fecha"}),e.jsx("th",{style:t.historialTh,children:"Nro. Factura"}),e.jsx("th",{style:t.historialTh,children:"Productos"}),e.jsx("th",{style:t.historialTh,children:"Total"}),e.jsx("th",{style:t.historialTh,children:"Pago"}),e.jsx("th",{style:t.historialTh,children:"Cajero"})]})}),e.jsx("tbody",{children:f.map((r,i)=>e.jsxs("tr",{style:t.tr,children:[e.jsx("td",{style:t.historialTd,children:Q(r.fecha)}),e.jsx("td",{style:t.historialTd,children:e.jsx("span",{style:t.facturaBadge,children:r.numero_factura})}),e.jsx("td",{style:{...t.historialTd,maxWidth:"250px"},children:e.jsx("span",{style:t.productosList,title:r.productos,children:r.productos||"-"})}),e.jsx("td",{style:{...t.historialTd,fontWeight:"600",color:"#1a5d1a"},children:W(r.total)}),e.jsx("td",{style:t.historialTd,children:e.jsx("span",{style:t.pagoBadge,children:r.forma_pago})}),e.jsx("td",{style:t.historialTd,children:r.cajero})]},i))})]}),e.jsxs("div",{style:t.historialResumen,children:[e.jsxs("span",{children:["Total de compras: ",e.jsx("strong",{children:f.length})]}),e.jsxs("span",{children:["Monto total: ",e.jsx("strong",{style:{color:"#1a5d1a"},children:W(f.reduce((r,i)=>r+parseFloat(i.total||0),0))})]})]})]})]}),e.jsx("div",{style:t.modalFooter,children:e.jsx("button",{style:t.cancelButton,onClick:S,children:"Cerrar"})})]})}),e.jsx("style",{children:"@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }"})]})}const t={container:{padding:"20px",maxWidth:"1400px",margin:"0 auto"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"25px",flexWrap:"wrap",gap:"15px"},title:{margin:0,fontSize:"28px",fontWeight:"700",color:"#1a5d1a",display:"flex",alignItems:"center"},subtitle:{margin:"8px 0 0 0",color:"#6c757d",fontSize:"14px"},primaryButton:{display:"flex",alignItems:"center",gap:"8px",padding:"12px 20px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white",border:"none",borderRadius:"10px",fontSize:"14px",fontWeight:"600",cursor:"pointer",boxShadow:"0 4px 12px rgba(26, 93, 26, 0.3)"},toolbar:{display:"flex",gap:"12px",marginBottom:"20px",flexWrap:"wrap"},searchBox:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 15px",background:"white",border:"1px solid #e9ecef",borderRadius:"10px",flex:1,maxWidth:"400px"},searchInput:{border:"none",outline:"none",fontSize:"14px",width:"100%",background:"transparent"},clearButton:{background:"none",border:"none",cursor:"pointer",color:"#999",padding:"2px"},tableContainer:{background:"white",borderRadius:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)",overflow:"auto"},table:{width:"100%",borderCollapse:"collapse",minWidth:"1100px"},th:{padding:"12px 15px",textAlign:"left",background:"#f8f9fa",color:"#1a5d1a",fontWeight:"600",fontSize:"13px",borderBottom:"2px solid #e9ecef",whiteSpace:"nowrap"},tr:{borderBottom:"1px solid #e9ecef"},td:{padding:"12px 15px",fontSize:"13px",color:"#495057"},avatar:{width:"32px",height:"32px",borderRadius:"50%",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",display:"flex",alignItems:"center",justifyContent:"center",color:"white",flexShrink:0},actionButtons:{display:"flex",gap:"8px",justifyContent:"center"},editButton:{padding:"8px",background:"#e3f2fd",border:"none",borderRadius:"8px",cursor:"pointer",color:"#1976d2",transition:"all 0.2s"},deleteButton:{padding:"8px",background:"#ffebee",border:"none",borderRadius:"8px",cursor:"pointer",color:"#d32f2f",transition:"all 0.2s"},loadingState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",color:"#6c757d",gap:"15px"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:"60px 20px",color:"#6c757d",gap:"15px"},modalOverlay:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3,padding:"20px"},modal:{background:"white",borderRadius:"16px",width:"100%",maxWidth:"600px",boxShadow:"0 20px 60px rgba(0, 0, 0, 0.3)",overflow:"hidden"},modalHeader:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"20px 25px",borderBottom:"1px solid #e9ecef",background:"linear-gradient(135deg, #f8f9fa, #e8f5e9)"},modalTitle:{margin:0,fontSize:"20px",fontWeight:"600",color:"#1a5d1a"},closeButton:{background:"none",border:"none",cursor:"pointer",color:"#6c757d",padding:"5px",borderRadius:"5px"},modalBody:{padding:"25px"},formRow:{display:"flex",gap:"15px",marginBottom:"15px",flexWrap:"wrap"},formGroup:{flex:1,minWidth:"200px",marginBottom:"15px"},label:{display:"block",marginBottom:"8px",fontSize:"14px",fontWeight:"500",color:"#1a5d1a"},input:{width:"100%",padding:"12px 15px",border:"2px solid #e9ecef",borderRadius:"10px",fontSize:"14px",outline:"none",boxSizing:"border-box"},modalFooter:{display:"flex",justifyContent:"flex-end",gap:"12px",padding:"20px 25px",borderTop:"1px solid #e9ecef",background:"#f8f9fa"},cancelButton:{padding:"10px 20px",background:"white",border:"1px solid #e9ecef",borderRadius:"8px",fontSize:"14px",cursor:"pointer",color:"#6c757d"},saveButton:{display:"flex",alignItems:"center",gap:"8px",padding:"10px 20px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white",border:"none",borderRadius:"8px",fontSize:"14px",fontWeight:"500",cursor:"pointer"},ciBadge:{padding:"4px 10px",borderRadius:"6px",fontSize:"12px",fontWeight:"600",background:"#e3f2fd",color:"#1565c0",border:"1px solid #bbdefb"},historyButton:{padding:"8px",background:"#fff3e0",border:"none",borderRadius:"8px",cursor:"pointer",color:"#e65100",transition:"all 0.2s"},clienteInfoBox:{display:"flex",alignItems:"center",gap:"12px",padding:"15px",background:"#e8f5e9",borderRadius:"10px",marginBottom:"15px"},historialTable:{width:"100%",borderCollapse:"collapse",fontSize:"13px"},historialTh:{padding:"12px 10px",textAlign:"left",background:"#f8f9fa",color:"#1a5d1a",fontWeight:"600",fontSize:"12px",borderBottom:"2px solid #e9ecef"},historialTd:{padding:"12px 10px",borderBottom:"1px solid #e9ecef",verticalAlign:"middle"},facturaBadge:{padding:"3px 8px",borderRadius:"4px",fontSize:"11px",fontWeight:"600",background:"#e3f2fd",color:"#1565c0"},pagoBadge:{padding:"3px 8px",borderRadius:"4px",fontSize:"11px",fontWeight:"600",background:"#fff3e0",color:"#e65100"},productosList:{fontSize:"12px",color:"#495057",display:"block",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",cursor:"help"},historialResumen:{display:"flex",justifyContent:"space-between",padding:"15px",background:"#f8f9fa",borderRadius:"8px",marginTop:"15px",fontSize:"14px"}};export{_e as default};
