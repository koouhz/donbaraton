import{c as te,r as i,s as R,j as e,b as ae,f as se,U as Y,X as re,C as P,L as ne,g as oe}from"./index-DyRGlXyn.js";import{n as c,F as ie,L as E}from"./index-Bk6qzOxF.js";import{C as U}from"./clock-B6XNtadS.js";import{R as le}from"./refresh-cw-VSjeutiz.js";import{S as de}from"./search-BOAzkQOY.js";const ce=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],pe=te("user-x",ce);function me(){const p=i.useCallback(()=>{const t=new Date,r=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return`${r}-${s}-${n}`},[]),b=i.useCallback(()=>{const t=new Date,r=String(t.getHours()).padStart(2,"0"),s=String(t.getMinutes()).padStart(2,"0"),n=String(t.getSeconds()).padStart(2,"0");return`${r}:${s}:${n}`},[]),[v,M]=i.useState([]),[V,G]=i.useState([]),[w,B]=i.useState(!0),[X,D]=i.useState(null),[u,z]=i.useState(p()),[f,T]=i.useState(""),[L,q]=i.useState(b()),[C,J]=i.useState(p()),I=i.useRef(null),j=i.useRef(u),K=()=>{const t=localStorage.getItem("user");if(t)try{return JSON.parse(t).username||"admin"}catch{return"admin"}return"admin"},x=i.useCallback(async()=>{B(!0);try{const t=j.current,r=new Date(t+"T00:00:00");r.setDate(r.getDate()-1);const s=r.toISOString().split("T")[0],n=new Date(t+"T00:00:00");n.setDate(n.getDate()+1);const l=n.toISOString().split("T")[0],[g,d]=await Promise.all([R.rpc("fn_listar_empleados"),R.from("asistencias").select("*").gte("fecha",s).lte("fecha",l)]);g.error&&console.error("Error empleados:",g.error),d.error&&console.error("Error asistencias:",d.error);const ee=(g.data||[]).map(o=>({id_empleado:o.id_empleado,ci:o.id_empleado,nombres:o.nombre_completo?.split(" ")[0]||"",apellido_paterno:o.nombre_completo?.split(" ").slice(1).join(" ")||"",cargo:o.cargo||"-",nombre_completo:o.nombre_completo||"Sin nombre",estado:o.estado})),_=d.data||[],N=p(),$=t===N,y={};_.forEach(o=>{const A=y[o.id_empleado];if(!A)y[o.id_empleado]=o;else{const O=A.fecha===t,H=o.fecha===t;(H&&!O||!O&&!H&&o.fecha>A.fecha)&&(y[o.id_empleado]=o)}});let k=Object.values(y);$||(k=k.filter(o=>o.fecha===t)),G(ee),M(k),console.log("=== DEBUG ASISTENCIAS ==="),console.log("Fecha local hoy:",N),console.log("Fecha consulta:",t),console.log("Es hoy:",$),console.log("Rango consultado:",s,"a",l),console.log("Total asistencias en rango:",_.length),console.log("Asistencias mostradas:",k.length),_.length>0&&console.log("Fechas encontradas:",[...new Set(_.map(o=>o.fecha))])}catch(t){console.error("Error:",t),c.error("Error al cargar datos")}finally{B(!1)}},[p]);i.useEffect(()=>{const t=()=>{const s=b(),n=p();q(s),n!==C&&(J(n),j.current===C&&(z(n),j.current=n,c.success("Â¡Nuevo dÃ­a! Asistencias reiniciadas")))};t();const r=setInterval(t,1e3);return()=>clearInterval(r)},[b,p,C]),i.useEffect(()=>{j.current=u,x()},[u,x]),i.useEffect(()=>(I.current=setInterval(()=>{x()},3e4),()=>{I.current&&clearInterval(I.current)}),[x]);const W=async(t,r)=>{if(!t.id_empleado){c.error("Error: No se pudo identificar al empleado"),console.error("Empleado sin ID:",t);return}if(u!==p()){c.error("Solo puedes registrar asistencias del dÃ­a actual");return}const s=v.find(l=>l.id_empleado===t.id_empleado);if(r==="ENTRADA"&&s?.hora_entrada){c.error("Ya se registrÃ³ entrada para este empleado hoy"),await x();return}if(r==="SALIDA"){if(!s?.hora_entrada){c.error("Primero debe registrar la entrada");return}if(s?.hora_salida){c.error("Ya se registrÃ³ salida para este empleado hoy"),await x();return}}D(t.id_empleado);const n=b();try{const{data:l,error:g}=await R.rpc("fn_registrar_asistencia",{p_id_empleado:t.id_empleado,p_tipo:r,p_hora:n,p_observaciones:null,p_usuario_auditoria:K()});if(g){let d=g.message||"Error al registrar asistencia";d.includes("Ya se registrÃ³ una entrada")?d="Ya se registrÃ³ entrada para este empleado hoy":d.includes("No existe registro de entrada")?d="Primero debe registrar la entrada":d.includes("Ya se registrÃ³ una salida")&&(d="Ya se registrÃ³ salida para este empleado hoy"),c.error(d)}else c.success(`${r==="ENTRADA"?"âœ… Entrada":"ðŸšª Salida"} registrada a las ${n.substring(0,5)} para ${t.nombre_completo}`);await x()}catch(l){console.error("Error:",l),c.error("Error al registrar asistencia"),await x()}finally{D(null)}},S=t=>t?.substring(0,5)||"--:--",Q=t=>new Date(t+"T00:00:00").toLocaleDateString("es-BO",{weekday:"long",day:"numeric",month:"long",year:"numeric"}),m=V.filter(t=>t.nombre_completo?.toLowerCase().includes(f.toLowerCase())||t.ci?.toLowerCase().includes(f.toLowerCase())),F=m.filter(t=>v.find(s=>s.id_empleado===t.id_empleado)?.hora_entrada).length,Z=m.length-F,h=u===p();return e.jsxs("div",{style:a.container,children:[e.jsx(ie,{position:"top-right"}),e.jsxs("header",{style:a.header,children:[e.jsxs("div",{children:[e.jsxs("h1",{style:a.title,children:[e.jsx(U,{size:28,style:{marginRight:"12px"}}),"Control de Asistencias"]}),e.jsx("p",{style:a.subtitle,children:"Registro de entrada y salida del personal"})]}),e.jsxs("div",{style:a.headerActions,children:[e.jsxs("div",{style:a.clockDisplay,children:[e.jsx(U,{size:16}),e.jsx("span",{style:a.clockTime,children:L.substring(0,5)})]}),e.jsx("button",{style:a.refreshButton,onClick:x,disabled:w,children:e.jsx(le,{size:18,style:{animation:w?"spin 1s linear infinite":"none"}})}),e.jsxs("div",{style:a.dateSelector,children:[e.jsx(ae,{size:18}),e.jsx("input",{type:"date",value:u,onChange:t=>z(t.target.value),style:a.dateInput})]})]})]}),e.jsxs("div",{style:a.dateDisplay,children:[e.jsxs("span",{style:a.dateBadge,children:[h?"ðŸ“… Hoy: ":"ðŸ“… ",Q(u)]}),!h&&e.jsx("button",{style:a.todayButton,onClick:()=>z(p()),children:"Ir a hoy"})]}),e.jsxs("div",{style:a.statsGrid,children:[e.jsxs("div",{style:a.statCard,children:[e.jsx(se,{size:28,style:{color:"#2e7d32"}}),e.jsxs("div",{children:[e.jsx("span",{style:{...a.statValue,color:"#2e7d32"},children:F}),e.jsx("span",{style:a.statLabel,children:"Presentes"})]})]}),e.jsxs("div",{style:a.statCard,children:[e.jsx(pe,{size:28,style:{color:"#c62828"}}),e.jsxs("div",{children:[e.jsx("span",{style:{...a.statValue,color:"#c62828"},children:Z}),e.jsx("span",{style:a.statLabel,children:"Ausentes"})]})]}),e.jsxs("div",{style:a.statCard,children:[e.jsx(Y,{size:28,style:{color:"#1565c0"}}),e.jsxs("div",{children:[e.jsx("span",{style:a.statValue,children:m.length}),e.jsx("span",{style:a.statLabel,children:"Total Empleados"})]})]})]}),e.jsx("div",{style:a.toolbar,children:e.jsxs("div",{style:a.searchBox,children:[e.jsx(de,{size:18,style:{color:"#6c757d"}}),e.jsx("input",{type:"text",placeholder:"Buscar empleado...",value:f,onChange:t=>T(t.target.value),style:a.searchInput}),f&&e.jsx("button",{onClick:()=>T(""),style:a.clearButton,children:e.jsx(re,{size:16})})]})}),h&&e.jsxs("div",{style:a.infoCard,children:[e.jsx(P,{size:18}),e.jsxs("p",{children:["La hora actual es ",e.jsx("strong",{children:L.substring(0,5)}),". Al registrar, se guardarÃ¡ la hora exacta del momento del clic."]})]}),!h&&e.jsxs("div",{style:a.warningCard,children:[e.jsx(P,{size:18}),e.jsx("p",{children:"EstÃ¡s viendo las asistencias de una fecha anterior. Solo puedes registrar asistencias del dÃ­a actual."})]}),e.jsx("div",{style:a.tableContainer,children:w?e.jsxs("div",{style:a.loadingState,children:[e.jsx(E,{size:40,style:{animation:"spin 1s linear infinite",color:"#1a5d1a"}}),e.jsx("p",{children:"Cargando asistencias..."})]}):m.length===0?e.jsxs("div",{style:a.emptyState,children:[e.jsx(Y,{size:48,style:{color:"#ccc"}}),e.jsx("p",{children:f?"No se encontraron empleados":"No hay empleados registrados"})]}):e.jsxs("table",{style:a.table,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:a.th,children:"Empleado"}),e.jsx("th",{style:a.th,children:"Cargo"}),e.jsx("th",{style:{...a.th,textAlign:"center"},children:"Entrada"}),e.jsx("th",{style:{...a.th,textAlign:"center"},children:"Salida"}),h&&e.jsx("th",{style:{...a.th,textAlign:"center"},children:"Acciones"})]})}),e.jsx("tbody",{children:m.map(t=>{const r=v.find(g=>g.id_empleado===t.id_empleado),s=r?.hora_entrada,n=r?.hora_salida,l=X===t.id_empleado;return e.jsxs("tr",{style:a.tr,children:[e.jsx("td",{style:a.td,children:e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"12px"},children:[e.jsx("div",{style:a.avatar,children:t.nombre_completo?.[0]||"E"}),e.jsxs("div",{children:[e.jsx("strong",{children:t.nombre_completo}),e.jsx("div",{style:{fontSize:"12px",color:"#6c757d"},children:t.ci})]})]})}),e.jsx("td",{style:a.td,children:t.cargo||"-"}),e.jsx("td",{style:{...a.td,textAlign:"center"},children:s?e.jsx("span",{style:a.timeIn,children:S(r.hora_entrada)}):e.jsx("span",{style:a.noTime,children:"--:--"})}),e.jsx("td",{style:{...a.td,textAlign:"center"},children:n?e.jsx("span",{style:a.timeOut,children:S(r.hora_salida)}):e.jsx("span",{style:a.noTime,children:"--:--"})}),h&&e.jsx("td",{style:{...a.td,textAlign:"center"},children:e.jsxs("div",{style:a.actionButtons,children:[e.jsx("button",{style:s?a.entradaButtonDisabled:a.entradaButton,onClick:()=>W(t,"ENTRADA"),disabled:l||s,title:s?`Entrada registrada: ${S(r.hora_entrada)}`:"Registrar entrada",children:l&&!s?e.jsx(E,{size:16,style:{animation:"spin 1s linear infinite"}}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{size:16})," ",s?"âœ“":"Entrada"]})}),e.jsx("button",{style:!s||n?a.salidaButtonDisabled:a.salidaButton,onClick:()=>W(t,"SALIDA"),disabled:l||!s||n,title:s?n?`Salida registrada: ${S(r.hora_salida)}`:"Registrar salida":"Primero registre la entrada",children:l&&s&&!n?e.jsx(E,{size:16,style:{animation:"spin 1s linear infinite"}}):e.jsxs(e.Fragment,{children:[e.jsx(oe,{size:16})," ",n?"âœ“":"Salida"]})})]})})]},t.id_empleado||t.ci)})})]})}),e.jsx("style",{children:`
        @keyframes spin { 
          from { transform: rotate(0deg); } 
          to { transform: rotate(360deg); } 
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.7; }
        }
      `})]})}const a={container:{padding:"20px",maxWidth:"1200px",margin:"0 auto"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"20px",flexWrap:"wrap",gap:"15px"},title:{margin:0,fontSize:"28px",fontWeight:"700",color:"#1a5d1a",display:"flex",alignItems:"center"},subtitle:{margin:"8px 0 0 0",color:"#6c757d",fontSize:"14px"},headerActions:{display:"flex",gap:"12px",alignItems:"center"},clockDisplay:{display:"flex",alignItems:"center",gap:"8px",padding:"10px 16px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",borderRadius:"10px",color:"white",fontWeight:"600"},clockTime:{fontSize:"18px",fontFamily:"monospace"},refreshButton:{padding:"10px",background:"white",border:"1px solid #e9ecef",borderRadius:"10px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"},dateSelector:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 16px",background:"white",borderRadius:"10px",border:"1px solid #e9ecef"},dateInput:{border:"none",background:"none",fontSize:"14px",color:"#333",outline:"none",cursor:"pointer"},dateDisplay:{marginBottom:"20px",display:"flex",alignItems:"center",gap:"15px"},dateBadge:{display:"inline-block",padding:"8px 16px",background:"linear-gradient(135deg, #e8f5e9, #c8e6c9)",borderRadius:"10px",color:"#1a5d1a",fontSize:"14px",fontWeight:"500",textTransform:"capitalize"},todayButton:{padding:"8px 16px",background:"#1a5d1a",color:"white",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:"13px",fontWeight:"500"},statsGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(180px, 1fr))",gap:"15px",marginBottom:"20px"},statCard:{display:"flex",alignItems:"center",gap:"15px",padding:"20px",background:"white",borderRadius:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)"},statValue:{display:"block",fontSize:"28px",fontWeight:"700",color:"#1a5d1a"},statLabel:{fontSize:"13px",color:"#6c757d"},toolbar:{marginBottom:"15px"},searchBox:{display:"flex",alignItems:"center",gap:"10px",padding:"10px 15px",background:"white",border:"1px solid #e9ecef",borderRadius:"10px",maxWidth:"350px"},searchInput:{border:"none",outline:"none",fontSize:"14px",width:"100%",background:"transparent"},clearButton:{background:"none",border:"none",cursor:"pointer",color:"#999",padding:"2px"},infoCard:{display:"flex",alignItems:"center",gap:"12px",padding:"15px 20px",background:"#e3f2fd",borderRadius:"10px",marginBottom:"20px",color:"#1565c0",fontSize:"14px"},warningCard:{display:"flex",alignItems:"center",gap:"12px",padding:"15px 20px",background:"#fff3e0",borderRadius:"10px",marginBottom:"20px",color:"#e65100",fontSize:"14px"},tableContainer:{background:"white",borderRadius:"12px",boxShadow:"0 2px 8px rgba(0,0,0,0.05)",overflow:"auto"},table:{width:"100%",borderCollapse:"collapse",minWidth:"700px"},th:{padding:"15px 20px",textAlign:"left",background:"#f8f9fa",color:"#1a5d1a",fontWeight:"600",fontSize:"14px",borderBottom:"2px solid #e9ecef"},tr:{borderBottom:"1px solid #e9ecef",transition:"background 0.2s"},td:{padding:"15px 20px",fontSize:"14px",color:"#495057"},avatar:{width:"40px",height:"40px",borderRadius:"50%",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",display:"flex",alignItems:"center",justifyContent:"center",color:"white",fontWeight:"600",fontSize:"16px"},timeIn:{padding:"4px 12px",background:"#e8f5e9",borderRadius:"6px",color:"#2e7d32",fontWeight:"600",fontSize:"13px"},timeOut:{padding:"4px 12px",background:"#e3f2fd",borderRadius:"6px",color:"#1565c0",fontWeight:"600",fontSize:"13px"},noTime:{color:"#ccc",fontSize:"14px"},actionButtons:{display:"flex",gap:"8px",justifyContent:"center"},entradaButton:{display:"flex",alignItems:"center",gap:"6px",padding:"8px 14px",background:"linear-gradient(135deg, #1a5d1a, #2e8b57)",color:"white",border:"none",borderRadius:"8px",fontSize:"13px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s"},entradaButtonDisabled:{display:"flex",alignItems:"center",gap:"6px",padding:"8px 14px",background:"#c8e6c9",color:"#2e7d32",border:"none",borderRadius:"8px",fontSize:"13px",fontWeight:"500",cursor:"not-allowed",opacity:"0.8"},salidaButton:{display:"flex",alignItems:"center",gap:"6px",padding:"8px 14px",background:"linear-gradient(135deg, #1565c0, #1976d2)",color:"white",border:"none",borderRadius:"8px",fontSize:"13px",fontWeight:"500",cursor:"pointer",transition:"all 0.2s"},salidaButtonDisabled:{display:"flex",alignItems:"center",gap:"6px",padding:"8px 14px",background:"#bbdefb",color:"#1565c0",border:"none",borderRadius:"8px",fontSize:"13px",fontWeight:"500",cursor:"not-allowed",opacity:"0.8"},loadingState:{display:"flex",flexDirection:"column",alignItems:"center",padding:"60px",color:"#6c757d",gap:"15px"},emptyState:{display:"flex",flexDirection:"column",alignItems:"center",padding:"60px",color:"#6c757d",gap:"15px"}};export{me as default};
