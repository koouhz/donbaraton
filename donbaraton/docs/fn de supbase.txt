| nombre_funcion                    | codigo_completo                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| --------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| fn_desactivar_rol                 | CREATE OR REPLACE FUNCTION public.fn_desactivar_rol(p_id_rol character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'SEGURIDAD', 'DESACTIVAR_ROL',
        'Rol ID: ' || p_id_rol
    );

    UPDATE public.roles SET estado = 'INACTIVO' WHERE id_rol = p_id_rol;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_editar_rol                     | CREATE OR REPLACE FUNCTION public.fn_editar_rol(p_id_rol character varying, p_nombre character varying, p_descripcion text, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'SEGURIDAD', 'EDITAR_ROL',
        'Rol ID: ' || p_id_rol
    );

    UPDATE public.roles
    SET nombre = COALESCE(p_nombre, nombre),
        descripcion = COALESCE(p_descripcion, descripcion)
    WHERE id_rol = p_id_rol;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fn_listar_roles                   | CREATE OR REPLACE FUNCTION public.fn_listar_roles()
 RETURNS TABLE(id_rol character varying, nombre character varying, descripcion text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY SELECT r.id_rol, r.nombre, r.descripcion, r.estado FROM public.roles r ORDER BY r.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_listar_productos               | CREATE OR REPLACE FUNCTION public.fn_listar_productos()
 RETURNS TABLE(id_producto character varying, codigo_interno character varying, nombre character varying, categoria character varying, marca character varying, precio_venta numeric, stock_actual integer, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT p.id_producto, p.codigo_interno, p.nombre, c.nombre as categoria,
           p.marca, p.precio_venta, p.stock_actual, p.estado
    FROM public.productos p
    LEFT JOIN public.categorias c ON p.id_categoria = c.id_categoria
    ORDER BY p.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_crear_categoria                | CREATE OR REPLACE FUNCTION public.fn_crear_categoria(p_nombre character varying, p_descripcion text, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
    v_new_data JSONB;
BEGIN
    v_id := 'CAT-' || LPAD(nextval('categorias_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.categorias (id_categoria, nombre, descripcion, estado, fecha_registro)
    VALUES (v_id, p_nombre, p_descripcion, 'ACTIVO', CURRENT_TIMESTAMP);
    -- Preparar datos nuevos para log
    v_new_data := jsonb_build_object(
        'id_categoria', v_id,
        'nombre', p_nombre,
        'descripcion', p_descripcion,
        'estado', 'ACTIVO'
    );
    -- Usar auditoría completa
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria,                 -- Usuario
        'PRODUCTOS',                         -- Módulo
        'CREAR_CATEGORIA',                   -- Acción
        'categorias',                        -- Tabla afectada
        v_id,                                -- ID registro
        NULL,                                -- Valores anteriores (es creación)
        v_new_data,                          -- Valores nuevos
        'Creación de categoría: ' || p_nombre -- Detalles
    );
    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fn_listar_categorias              | CREATE OR REPLACE FUNCTION public.fn_listar_categorias()
 RETURNS TABLE(id_categoria character varying, nombre character varying, descripcion text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY SELECT c.id_categoria, c.nombre, c.descripcion, c.estado 
    FROM public.categorias c ORDER BY c.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_listar_proveedores             | CREATE OR REPLACE FUNCTION public.fn_listar_proveedores()
 RETURNS TABLE(id_proveedor character varying, razon_social character varying, nit_ci character varying, telefono character varying, email character varying, plazo_credito integer, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT p.id_proveedor, p.razon_social, p.nit_ci, p.telefono,
           p.email, p.plazo_credito, p.estado
    FROM public.proveedores p ORDER BY p.razon_social;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_asociar_producto_proveedor     | CREATE OR REPLACE FUNCTION public.fn_asociar_producto_proveedor(p_id_producto character varying, p_id_proveedor character varying, p_precio_compra numeric, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'COMPRAS', 'ASOCIAR_PRODUCTO_PROVEEDOR',
        'Producto: ' || p_id_producto || ' - Proveedor: ' || p_id_proveedor
    );

    INSERT INTO public.producto_proveedor (id_producto, id_proveedor, precio_compra)
    VALUES (p_id_producto, p_id_proveedor, p_precio_compra)
    ON CONFLICT (id_producto, id_proveedor) 
    DO UPDATE SET precio_compra = p_precio_compra;

    RETURN TRUE;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_crear_cliente                  | CREATE OR REPLACE FUNCTION public.fn_crear_cliente(p_nombres character varying, p_apellido_paterno character varying, p_apellido_materno character varying, p_ci_nit character varying, p_telefono character varying, p_email character varying, p_direccion text, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    IF EXISTS (SELECT 1 FROM public.clientes WHERE ci_nit = p_ci_nit) THEN
        RAISE EXCEPTION 'El CI/NIT % ya existe.', p_ci_nit;
    END IF;

    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CLIENTES', 'CREAR',
        'Cliente: ' || p_nombres || ' ' || COALESCE(p_apellido_paterno, '')
    );
    
    v_id := 'CLI-' || LPAD(nextval('clientes_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.clientes (
        id_cliente, nombres, apellido_paterno, apellido_materno,
        ci_nit, telefono, email, direccion, estado, fecha_registro
    ) VALUES (
        v_id, p_nombres, p_apellido_paterno, p_apellido_materno,
        p_ci_nit, p_telefono, p_email, p_direccion, 'ACTIVO', CURRENT_TIMESTAMP
    );

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_editar_cliente                 | CREATE OR REPLACE FUNCTION public.fn_editar_cliente(p_id_cliente character varying, p_nombres character varying, p_apellido_paterno character varying, p_apellido_materno character varying, p_telefono character varying, p_email character varying, p_direccion text, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CLIENTES', 'EDITAR',
        'Cliente ID: ' || p_id_cliente
    );

    UPDATE public.clientes
    SET 
        nombres = COALESCE(p_nombres, nombres),
        apellido_paterno = COALESCE(p_apellido_paterno, apellido_paterno),
        apellido_materno = COALESCE(p_apellido_materno, apellido_materno),
        telefono = COALESCE(p_telefono, telefono),
        email = COALESCE(p_email, email),
        direccion = COALESCE(p_direccion, direccion)
    WHERE id_cliente = p_id_cliente;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| fn_desactivar_cliente             | CREATE OR REPLACE FUNCTION public.fn_desactivar_cliente(p_id_cliente character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CLIENTES', 'DESACTIVAR',
        'Cliente ID: ' || p_id_cliente
    );

    UPDATE public.clientes SET estado = 'INACTIVO' WHERE id_cliente = p_id_cliente;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_listar_clientes                | CREATE OR REPLACE FUNCTION public.fn_listar_clientes()
 RETURNS TABLE(id_cliente character varying, nombre_completo character varying, ci_nit character varying, telefono character varying, email character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT c.id_cliente, 
           (c.nombres || ' ' || COALESCE(c.apellido_paterno, '') || ' ' || COALESCE(c.apellido_materno, ''))::VARCHAR,
           c.ci_nit, c.telefono, c.email, c.estado
    FROM public.clientes c ORDER BY c.nombres;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fn_historial_compras_cliente      | CREATE OR REPLACE FUNCTION public.fn_historial_compras_cliente(p_id_cliente character varying)
 RETURNS TABLE(fecha timestamp without time zone, numero_factura character varying, total numeric, forma_pago character varying, cajero character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT v.fecha_hora, v.numero_factura, v.total,
           p.medio, u.username
    FROM public.ventas v
    JOIN public.pagos p ON v.id_venta = p.id_venta
    JOIN public.usuarios u ON v.id_usuario = u.id_usuario
    WHERE v.id_cliente = p_id_cliente AND v.estado = 'ACTIVO'
    ORDER BY v.fecha_hora DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_crear_cargo                    | CREATE OR REPLACE FUNCTION public.fn_crear_cargo(p_nombre character varying, p_descripcion text, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'RRHH', 'CREAR_CARGO',
        'Cargo: ' || p_nombre
    );
    
    v_id := 'CAR-' || LPAD(nextval('cargos_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.cargos (id_cargo, nombre, descripcion, fecha_registro)
    VALUES (v_id, p_nombre, p_descripcion, CURRENT_TIMESTAMP);

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_listar_cargos                  | CREATE OR REPLACE FUNCTION public.fn_listar_cargos()
 RETURNS TABLE(id_cargo character varying, nombre character varying, descripcion text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY SELECT c.id_cargo, c.nombre, c.descripcion FROM public.cargos c ORDER BY c.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| fn_crear_horario                  | CREATE OR REPLACE FUNCTION public.fn_crear_horario(p_nombre character varying, p_hora_entrada time without time zone, p_hora_salida time without time zone, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'RRHH', 'CREAR_HORARIO',
        'Horario: ' || p_nombre
    );
    
    v_id := 'HOR-' || LPAD(nextval('horarios_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.horarios (id_horario, nombre, hora_entrada, hora_salida, fecha_registro)
    VALUES (v_id, p_nombre, p_hora_entrada, p_hora_salida, CURRENT_TIMESTAMP);

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_listar_horarios                | CREATE OR REPLACE FUNCTION public.fn_listar_horarios()
 RETURNS TABLE(id_horario character varying, nombre character varying, hora_entrada time without time zone, hora_salida time without time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY SELECT h.id_horario, h.nombre, h.hora_entrada, h.hora_salida FROM public.horarios h ORDER BY h.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| fn_crear_empleado                 | CREATE OR REPLACE FUNCTION public.fn_crear_empleado(p_ci character varying, p_expedido character varying, p_nombres character varying, p_apellido_paterno character varying, p_apellido_materno character varying, p_fecha_nacimiento date, p_sexo character varying, p_telefono character varying, p_celular character varying, p_email character varying, p_direccion text, p_id_cargo character varying, p_fecha_contratacion date, p_tipo_contrato character varying, p_id_horario character varying, p_salario numeric, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    IF EXISTS (SELECT 1 FROM public.empleados WHERE ci = p_ci) THEN
        RAISE EXCEPTION 'El CI % ya existe.', p_ci;
    END IF;

    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'RRHH', 'CREAR_EMPLEADO',
        'Empleado: ' || p_nombres || ' ' || p_apellido_paterno
    );
    
    v_id := 'EMP-' || LPAD(nextval('empleados_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.empleados (
        id_empleado, ci, expedido, nombres, apellido_paterno, apellido_materno,
        fecha_nacimiento, sexo, telefono, celular, email, direccion,
        id_cargo, fecha_contratacion, tipo_contrato, id_horario, salario,
        estado, fecha_registro
    ) VALUES (
        v_id, p_ci, p_expedido, p_nombres, p_apellido_paterno, p_apellido_materno,
        p_fecha_nacimiento, p_sexo, p_telefono, p_celular, p_email, p_direccion,
        p_id_cargo, p_fecha_contratacion, p_tipo_contrato, p_id_horario, p_salario,
        'ACTIVO', CURRENT_TIMESTAMP
    );

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_editar_empleado                | CREATE OR REPLACE FUNCTION public.fn_editar_empleado(p_id_empleado character varying, p_telefono character varying, p_celular character varying, p_email character varying, p_direccion text, p_id_cargo character varying, p_tipo_contrato character varying, p_id_horario character varying, p_salario numeric, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'RRHH', 'EDITAR_EMPLEADO',
        'Empleado ID: ' || p_id_empleado
    );

    UPDATE public.empleados
    SET 
        telefono = COALESCE(p_telefono, telefono),
        celular = COALESCE(p_celular, celular),
        email = COALESCE(p_email, email),
        direccion = COALESCE(p_direccion, direccion),
        id_cargo = COALESCE(p_id_cargo, id_cargo),
        tipo_contrato = COALESCE(p_tipo_contrato, tipo_contrato),
        id_horario = COALESCE(p_id_horario, id_horario),
        salario = COALESCE(p_salario, salario)
    WHERE id_empleado = p_id_empleado;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_desactivar_empleado            | CREATE OR REPLACE FUNCTION public.fn_desactivar_empleado(p_id_empleado character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'RRHH', 'DESACTIVAR_EMPLEADO',
        'Empleado ID: ' || p_id_empleado
    );

    UPDATE public.empleados SET estado = 'INACTIVO' WHERE id_empleado = p_id_empleado;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| fn_registrar_asistencia           | CREATE OR REPLACE FUNCTION public.fn_registrar_asistencia(p_id_empleado character varying, p_tipo character varying, p_observaciones character varying, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
    v_hora_actual TIME := CURRENT_TIME;
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'RRHH', 'REGISTRAR_ASISTENCIA',
        'Empleado: ' || p_id_empleado || ' | Tipo: ' || p_tipo
    );
    
    v_id := 'ASIS-' || LPAD(nextval('asistencias_seq')::VARCHAR, 3, '0');
    
    IF p_tipo = 'ENTRADA' THEN
        INSERT INTO public.asistencias (
            id_asistencia, id_empleado, fecha, hora_entrada, tipo, metodo, observaciones
        ) VALUES (
            v_id, p_id_empleado, CURRENT_DATE, v_hora_actual, p_tipo, 'MANUAL', p_observaciones
        );
    ELSE
        -- Actualizar registro existente con hora de salida
        UPDATE public.asistencias 
        SET hora_salida = v_hora_actual, tipo = p_tipo
        WHERE id_empleado = p_id_empleado 
          AND fecha = CURRENT_DATE 
          AND hora_salida IS NULL;
        
        IF NOT FOUND THEN
            INSERT INTO public.asistencias (
                id_asistencia, id_empleado, fecha, hora_salida, tipo, metodo, observaciones
            ) VALUES (
                v_id, p_id_empleado, CURRENT_DATE, v_hora_actual, p_tipo, 'MANUAL', p_observaciones
            );
        END IF;
    END IF;

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_crear_orden_compra             | CREATE OR REPLACE FUNCTION public.fn_crear_orden_compra(p_id_proveedor character varying, p_fecha_entrega date, p_detalles jsonb, p_username character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_orden VARCHAR;
    v_id_usuario VARCHAR;
    v_total NUMERIC := 0;
    rec RECORD;
BEGIN
    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_username;
    
    PERFORM public.fn_registrar_auditoria(
        p_username, 'COMPRAS', 'CREAR_ORDEN',
        'Proveedor: ' || p_id_proveedor
    );
    
    v_id_orden := 'OC-' || LPAD(nextval('ordenes_compra_seq')::VARCHAR, 3, '0');

    INSERT INTO public.ordenes_compra (
        id_orden, id_proveedor, fecha_emision, fecha_entrega,
        estado, id_usuario, fecha_registro
    ) VALUES (
        v_id_orden, p_id_proveedor, CURRENT_DATE, p_fecha_entrega,
        'PENDIENTE', v_id_usuario, CURRENT_TIMESTAMP
    );

    FOR rec IN SELECT * FROM jsonb_to_recordset(p_detalles) AS x(
        id_producto VARCHAR, cantidad INTEGER, precio_unitario NUMERIC
    )
    LOOP
        INSERT INTO public.detalle_orden_compra (
            id_detalle_orden, id_orden, id_producto, cantidad,
            precio_unitario, subtotal
        ) VALUES (
            'DOC-' || LPAD(nextval('detalle_orden_seq')::VARCHAR, 3, '0'),
            v_id_orden, rec.id_producto, rec.cantidad,
            rec.precio_unitario, rec.cantidad * rec.precio_unitario
        );
        v_total := v_total + (rec.cantidad * rec.precio_unitario);
    END LOOP;

    UPDATE public.ordenes_compra SET total = v_total WHERE id_orden = v_id_orden;
    RETURN v_id_orden;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_recepcionar_orden              | CREATE OR REPLACE FUNCTION public.fn_recepcionar_orden(p_id_orden character varying, p_lote character varying, p_fecha_vencimiento date, p_username character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_recepcion VARCHAR;
    v_id_usuario VARCHAR;
    v_id_proveedor VARCHAR;
    v_total_orden NUMERIC;
    rec RECORD;
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM public.ordenes_compra WHERE id_orden = p_id_orden AND estado = 'PENDIENTE'
    ) THEN
        RAISE EXCEPTION 'Orden no encontrada o ya procesada';
    END IF;

    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_username;
    SELECT id_proveedor, total INTO v_id_proveedor, v_total_orden 
    FROM ordenes_compra WHERE id_orden = p_id_orden;
    
    PERFORM public.fn_registrar_auditoria(
        p_username, 'COMPRAS', 'RECEPCION', 'Orden: ' || p_id_orden
    );
    
    v_id_recepcion := 'REC-' || LPAD(nextval('recepciones_seq')::VARCHAR, 3, '0');

    INSERT INTO public.recepciones (
        id_recepcion, id_orden, fecha_ingreso, lote, fecha_vencimiento, id_usuario
    ) VALUES (
        v_id_recepcion, p_id_orden, CURRENT_DATE, p_lote, p_fecha_vencimiento, v_id_usuario
    );

    FOR rec IN SELECT doc.id_producto, doc.cantidad FROM public.detalle_orden_compra doc WHERE doc.id_orden = p_id_orden
    LOOP
        INSERT INTO public.movimientos_inventario (
            id_movimiento, id_producto, tipo, cantidad, lote,
            fecha_vencimiento, documento, id_usuario, fecha_hora
        ) VALUES (
            'MOV-' || LPAD(nextval('movimientos_seq')::VARCHAR, 3, '0'),
            rec.id_producto, 'ENTRADA', rec.cantidad, p_lote,
            p_fecha_vencimiento, v_id_recepcion, v_id_usuario, CURRENT_TIMESTAMP
        );

        IF p_fecha_vencimiento IS NOT NULL THEN
            INSERT INTO public.lotes (id_lote, id_producto, lote, fecha_vencimiento, cantidad, estado)
            VALUES (
                'LOT-' || LPAD(nextval('lotes_seq')::VARCHAR, 3, '0'),
                rec.id_producto, p_lote, p_fecha_vencimiento, rec.cantidad, 'ACTIVO'
            );
        END IF;
    END LOOP;

    UPDATE public.ordenes_compra SET estado = 'RECIBIDA' WHERE id_orden = p_id_orden;

    -- Crear cuenta por pagar
    INSERT INTO public.cuentas_por_pagar (
        id_cuenta, id_proveedor, numero_factura, fecha_emision, fecha_vencimiento,
        monto_total, saldo_pendiente, estado, observaciones, fecha_registro
    ) VALUES (
        'CTAP-' || LPAD(nextval('cuentas_pagar_seq')::VARCHAR, 3, '0'),
        v_id_proveedor, 'FAC-' || p_id_orden, CURRENT_DATE,
        CURRENT_DATE + COALESCE((SELECT plazo_credito FROM proveedores WHERE id_proveedor = v_id_proveedor), 30),
        v_total_orden, v_total_orden, 'PENDIENTE', 'Generado desde orden ' || p_id_orden, CURRENT_TIMESTAMP
    );

    RETURN v_id_recepcion;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_devolucion_proveedor           | CREATE OR REPLACE FUNCTION public.fn_devolucion_proveedor(p_id_recepcion character varying, p_motivo character varying, p_cantidad integer, p_observaciones text, p_username character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_devolucion VARCHAR;
    v_id_usuario VARCHAR;
BEGIN
    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_username;
    
    PERFORM public.fn_registrar_auditoria(
        p_username, 'COMPRAS', 'DEVOLUCION_PROVEEDOR',
        'Recepción: ' || p_id_recepcion || ' | Motivo: ' || p_motivo
    );
    
    v_id_devolucion := 'DEV-P-' || LPAD(nextval('devoluciones_prov_seq')::VARCHAR, 3, '0');

    INSERT INTO public.devoluciones_proveedor (
        id_devolucion, id_recepcion, motivo, cantidad, observaciones, fecha
    ) VALUES (
        v_id_devolucion, p_id_recepcion, p_motivo, p_cantidad, p_observaciones, CURRENT_TIMESTAMP
    );

    RETURN v_id_devolucion;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_listar_cuentas_por_pagar       | CREATE OR REPLACE FUNCTION public.fn_listar_cuentas_por_pagar(p_estado character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id_cuenta character varying, proveedor character varying, numero_factura character varying, fecha_vencimiento date, monto_total numeric, saldo_pendiente numeric, estado character varying, dias_vencido integer)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT cp.id_cuenta, prov.razon_social, cp.numero_factura,
           cp.fecha_vencimiento, cp.monto_total, cp.saldo_pendiente, cp.estado,
           (CURRENT_DATE - cp.fecha_vencimiento)::INTEGER as dias_vencido
    FROM public.cuentas_por_pagar cp
    JOIN public.proveedores prov ON cp.id_proveedor = prov.id_proveedor
    WHERE (p_estado IS NULL OR cp.estado = p_estado)
    ORDER BY cp.fecha_vencimiento ASC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_registrar_pago_proveedor       | CREATE OR REPLACE FUNCTION public.fn_registrar_pago_proveedor(p_id_cuenta character varying, p_monto numeric, p_username character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_saldo_actual NUMERIC;
BEGIN
    SELECT saldo_pendiente INTO v_saldo_actual FROM cuentas_por_pagar WHERE id_cuenta = p_id_cuenta;
    
    IF p_monto > v_saldo_actual THEN
        RAISE EXCEPTION 'Monto a pagar excede el saldo pendiente';
    END IF;
    
    PERFORM public.fn_registrar_auditoria(
        p_username, 'COMPRAS', 'PAGO_PROVEEDOR',
        'Cuenta: ' || p_id_cuenta || ' | Monto: ' || p_monto
    );

    UPDATE public.cuentas_por_pagar
    SET saldo_pendiente = saldo_pendiente - p_monto,
        estado = CASE WHEN saldo_pendiente - p_monto <= 0 THEN 'PAGADO' ELSE estado END
    WHERE id_cuenta = p_id_cuenta;

    RETURN TRUE;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_cierre_caja                    | CREATE OR REPLACE FUNCTION public.fn_cierre_caja(p_id_usuario character varying, p_efectivo_fisico numeric, p_observaciones character varying, p_username character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_cierre VARCHAR;
    v_total_sistema NUMERIC;
    v_diferencia NUMERIC;
BEGIN
    SELECT COALESCE(SUM(p.importe - p.vuelto), 0) INTO v_total_sistema
    FROM public.pagos p
    JOIN public.ventas v ON p.id_venta = v.id_venta
    WHERE v.id_usuario = p_id_usuario
      AND DATE(v.fecha_hora) = CURRENT_DATE
      AND p.medio = 'EFECTIVO'
      AND v.estado = 'ACTIVO';

    v_diferencia := p_efectivo_fisico - v_total_sistema;
    
    PERFORM public.fn_registrar_auditoria(
        p_username, 'CAJA', 'CIERRE',
        'Usuario: ' || p_id_usuario || ' | Diferencia: ' || v_diferencia
    );
    
    v_id_cierre := 'CIERRE-' || LPAD(nextval('cierre_caja_seq')::VARCHAR, 3, '0');

    INSERT INTO public.cierre_caja (
        id_cierre, id_usuario, fecha, hora_cierre, total_efectivo, diferencia, observaciones
    ) VALUES (
        v_id_cierre, p_id_usuario, CURRENT_DATE, CURRENT_TIME, p_efectivo_fisico, v_diferencia, p_observaciones
    );

    RETURN v_id_cierre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fn_anular_venta                   | CREATE OR REPLACE FUNCTION public.fn_anular_venta(p_id_venta character varying, p_username character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_username, 'VENTAS', 'ANULAR', 'Venta: ' || p_id_venta
    );

    UPDATE public.ventas SET estado = 'ANULADO' WHERE id_venta = p_id_venta;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| trg_actualizar_stock              | CREATE OR REPLACE FUNCTION public.trg_actualizar_stock()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF NEW.tipo IN ('ENTRADA', 'AJUSTE+', 'DEVOLUCION_VENTA') THEN
        UPDATE productos SET stock_actual = stock_actual + NEW.cantidad WHERE id_producto = NEW.id_producto;
    ELSIF NEW.tipo IN ('SALIDA', 'AJUSTE-', 'VENTA', 'MERMA', 'DAÑO', 'ROBO', 'DEVOLUCION_PROVEEDOR') THEN
        IF EXISTS (
            SELECT 1 FROM productos WHERE id_producto = NEW.id_producto AND stock_actual - NEW.cantidad < 0
        ) THEN
            RAISE EXCEPTION 'Stock insuficiente para producto %', NEW.id_producto;
        END IF;
        UPDATE productos SET stock_actual = stock_actual - NEW.cantidad WHERE id_producto = NEW.id_producto;
    END IF;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_ajustar_stock                  | CREATE OR REPLACE FUNCTION public.fn_ajustar_stock(p_id_producto character varying, p_tipo character varying, p_cantidad numeric, p_motivo character varying, p_observaciones text, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_movimiento VARCHAR;
    v_id_usuario VARCHAR;
BEGIN
    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_usuario_auditoria LIMIT 1;

    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'INVENTARIO', 'AJUSTE_STOCK',
        'Producto: ' || p_id_producto || ' | Tipo: ' || p_tipo || ' | Cant: ' || p_cantidad
    );
    
    v_id_movimiento := 'MOV-' || LPAD(nextval('movimientos_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.movimientos_inventario (
        id_movimiento, id_producto, tipo, cantidad, motivo, observaciones, id_usuario, fecha_hora
    ) VALUES (
        v_id_movimiento, p_id_producto, p_tipo, p_cantidad, p_motivo, p_observaciones, v_id_usuario, CURRENT_TIMESTAMP
    );

    RETURN v_id_movimiento;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| fn_generar_alertas_stock_bajo     | CREATE OR REPLACE FUNCTION public.fn_generar_alertas_stock_bajo()
 RETURNS TABLE(id_producto character varying, nombre character varying, stock_actual integer, stock_minimo integer, faltante integer, proveedor character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        p.id_producto, p.nombre, p.stock_actual, p.stock_minimo,
        (p.stock_minimo - p.stock_actual) as faltante,
        prov.razon_social as proveedor
    FROM public.productos p
    LEFT JOIN public.producto_proveedor pp ON p.id_producto = pp.id_producto
    LEFT JOIN public.proveedores prov ON pp.id_proveedor = prov.id_proveedor
    WHERE p.estado = 'ACTIVO'
      AND p.stock_actual <= p.stock_minimo
      AND p.stock_minimo > 0
    ORDER BY faltante DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| trg_crear_alerta_stock            | CREATE OR REPLACE FUNCTION public.trg_crear_alerta_stock()
 RETURNS trigger
 LANGUAGE plpgsql
AS $function$
BEGIN
    IF NEW.stock_actual <= NEW.stock_minimo AND NEW.stock_minimo > 0 THEN
        INSERT INTO public.alertas_stock (
            id_alerta, id_producto, tipo, mensaje, fecha_generada, estado
        ) VALUES (
            'ALERT-' || LPAD(nextval('alertas_seq')::VARCHAR, 3, '0'),
            NEW.id_producto, 'STOCK_MINIMO',
            'Stock bajo para producto ' || NEW.nombre || '. Stock actual: ' || NEW.stock_actual,
            CURRENT_TIMESTAMP, 'PENDIENTE'
        );
    END IF;
    RETURN NEW;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| fn_reporte_rentabilidad_producto  | CREATE OR REPLACE FUNCTION public.fn_reporte_rentabilidad_producto(p_fecha_inicio date, p_fecha_fin date)
 RETURNS TABLE(producto character varying, precio_costo numeric, precio_venta numeric, margen_unitario numeric, cantidad_vendida bigint, ganancia_total numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        p.nombre, p.precio_costo, p.precio_venta,
        (p.precio_venta - p.precio_costo) as margen,
        SUM(dv.cantidad)::BIGINT,
        SUM(dv.cantidad * (p.precio_venta - p.precio_costo))
    FROM public.detalle_ventas dv
    JOIN public.ventas v ON dv.id_venta = v.id_venta
    JOIN public.productos p ON dv.id_producto = p.id_producto
    WHERE v.estado = 'ACTIVO' AND DATE(v.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin
    GROUP BY p.id_producto, p.nombre, p.precio_costo, p.precio_venta
    ORDER BY SUM(dv.cantidad * (p.precio_venta - p.precio_costo)) DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fn_historial_asistencia           | CREATE OR REPLACE FUNCTION public.fn_historial_asistencia(p_id_empleado character varying, p_fecha_inicio date, p_fecha_fin date)
 RETURNS TABLE(fecha date, hora_entrada time without time zone, hora_salida time without time zone, tipo character varying, observaciones character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT a.fecha, a.hora_entrada, a.hora_salida, a.tipo, a.observaciones
    FROM public.asistencias a
    WHERE a.id_empleado = p_id_empleado
      AND a.fecha BETWEEN p_fecha_inicio AND p_fecha_fin
    ORDER BY a.fecha DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_registrar_auditoria_completa   | CREATE OR REPLACE FUNCTION public.fn_registrar_auditoria_completa(p_usuario character varying, p_modulo character varying, p_accion character varying, p_tabla_afectada character varying DEFAULT NULL::character varying, p_id_registro character varying DEFAULT NULL::character varying, p_valores_anteriores jsonb DEFAULT NULL::jsonb, p_valores_nuevos jsonb DEFAULT NULL::jsonb, p_detalles text DEFAULT NULL::text, p_ip_origen character varying DEFAULT NULL::character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_auditoria VARCHAR;
BEGIN
    v_id_auditoria := 'AUD-' || LPAD(nextval('auditoria_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.auditoria (
        id_auditoria, 
        fecha_hora, 
        usuario, 
        modulo, 
        accion, 
        tabla_afectada,
        id_registro_afectado,
        valores_anteriores,
        valores_nuevos,
        detalles, 
        ip_origen,
        estado
    ) VALUES (
        v_id_auditoria, 
        CURRENT_TIMESTAMP, 
        p_usuario, 
        p_modulo, 
        p_accion,
        p_tabla_afectada,
        p_id_registro,
        p_valores_anteriores,
        p_valores_nuevos,
        p_detalles, 
        COALESCE(p_ip_origen, inet_client_addr()::VARCHAR),
        'EXITOSO'
    );
    
    RETURN v_id_auditoria;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| fn_registrar_auditoria            | CREATE OR REPLACE FUNCTION public.fn_registrar_auditoria(p_usuario character varying, p_modulo character varying, p_accion character varying, p_detalles text)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Llama a la función completa con valores por defecto
    RETURN public.fn_registrar_auditoria_completa(
        p_usuario,
        p_modulo,
        p_accion,
        NULL,  -- tabla_afectada (se extrae del detalle si es posible)
        NULL,  -- id_registro
        NULL,  -- valores_anteriores
        NULL,  -- valores_nuevos
        p_detalles,
        NULL   -- ip_origen (se detecta automáticamente)
    );
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| fn_registrar_venta                | CREATE OR REPLACE FUNCTION public.fn_registrar_venta(p_id_cliente character varying, p_tipo_comprobante character varying, p_detalles jsonb, p_medio_pago character varying, p_monto_total numeric, p_monto_recibido numeric, p_username character varying, p_nit_cliente character varying DEFAULT NULL::character varying, p_razon_social character varying DEFAULT NULL::character varying, p_direccion_factura text DEFAULT NULL::text)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_venta VARCHAR;
    v_id_usuario VARCHAR;
    v_vuelto NUMERIC;
    v_numero_factura VARCHAR DEFAULT NULL;
    rec RECORD;
    v_new_data JSONB;
BEGIN
    IF p_monto_recibido < p_monto_total THEN
        RAISE EXCEPTION 'Monto recibido insuficiente. Faltan: %', (p_monto_total - p_monto_recibido);
    END IF;
    -- Validaciones para Factura
    IF p_tipo_comprobante = 'FACTURA' THEN
        IF p_nit_cliente IS NULL OR p_razon_social IS NULL THEN
            RAISE EXCEPTION 'Para emitir Factura, el NIT y Razón Social son obligatorios.';
        END IF;
        -- Generar número de factura: FAC-XXX-YYYY
        v_numero_factura := 'FAC-' || LPAD(nextval('facturas_seq')::VARCHAR, 3, '0') || '-' || TO_CHAR(CURRENT_DATE, 'YYYY');
    END IF;
    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_username;
    v_vuelto := p_monto_recibido - p_monto_total;
    
    v_id_venta := 'VENT-' || LPAD(nextval('ventas_seq')::VARCHAR, 3, '0');
    INSERT INTO public.ventas (
        id_venta, id_cliente, fecha_hora, total, tipo_comprobante, 
        id_usuario, estado, 
        nit_cliente, razon_social, direccion_factura, numero_factura
    ) VALUES (
        v_id_venta, p_id_cliente, CURRENT_TIMESTAMP, p_monto_total, p_tipo_comprobante, 
        v_id_usuario, 'ACTIVO',
        p_nit_cliente, p_razon_social, p_direccion_factura, v_numero_factura
    );
    FOR rec IN SELECT * FROM jsonb_to_recordset(p_detalles) AS x(
        id_producto VARCHAR, cantidad INTEGER, precio_unitario NUMERIC, descuento NUMERIC
    )
    LOOP
        INSERT INTO public.detalle_ventas (
            id_detalle_venta, id_venta, id_producto, cantidad, precio_unitario, descuento, subtotal
        ) VALUES (
            'DV-' || LPAD(nextval('detalle_ventas_seq')::VARCHAR, 3, '0'),
            v_id_venta, rec.id_producto, rec.cantidad, rec.precio_unitario,
            COALESCE(rec.descuento, 0),
            (rec.cantidad * rec.precio_unitario) - COALESCE(rec.descuento, 0)
        );
        INSERT INTO public.movimientos_inventario (
            id_movimiento, id_producto, tipo, cantidad, documento, id_usuario, fecha_hora
        ) VALUES (
            'MOV-' || LPAD(nextval('movimientos_seq')::VARCHAR, 3, '0'),
            rec.id_producto, 'SALIDA', rec.cantidad, v_id_venta, v_id_usuario, CURRENT_TIMESTAMP
        );
    END LOOP;
    INSERT INTO public.pagos (id_pago, id_venta, medio, importe, vuelto)
    VALUES ('PAG-' || LPAD(nextval('pagos_seq')::VARCHAR, 3, '0'), v_id_venta, p_medio_pago, p_monto_recibido, v_vuelto);
    -- Auditoría Completa
    v_new_data := jsonb_build_object(
        'id_venta', v_id_venta,
        'id_cliente', p_id_cliente,
        'tipo_comprobante', p_tipo_comprobante,
        'numero_factura', v_numero_factura,
        'total', p_monto_total,
        'medio_pago', p_medio_pago,
        'detalles_count', jsonb_array_length(p_detalles)
    );
    PERFORM public.fn_registrar_auditoria_completa(
        p_username, 'VENTAS', 'NUEVA_VENTA',
        'ventas', v_id_venta, NULL, v_new_data,
        'Venta registrada (' || p_tipo_comprobante || '). Total: ' || p_monto_total
    );
    RETURN v_id_venta;
END;
$function$
 |
| fn_alerta_stock_bajo              | CREATE OR REPLACE FUNCTION public.fn_alerta_stock_bajo()
 RETURNS TABLE(id_producto character varying, nombre character varying, stock_actual integer, stock_minimo integer, estado text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.id_producto,
        p.nombre,
        p.stock_actual,
        p.stock_minimo,
        CASE 
            WHEN p.stock_actual <= 0 THEN 'CRITICO'::text
            WHEN p.stock_actual <= p.stock_minimo THEN 'BAJO'::text
            ELSE 'NORMAL'::text
        END
    FROM public.productos p
    WHERE p.estado = 'ACTIVO' AND p.stock_actual <= p.stock_minimo;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_consultar_auditoria            | CREATE OR REPLACE FUNCTION public.fn_consultar_auditoria(p_fecha_inicio timestamp without time zone DEFAULT NULL::timestamp without time zone, p_fecha_fin timestamp without time zone DEFAULT NULL::timestamp without time zone, p_usuario character varying DEFAULT NULL::character varying, p_modulo character varying DEFAULT NULL::character varying, p_tabla character varying DEFAULT NULL::character varying, p_limite integer DEFAULT 100)
 RETURNS TABLE(id_auditoria character varying, fecha_hora timestamp without time zone, usuario character varying, modulo character varying, accion character varying, tabla_afectada character varying, id_registro_afectado character varying, detalles text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        a.id_auditoria,
        a.fecha_hora,
        a.usuario,
        a.modulo,
        a.accion,
        a.tabla_afectada,
        a.id_registro_afectado,
        a.detalles,
        a.estado
    FROM public.auditoria a
    WHERE (p_fecha_inicio IS NULL OR a.fecha_hora >= p_fecha_inicio)
      AND (p_fecha_fin IS NULL OR a.fecha_hora <= p_fecha_fin)
      AND (p_usuario IS NULL OR a.usuario ILIKE '%' || p_usuario || '%')
      AND (p_modulo IS NULL OR a.modulo = p_modulo)
      AND (p_tabla IS NULL OR a.tabla_afectada = p_tabla)
    ORDER BY a.fecha_hora DESC
    LIMIT p_limite;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_historial_registro             | CREATE OR REPLACE FUNCTION public.fn_historial_registro(p_tabla character varying, p_id_registro character varying)
 RETURNS TABLE(fecha_hora timestamp without time zone, usuario character varying, accion character varying, valores_anteriores jsonb, valores_nuevos jsonb, detalles text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        a.fecha_hora,
        a.usuario,
        a.accion,
        a.valores_anteriores,
        a.valores_nuevos,
        a.detalles
    FROM public.auditoria a
    WHERE a.tabla_afectada = p_tabla
      AND a.id_registro_afectado = p_id_registro
    ORDER BY a.fecha_hora DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| fn_autenticar_usuario             | CREATE OR REPLACE FUNCTION public.fn_autenticar_usuario(p_username character varying, p_password_hash character varying)
 RETURNS TABLE(usuario_id character varying, username character varying, empleado_id character varying, rol_nombre character varying, cargo_nombre character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        u.id_usuario,
        u.username,
        u.id_empleado,
        r.nombre as rol_nombre,
        c.nombre as cargo_nombre
    FROM public.usuarios u
    JOIN public.roles r ON u.id_rol = r.id_rol
    JOIN public.empleados e ON u.id_empleado = e.id_empleado
    JOIN public.cargos c ON e.id_cargo = c.id_cargo
    WHERE u.username = p_username 
      AND u.password_hash = p_password_hash
      AND u.estado = 'ACTIVO'
      AND e.estado = 'ACTIVO';
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_crear_usuario                  | CREATE OR REPLACE FUNCTION public.fn_crear_usuario(p_empleado_id character varying, p_username character varying, p_password_hash character varying, p_rol_id character varying, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    IF EXISTS (SELECT 1 FROM public.usuarios WHERE username = p_username) THEN
        RAISE EXCEPTION 'El usuario % ya existe.', p_username;
    END IF;

    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'SEGURIDAD', 'CREAR_USUARIO', 
        'Usuario: ' || p_username
    );
    
    v_id := 'USR-' || LPAD(nextval('usuarios_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.usuarios (
        id_usuario, id_empleado, username, password_hash, 
        id_rol, estado, fecha_registro
    ) VALUES (
        v_id, p_empleado_id, p_username, p_password_hash,
        p_rol_id, 'ACTIVO', CURRENT_TIMESTAMP
    );

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| fn_editar_usuario                 | CREATE OR REPLACE FUNCTION public.fn_editar_usuario(p_id_usuario character varying, p_password_hash character varying, p_rol_id character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'SEGURIDAD', 'EDITAR_USUARIO',
        'Usuario ID: ' || p_id_usuario
    );

    UPDATE public.usuarios
    SET 
        password_hash = COALESCE(p_password_hash, password_hash),
        id_rol = COALESCE(p_rol_id, id_rol)
    WHERE id_usuario = p_id_usuario;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_desactivar_usuario             | CREATE OR REPLACE FUNCTION public.fn_desactivar_usuario(p_id_usuario character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'SEGURIDAD', 'DESACTIVAR_USUARIO',
        'Usuario ID: ' || p_id_usuario
    );

    UPDATE public.usuarios SET estado = 'INACTIVO' WHERE id_usuario = p_id_usuario;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_listar_usuarios                | CREATE OR REPLACE FUNCTION public.fn_listar_usuarios()
 RETURNS TABLE(id_usuario character varying, username character varying, empleado_nombre character varying, rol_nombre character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        u.id_usuario,
        u.username,
        (e.nombres || ' ' || e.apellido_paterno)::VARCHAR as empleado_nombre,
        r.nombre as rol_nombre,
        u.estado
    FROM public.usuarios u
    LEFT JOIN public.empleados e ON u.id_empleado = e.id_empleado
    LEFT JOIN public.roles r ON u.id_rol = r.id_rol
    ORDER BY u.fecha_registro DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| fn_crear_rol                      | CREATE OR REPLACE FUNCTION public.fn_crear_rol(p_nombre character varying, p_descripcion text, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'SEGURIDAD', 'CREAR_ROL',
        'Rol: ' || p_nombre
    );
    
    v_id := 'ROL-' || LPAD(nextval('roles_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.roles (id_rol, nombre, descripcion, estado, fecha_registro)
    VALUES (v_id, p_nombre, p_descripcion, 'ACTIVO', CURRENT_TIMESTAMP);

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_crear_producto                 | CREATE OR REPLACE FUNCTION public.fn_crear_producto(p_codigo_interno character varying, p_codigo_barras character varying, p_nombre character varying, p_id_categoria character varying, p_marca character varying, p_precio_costo numeric, p_precio_venta numeric, p_stock_minimo integer, p_stock_maximo integer, p_unidad_medida character varying, p_controla_vencimiento boolean, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    IF EXISTS (SELECT 1 FROM public.productos WHERE codigo_interno = p_codigo_interno) THEN
        RAISE EXCEPTION 'El código interno % ya existe.', p_codigo_interno;
    END IF;

    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'PRODUCTOS', 'CREAR',
        'Producto: ' || p_nombre || ' | Cod: ' || p_codigo_interno
    );
    
    v_id := 'PROD-' || LPAD(nextval('productos_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.productos (
        id_producto, codigo_interno, codigo_barras, nombre, id_categoria, marca,
        precio_costo, precio_venta, stock_minimo, stock_maximo, stock_actual,
        unidad_medida, controla_vencimiento, estado, fecha_registro
    ) VALUES (
        v_id, p_codigo_interno, p_codigo_barras, p_nombre, p_id_categoria, p_marca,
        p_precio_costo, p_precio_venta, p_stock_minimo, p_stock_maximo, 0,
        p_unidad_medida, p_controla_vencimiento, 'ACTIVO', CURRENT_TIMESTAMP
    );

    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_editar_producto                | CREATE OR REPLACE FUNCTION public.fn_editar_producto(p_id_producto character varying, p_codigo_barras character varying, p_nombre character varying, p_id_categoria character varying, p_marca character varying, p_precio_costo numeric, p_precio_venta numeric, p_stock_minimo integer, p_stock_maximo integer, p_unidad_medida character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'PRODUCTOS', 'EDITAR',
        'Producto ID: ' || p_id_producto
    );

    UPDATE public.productos
    SET 
        codigo_barras = COALESCE(p_codigo_barras, codigo_barras),
        nombre = COALESCE(p_nombre, nombre),
        id_categoria = COALESCE(p_id_categoria, id_categoria),
        marca = COALESCE(p_marca, marca),
        precio_costo = COALESCE(p_precio_costo, precio_costo),
        precio_venta = COALESCE(p_precio_venta, precio_venta),
        stock_minimo = COALESCE(p_stock_minimo, stock_minimo),
        stock_maximo = COALESCE(p_stock_maximo, stock_maximo),
        unidad_medida = COALESCE(p_unidad_medida, unidad_medida)
    WHERE id_producto = p_id_producto;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_desactivar_producto            | CREATE OR REPLACE FUNCTION public.fn_desactivar_producto(p_id_producto character varying, p_motivo character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'PRODUCTOS', 'DESACTIVAR',
        'Producto ID: ' || p_id_producto || ' | Motivo: ' || p_motivo
    );

    UPDATE public.productos
    SET estado = 'INACTIVO', motivo_desactivacion = p_motivo
    WHERE id_producto = p_id_producto;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| fn_buscar_producto                | CREATE OR REPLACE FUNCTION public.fn_buscar_producto(p_busqueda character varying)
 RETURNS TABLE(id_producto character varying, codigo_interno character varying, nombre character varying, precio_venta numeric, stock_actual integer, estado_stock character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY 
    SELECT 
        p.id_producto, p.codigo_interno, p.nombre, p.precio_venta, p.stock_actual,
        CASE 
            WHEN p.stock_actual = 0 THEN 'AGOTADO'
            WHEN p.stock_actual <= p.stock_minimo THEN 'BAJO'
            ELSE 'DISPONIBLE'
        END as estado_stock
    FROM public.productos p
    WHERE p.estado = 'ACTIVO'
      AND (p.codigo_interno ILIKE '%' || p_busqueda || '%'
        OR p.nombre ILIKE '%' || p_busqueda || '%'
        OR p.codigo_barras ILIKE '%' || p_busqueda || '%')
    ORDER BY p.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_editar_proveedor               | CREATE OR REPLACE FUNCTION public.fn_editar_proveedor(p_id_proveedor character varying, p_razon_social character varying, p_telefono character varying, p_celular_contacto character varying, p_email character varying, p_direccion text, p_nombre_contacto character varying, p_plazo_credito integer, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'COMPRAS', 'EDITAR_PROVEEDOR',
        'Proveedor ID: ' || p_id_proveedor
    );

    UPDATE public.proveedores
    SET 
        razon_social = COALESCE(p_razon_social, razon_social),
        telefono = COALESCE(p_telefono, telefono),
        celular_contacto = COALESCE(p_celular_contacto, celular_contacto),
        email = COALESCE(p_email, email),
        direccion = COALESCE(p_direccion, direccion),
        nombre_contacto = COALESCE(p_nombre_contacto, nombre_contacto),
        plazo_credito = COALESCE(p_plazo_credito, plazo_credito)
    WHERE id_proveedor = p_id_proveedor;

    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_desactivar_proveedor           | CREATE OR REPLACE FUNCTION public.fn_desactivar_proveedor(p_id_proveedor character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'COMPRAS', 'DESACTIVAR_PROVEEDOR',
        'Proveedor ID: ' || p_id_proveedor
    );

    UPDATE public.proveedores SET estado = 'INACTIVO' WHERE id_proveedor = p_id_proveedor;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_obtener_producto_por_id        | CREATE OR REPLACE FUNCTION public.fn_obtener_producto_por_id(p_id character varying)
 RETURNS TABLE(id_producto character varying, codigo_interno character varying, codigo_barras character varying, nombre character varying, id_categoria character varying, categoria character varying, marca character varying, precio_costo numeric, precio_venta numeric, stock_actual integer, stock_minimo integer, stock_maximo integer, unidad_medida character varying, controla_vencimiento boolean, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT p.id_producto, p.codigo_interno, p.codigo_barras, p.nombre,
           p.id_categoria, c.nombre as categoria, p.marca,
           p.precio_costo, p.precio_venta, p.stock_actual,
           p.stock_minimo, p.stock_maximo, p.unidad_medida,
           p.controla_vencimiento, p.estado
    FROM public.productos p
    LEFT JOIN public.categorias c ON p.id_categoria = c.id_categoria
    WHERE p.id_producto = p_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| fn_obtener_datos_usuario          | CREATE OR REPLACE FUNCTION public.fn_obtener_datos_usuario(p_usuario_id character varying)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_result JSONB;
BEGIN
    SELECT jsonb_build_object(
        'usuario_id', u.id_usuario,
        'username', u.username,
        'estado', u.estado,
        'rol_id', u.id_rol,
        'rol', r.nombre,
        'empleado', jsonb_build_object(
            'id', e.id_empleado,
            'ci', e.ci,
            'expedido', e.expedido,
            'nombres', e.nombres,
            'apellido_paterno', e.apellido_paterno,
            'apellido_materno', e.apellido_materno,
            'email', e.email,
            'telefono', e.telefono,
            'celular', e.celular,
            'cargo_id', e.id_cargo,
            'salario', e.salario
        ),
        'cargo', c.nombre
    ) INTO v_result
    FROM public.usuarios u
    LEFT JOIN public.roles r ON u.id_rol = r.id_rol
    LEFT JOIN public.empleados e ON u.id_empleado = e.id_empleado
    LEFT JOIN public.cargos c ON e.id_cargo = c.id_cargo
    WHERE u.id_usuario = p_usuario_id;
    
    RETURN v_result;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_leer_categorias                | CREATE OR REPLACE FUNCTION public.fn_leer_categorias()
 RETURNS TABLE(id character varying, nombre character varying, descripcion text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT c.id_categoria, c.nombre, c.descripcion, c.estado
    FROM public.categorias c
    WHERE c.estado = 'ACTIVO'
    ORDER BY c.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_actualizar_producto            | CREATE OR REPLACE FUNCTION public.fn_actualizar_producto(p_id character varying, p_codigo_barras character varying DEFAULT NULL::character varying, p_nombre character varying DEFAULT NULL::character varying, p_categoria_id character varying DEFAULT NULL::character varying, p_marca character varying DEFAULT NULL::character varying, p_proveedor_id character varying DEFAULT NULL::character varying, p_precio_costo numeric DEFAULT NULL::numeric, p_precio_venta numeric DEFAULT NULL::numeric, p_stock_minimo integer DEFAULT NULL::integer, p_stock_maximo integer DEFAULT NULL::integer, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'PRODUCTOS', 'ACTUALIZAR',
        'Producto: ' || p_id
    );
    
    UPDATE public.productos SET
        codigo_barras = COALESCE(p_codigo_barras, codigo_barras),
        nombre = COALESCE(p_nombre, nombre),
        id_categoria = COALESCE(p_categoria_id, id_categoria),
        marca = COALESCE(p_marca, marca),
        precio_costo = COALESCE(p_precio_costo, precio_costo),
        precio_venta = COALESCE(p_precio_venta, precio_venta),
        stock_minimo = COALESCE(p_stock_minimo, stock_minimo),
        stock_maximo = COALESCE(p_stock_maximo, stock_maximo)
    WHERE id_producto = p_id;
    
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_eliminar_producto              | CREATE OR REPLACE FUNCTION public.fn_eliminar_producto(p_id character varying, p_motivo character varying DEFAULT 'Eliminado por usuario'::character varying, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'PRODUCTOS', 'ELIMINAR',
        'Producto: ' || p_id || ' | Motivo: ' || p_motivo
    );
    
    UPDATE public.productos 
    SET estado = 'INACTIVO', motivo_desactivacion = p_motivo
    WHERE id_producto = p_id;
    
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| fn_leer_clientes                  | CREATE OR REPLACE FUNCTION public.fn_leer_clientes(p_buscar character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id character varying, nombres character varying, apellido_paterno character varying, ci_nit character varying, telefono character varying, email character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT c.id_cliente, c.nombres, c.apellido_paterno, c.ci_nit, c.telefono, c.email, c.estado
    FROM public.clientes c
    WHERE c.estado = 'ACTIVO'
      AND (p_buscar IS NULL OR c.nombres ILIKE '%' || p_buscar || '%' OR c.ci_nit ILIKE '%' || p_buscar || '%')
    ORDER BY c.nombres;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_leer_empleados                 | CREATE OR REPLACE FUNCTION public.fn_leer_empleados(p_buscar character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id character varying, ci character varying, nombres character varying, apellido_paterno character varying, cargo character varying, telefono character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT e.id_empleado, e.ci, e.nombres, e.apellido_paterno, c.nombre as cargo, e.telefono, e.estado
    FROM public.empleados e
    LEFT JOIN public.cargos c ON e.id_cargo = c.id_cargo
    WHERE e.estado = 'ACTIVO'
      AND (p_buscar IS NULL OR e.nombres ILIKE '%' || p_buscar || '%' OR e.ci ILIKE '%' || p_buscar || '%')
    ORDER BY e.nombres;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_leer_roles                     | CREATE OR REPLACE FUNCTION public.fn_leer_roles()
 RETURNS TABLE(id character varying, nombre character varying, descripcion text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT r.id_rol, r.nombre, r.descripcion, r.estado
    FROM public.roles r
    WHERE r.estado = 'ACTIVO'
    ORDER BY r.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_leer_cargos                    | CREATE OR REPLACE FUNCTION public.fn_leer_cargos()
 RETURNS TABLE(id character varying, nombre character varying, descripcion text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT c.id_cargo, c.nombre, c.descripcion
    FROM public.cargos c
    ORDER BY c.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_leer_horarios                  | CREATE OR REPLACE FUNCTION public.fn_leer_horarios()
 RETURNS TABLE(id character varying, nombre character varying, hora_entrada time without time zone, hora_salida time without time zone)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT h.id_horario, h.nombre, h.hora_entrada, h.hora_salida
    FROM public.horarios h
    ORDER BY h.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_leer_ventas                    | CREATE OR REPLACE FUNCTION public.fn_leer_ventas(p_fecha date DEFAULT NULL::date)
 RETURNS TABLE(id character varying, cliente character varying, fecha_hora timestamp without time zone, total numeric, tipo_comprobante character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT v.id_venta, COALESCE(c.nombres, 'Consumidor Final') as cliente, 
           v.fecha_hora, v.total, v.tipo_comprobante, v.estado
    FROM public.ventas v
    LEFT JOIN public.clientes c ON v.id_cliente = c.id_cliente
    WHERE (p_fecha IS NULL OR DATE(v.fecha_hora) = p_fecha)
    ORDER BY v.fecha_hora DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_leer_ordenes_compra            | CREATE OR REPLACE FUNCTION public.fn_leer_ordenes_compra(p_estado character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id character varying, proveedor character varying, fecha_emision date, total numeric, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT oc.id_orden, p.razon_social, oc.fecha_emision, oc.total, oc.estado
    FROM public.ordenes_compra oc
    JOIN public.proveedores p ON oc.id_proveedor = p.id_proveedor
    WHERE (p_estado IS NULL OR oc.estado = p_estado)
    ORDER BY oc.fecha_emision DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_leer_alertas_stock             | CREATE OR REPLACE FUNCTION public.fn_leer_alertas_stock()
 RETURNS TABLE(id character varying, producto character varying, tipo character varying, mensaje text, fecha timestamp without time zone, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT a.id_alerta, p.nombre, a.tipo, a.mensaje, a.fecha_generada, a.estado
    FROM public.alertas_stock a
    JOIN public.productos p ON a.id_producto = p.id_producto
    WHERE a.estado = 'PENDIENTE'
    ORDER BY a.fecha_generada DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_dashboard_estadisticas         | CREATE OR REPLACE FUNCTION public.fn_dashboard_estadisticas()
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_result JSONB;
BEGIN
    SELECT jsonb_build_object(
        'total_productos', (SELECT COUNT(*) FROM productos WHERE estado = 'ACTIVO'),
        'productos_bajo_stock', (SELECT COUNT(*) FROM productos WHERE estado = 'ACTIVO' AND stock_actual <= stock_minimo),
        'total_clientes', (SELECT COUNT(*) FROM clientes WHERE estado = 'ACTIVO'),
        'total_proveedores', (SELECT COUNT(*) FROM proveedores WHERE estado = 'ACTIVO'),
        'ventas_hoy', (SELECT COALESCE(SUM(total), 0) FROM ventas WHERE DATE(fecha_hora) = CURRENT_DATE AND estado = 'ACTIVO'),
        'ventas_mes', (SELECT COALESCE(SUM(total), 0) FROM ventas WHERE DATE_TRUNC('month', fecha_hora) = DATE_TRUNC('month', CURRENT_DATE) AND estado = 'ACTIVO'),
        'cantidad_ventas_hoy', (SELECT COUNT(*) FROM ventas WHERE DATE(fecha_hora) = CURRENT_DATE AND estado = 'ACTIVO'),
        'alertas_pendientes', (SELECT COUNT(*) FROM alertas_stock WHERE estado = 'PENDIENTE')
    ) INTO v_result;
    
    RETURN v_result;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| fn_actualizar_categoria           | CREATE OR REPLACE FUNCTION public.fn_actualizar_categoria(p_id character varying, p_nombre character varying, p_descripcion text DEFAULT NULL::text, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CATEGORIAS', 'ACTUALIZAR',
        'Categoría: ' || p_id
    );
    
    UPDATE public.categorias SET
        nombre = COALESCE(p_nombre, nombre),
        descripcion = COALESCE(p_descripcion, descripcion)
    WHERE id_categoria = p_id;
    
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_eliminar_categoria             | CREATE OR REPLACE FUNCTION public.fn_eliminar_categoria(p_id character varying, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Verificar si tiene productos asociados
    IF EXISTS (SELECT 1 FROM productos WHERE id_categoria = p_id AND estado = 'ACTIVO') THEN
        RAISE EXCEPTION 'No se puede eliminar: tiene productos asociados';
    END IF;
    
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CATEGORIAS', 'ELIMINAR',
        'Categoría: ' || p_id
    );
    
    UPDATE public.categorias SET estado = 'INACTIVO' WHERE id_categoria = p_id;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| fn_actualizar_cliente             | CREATE OR REPLACE FUNCTION public.fn_actualizar_cliente(p_id character varying, p_nombres character varying DEFAULT NULL::character varying, p_apellido_paterno character varying DEFAULT NULL::character varying, p_apellido_materno character varying DEFAULT NULL::character varying, p_ci_nit character varying DEFAULT NULL::character varying, p_telefono character varying DEFAULT NULL::character varying, p_email character varying DEFAULT NULL::character varying, p_direccion character varying DEFAULT NULL::character varying, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    -- Verificar CI/NIT único
    IF p_ci_nit IS NOT NULL AND EXISTS (
        SELECT 1 FROM clientes WHERE ci_nit = p_ci_nit AND id_cliente != p_id AND estado = 'ACTIVO'
    ) THEN
        RAISE EXCEPTION 'El CI/NIT ya está registrado para otro cliente';
    END IF;
    
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CLIENTES', 'ACTUALIZAR',
        'Cliente: ' || p_id
    );
    
    UPDATE public.clientes SET
        nombres = COALESCE(p_nombres, nombres),
        apellido_paterno = COALESCE(p_apellido_paterno, apellido_paterno),
        apellido_materno = COALESCE(p_apellido_materno, apellido_materno),
        ci_nit = COALESCE(p_ci_nit, ci_nit),
        telefono = COALESCE(p_telefono, telefono),
        email = COALESCE(p_email, email),
        direccion = COALESCE(p_direccion, direccion)
    WHERE id_cliente = p_id;
    
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| fn_eliminar_cliente               | CREATE OR REPLACE FUNCTION public.fn_eliminar_cliente(p_id character varying, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'CLIENTES', 'ELIMINAR',
        'Cliente: ' || p_id
    );
    
    UPDATE public.clientes SET estado = 'INACTIVO' WHERE id_cliente = p_id;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_actualizar_empleado            | CREATE OR REPLACE FUNCTION public.fn_actualizar_empleado(p_id character varying, p_telefono character varying DEFAULT NULL::character varying, p_celular character varying DEFAULT NULL::character varying, p_email character varying DEFAULT NULL::character varying, p_direccion character varying DEFAULT NULL::character varying, p_id_cargo character varying DEFAULT NULL::character varying, p_id_horario character varying DEFAULT NULL::character varying, p_salario numeric DEFAULT NULL::numeric, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'EMPLEADOS', 'ACTUALIZAR',
        'Empleado: ' || p_id
    );
    
    UPDATE public.empleados SET
        telefono = COALESCE(p_telefono, telefono),
        celular = COALESCE(p_celular, celular),
        email = COALESCE(p_email, email),
        direccion = COALESCE(p_direccion, direccion),
        id_cargo = COALESCE(p_id_cargo, id_cargo),
        id_horario = COALESCE(p_id_horario, id_horario),
        salario = COALESCE(p_salario, salario)
    WHERE id_empleado = p_id;
    
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_eliminar_empleado              | CREATE OR REPLACE FUNCTION public.fn_eliminar_empleado(p_id character varying, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
BEGIN
    PERFORM public.fn_registrar_auditoria(
        p_usuario_auditoria, 'EMPLEADOS', 'ELIMINAR',
        'Empleado: ' || p_id
    );
    
    UPDATE public.empleados SET estado = 'INACTIVO' WHERE id_empleado = p_id;
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_editar_categoria               | CREATE OR REPLACE FUNCTION public.fn_editar_categoria(p_id_categoria character varying, p_nombre character varying, p_descripcion text, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_old_data JSONB;
    v_new_data JSONB;
BEGIN
    -- Obtener valores anteriores
    SELECT to_jsonb(t) INTO v_old_data 
    FROM public.categorias t 
    WHERE id_categoria = p_id_categoria;
    IF v_old_data IS NULL THEN
        RAISE EXCEPTION 'Categoría no encontrada: %', p_id_categoria;
    END IF;
    -- Actualizar registro
    UPDATE public.categorias
    SET nombre = COALESCE(p_nombre, nombre),
        descripcion = COALESCE(p_descripcion, descripcion)
    WHERE id_categoria = p_id_categoria;
    -- Preparar nuevos datos (post-update)
    v_new_data := jsonb_build_object(
        'id_categoria', p_id_categoria,
        'nombre', COALESCE(p_nombre, v_old_data->>'nombre'),
        'descripcion', COALESCE(p_descripcion, v_old_data->>'descripcion')
    );
    -- Registrar auditoría
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria,
        'PRODUCTOS',
        'EDITAR_CATEGORIA',
        'categorias',
        p_id_categoria,
        v_old_data,     -- Valores anteriores
        v_new_data,     -- Valores nuevos
        'Actualización de categoría: ' || p_nombre
    );
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_desactivar_categoria           | CREATE OR REPLACE FUNCTION public.fn_desactivar_categoria(p_id_categoria character varying, p_usuario_auditoria character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_old_data JSONB;
BEGIN
    -- Obtener valores anteriores
    SELECT to_jsonb(t) INTO v_old_data 
    FROM public.categorias t 
    WHERE id_categoria = p_id_categoria;
    IF v_old_data IS NULL THEN
        RAISE EXCEPTION 'Categoría no encontrada: %', p_id_categoria;
    END IF;
    -- Actualizar estado
    UPDATE public.categorias SET estado = 'INACTIVO' WHERE id_categoria = p_id_categoria;
    -- Registrar auditoría
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria,
        'PRODUCTOS',
        'DESACTIVAR_CATEGORIA',
        'categorias',
        p_id_categoria,
        v_old_data,  -- Valores anteriores
        jsonb_build_object('estado', 'INACTIVO'), -- Valores nuevos (solo lo que cambió)
        'Desactivación de categoría'
    );
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_crear_proveedor                | CREATE OR REPLACE FUNCTION public.fn_crear_proveedor(p_razon_social character varying, p_nit_ci character varying, p_telefono character varying, p_celular_contacto character varying, p_email character varying, p_direccion text, p_nombre_contacto character varying, p_plazo_credito integer, p_usuario_auditoria character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
    v_new_data JSONB;
BEGIN
    IF EXISTS (SELECT 1 FROM public.proveedores WHERE nit_ci = p_nit_ci) THEN
        RAISE EXCEPTION 'El NIT/CI % ya existe.', p_nit_ci;
    END IF;
    v_id := 'PROV-' || LPAD(nextval('proveedores_seq')::VARCHAR, 3, '0');
    
    INSERT INTO public.proveedores (
        id_proveedor, razon_social, nit_ci, telefono, celular_contacto,
        email, direccion, nombre_contacto, plazo_credito, estado, fecha_registro
    ) VALUES (
        v_id, p_razon_social, p_nit_ci, p_telefono, p_celular_contacto,
        p_email, p_direccion, p_nombre_contacto, COALESCE(p_plazo_credito, 0),
        'ACTIVO', CURRENT_TIMESTAMP
    );
    v_new_data := jsonb_build_object(
        'id_proveedor', v_id,
        'razon_social', p_razon_social,
        'nit_ci', p_nit_ci,
        'telefono', p_telefono,
        'celular_contacto', p_celular_contacto,
        'email', p_email,
        'direccion', p_direccion,
        'nombre_contacto', p_nombre_contacto,
        'plazo_credito', COALESCE(p_plazo_credito, 0),
        'estado', 'ACTIVO'
    );
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria, 'COMPRAS', 'CREAR_PROVEEDOR',
        'proveedores', v_id, NULL, v_new_data,
        'Proveedor: ' || p_razon_social
    );
    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| fn_actualizar_proveedor           | CREATE OR REPLACE FUNCTION public.fn_actualizar_proveedor(p_id_proveedor character varying, p_razon_social character varying DEFAULT NULL::character varying, p_nit_ci character varying DEFAULT NULL::character varying, p_telefono character varying DEFAULT NULL::character varying, p_celular_contacto character varying DEFAULT NULL::character varying, p_email character varying DEFAULT NULL::character varying, p_direccion character varying DEFAULT NULL::character varying, p_nombre_contacto character varying DEFAULT NULL::character varying, p_plazo_credito integer DEFAULT NULL::integer, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_old_data JSONB;
    v_new_data JSONB;
BEGIN
    SELECT to_jsonb(t) INTO v_old_data FROM public.proveedores t WHERE id_proveedor = p_id_proveedor;
    
    IF v_old_data IS NULL THEN
        RAISE EXCEPTION 'Proveedor no encontrado: %', p_id_proveedor;
    END IF;
    UPDATE public.proveedores
    SET 
        razon_social = COALESCE(p_razon_social, razon_social),
        nit_ci = COALESCE(p_nit_ci, nit_ci),
        telefono = COALESCE(p_telefono, telefono),
        celular_contacto = COALESCE(p_celular_contacto, celular_contacto),
        email = COALESCE(p_email, email),
        direccion = COALESCE(p_direccion, direccion),
        nombre_contacto = COALESCE(p_nombre_contacto, nombre_contacto),
        plazo_credito = COALESCE(p_plazo_credito, plazo_credito)
    WHERE id_proveedor = p_id_proveedor;
    v_new_data := jsonb_build_object(
        'id_proveedor', p_id_proveedor,
        'razon_social', COALESCE(p_razon_social, v_old_data->>'razon_social'),
        'nit_ci', COALESCE(p_nit_ci, v_old_data->>'nit_ci'),
        'telefono', COALESCE(p_telefono, v_old_data->>'telefono'),
        'celular_contacto', COALESCE(p_celular_contacto, v_old_data->>'celular_contacto'),
        'email', COALESCE(p_email, v_old_data->>'email'),
        'direccion', COALESCE(p_direccion, v_old_data->>'direccion'),
        'nombre_contacto', COALESCE(p_nombre_contacto, v_old_data->>'nombre_contacto'),
        'plazo_credito', COALESCE(p_plazo_credito, (v_old_data->>'plazo_credito')::int)
    );
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria, 'COMPRAS', 'ACTUALIZAR_PROVEEDOR',
        'proveedores', p_id_proveedor, v_old_data, v_new_data,
        'Proveedor actualizado: ' || COALESCE(p_razon_social, v_old_data->>'razon_social')
    );
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| fn_eliminar_proveedor             | CREATE OR REPLACE FUNCTION public.fn_eliminar_proveedor(p_id_proveedor character varying, p_usuario_auditoria character varying DEFAULT 'admin'::character varying)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_old_data JSONB;
BEGIN
    SELECT to_jsonb(t) INTO v_old_data FROM public.proveedores t WHERE id_proveedor = p_id_proveedor;
    IF v_old_data IS NULL THEN
        RAISE EXCEPTION 'Proveedor no encontrado: %', p_id_proveedor;
    END IF;
    UPDATE public.proveedores SET estado = 'INACTIVO' WHERE id_proveedor = p_id_proveedor;
    
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria, 'COMPRAS', 'ELIMINAR_PROVEEDOR',
        'proveedores', p_id_proveedor, v_old_data, 
        jsonb_build_object('estado', 'INACTIVO'),
        'Proveedor desactivado: ' || p_id_proveedor
    );
    RETURN FOUND;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_leer_proveedores               | CREATE OR REPLACE FUNCTION public.fn_leer_proveedores(p_buscar_texto character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id character varying, razon_social character varying, nit_ci character varying, telefono character varying, email character varying, nombre_contacto character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT p.id_proveedor, p.razon_social, p.nit_ci, p.telefono, p.email, p.nombre_contacto, p.estado
    FROM public.proveedores p
    WHERE p.estado = 'ACTIVO'
      AND (p_buscar_texto IS NULL OR p.razon_social ILIKE '%' || p_buscar_texto || '%')
    ORDER BY p.razon_social;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_registrar_venta                | CREATE OR REPLACE FUNCTION public.fn_registrar_venta(p_id_cliente character varying, p_tipo_comprobante character varying, p_detalles jsonb, p_medio_pago character varying, p_monto_total numeric, p_monto_recibido numeric, p_username character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_venta VARCHAR;
    v_id_usuario VARCHAR;
    v_vuelto NUMERIC;
    rec RECORD;
    v_new_data JSONB;
BEGIN
    IF p_monto_recibido < p_monto_total THEN
        RAISE EXCEPTION 'Monto recibido insuficiente. Faltan: %', (p_monto_total - p_monto_recibido);
    END IF;
    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_username;
    v_vuelto := p_monto_recibido - p_monto_total;
    
    v_id_venta := 'VENT-' || LPAD(nextval('ventas_seq')::VARCHAR, 3, '0');
    INSERT INTO public.ventas (
        id_venta, id_cliente, fecha_hora, total, tipo_comprobante, id_usuario, estado
    ) VALUES (
        v_id_venta, p_id_cliente, CURRENT_TIMESTAMP, p_monto_total, p_tipo_comprobante, v_id_usuario, 'ACTIVO'
    );
    FOR rec IN SELECT * FROM jsonb_to_recordset(p_detalles) AS x(
        id_producto VARCHAR, cantidad INTEGER, precio_unitario NUMERIC, descuento NUMERIC
    )
    LOOP
        INSERT INTO public.detalle_ventas (
            id_detalle_venta, id_venta, id_producto, cantidad, precio_unitario, descuento, subtotal
        ) VALUES (
            'DV-' || LPAD(nextval('detalle_ventas_seq')::VARCHAR, 3, '0'),
            v_id_venta, rec.id_producto, rec.cantidad, rec.precio_unitario,
            COALESCE(rec.descuento, 0),
            (rec.cantidad * rec.precio_unitario) - COALESCE(rec.descuento, 0)
        );
        INSERT INTO public.movimientos_inventario (
            id_movimiento, id_producto, tipo, cantidad, documento, id_usuario, fecha_hora
        ) VALUES (
            'MOV-' || LPAD(nextval('movimientos_seq')::VARCHAR, 3, '0'),
            rec.id_producto, 'SALIDA', rec.cantidad, v_id_venta, v_id_usuario, CURRENT_TIMESTAMP
        );
    END LOOP;
    INSERT INTO public.pagos (id_pago, id_venta, medio, importe, vuelto)
    VALUES ('PAG-' || LPAD(nextval('pagos_seq')::VARCHAR, 3, '0'), v_id_venta, p_medio_pago, p_monto_recibido, v_vuelto);
    -- Auditoría Completa
    v_new_data := jsonb_build_object(
        'id_venta', v_id_venta,
        'id_cliente', p_id_cliente,
        'tipo_comprobante', p_tipo_comprobante,
        'total', p_monto_total,
        'medio_pago', p_medio_pago,
        'detalles_count', jsonb_array_length(p_detalles)
    );
    PERFORM public.fn_registrar_auditoria_completa(
        p_username, 'VENTAS', 'NUEVA_VENTA',
        'ventas', v_id_venta, NULL, v_new_data,
        'Venta registrada. Total: ' || p_monto_total
    );
    RETURN v_id_venta;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_devolucion_venta               | CREATE OR REPLACE FUNCTION public.fn_devolucion_venta(p_id_venta character varying, p_motivo character varying, p_forma_reembolso character varying, p_username character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id_devolucion VARCHAR;
    v_id_usuario VARCHAR;
    rec RECORD;
    v_venta_data JSONB;
BEGIN
    SELECT id_usuario INTO v_id_usuario FROM usuarios WHERE username = p_username;
    
    -- Obtener datos de la venta para auditoría (valores anteriores)
    SELECT to_jsonb(v) INTO v_venta_data FROM ventas v WHERE id_venta = p_id_venta;
    v_id_devolucion := 'DEV-V-' || LPAD(nextval('devoluciones_venta_seq')::VARCHAR, 3, '0');
    INSERT INTO public.devoluciones_ventas (
        id_devolucion_venta, id_venta, motivo, forma_reembolso, fecha, id_usuario
    ) VALUES (
        v_id_devolucion, p_id_venta, p_motivo, p_forma_reembolso, CURRENT_TIMESTAMP, v_id_usuario
    );
    -- Devolver stock
    FOR rec IN SELECT dv.id_producto, dv.cantidad FROM detalle_ventas dv WHERE dv.id_venta = p_id_venta
    LOOP
        INSERT INTO public.movimientos_inventario (
            id_movimiento, id_producto, tipo, cantidad, documento, motivo, id_usuario, fecha_hora
        ) VALUES (
            'MOV-' || LPAD(nextval('movimientos_seq')::VARCHAR, 3, '0'),
            rec.id_producto, 'ENTRADA', rec.cantidad, v_id_devolucion, 'DEVOLUCION_VENTA', v_id_usuario, CURRENT_TIMESTAMP
        );
    END LOOP;
    UPDATE public.ventas SET estado = 'ANULADO' WHERE id_venta = p_id_venta;
    -- Auditoría Completa
    PERFORM public.fn_registrar_auditoria_completa(
        p_username, 'VENTAS', 'DEVOLUCION',
        'ventas', p_id_venta, v_venta_data, 
        jsonb_build_object('estado', 'ANULADO', 'id_devolucion', v_id_devolucion),
        'Devolución Venta: ' || p_id_venta || ' | Motivo: ' || p_motivo
    );
    RETURN v_id_devolucion;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_listar_clientes                | CREATE OR REPLACE FUNCTION public.fn_listar_clientes(p_busqueda character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id_cliente character varying, nombres character varying, apellido_paterno character varying, apellido_materno character varying, ci_nit character varying, telefono character varying, email character varying, direccion text, nombre_completo text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        c.id_cliente,
        c.nombres,
        c.apellido_paterno,
        c.apellido_materno,
        c.ci_nit,
        c.telefono,
        c.email,
        c.direccion,
        TRIM(CONCAT(c.nombres, ' ', COALESCE(c.apellido_paterno, ''), ' ', COALESCE(c.apellido_materno, ''))) AS nombre_completo,
        c.estado
    FROM 
        public.clientes c
    WHERE 
        c.estado = 'ACTIVO' AND
        (p_busqueda IS NULL OR 
         c.nombres ILIKE '%' || p_busqueda || '%' OR 
         c.apellido_paterno ILIKE '%' || p_busqueda || '%' OR 
         c.ci_nit ILIKE '%' || p_busqueda || '%')
    ORDER BY 
        c.nombres ASC
    LIMIT 20;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_listar_productos               | CREATE OR REPLACE FUNCTION public.fn_listar_productos(p_buscar character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id_producto character varying, codigo_interno character varying, codigo_barras character varying, nombre character varying, precio_venta numeric, stock_actual integer, categoria character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.id_producto,
        p.codigo_interno,
        p.codigo_barras,
        p.nombre,
        p.precio_venta,
        p.stock_actual,
        c.nombre AS categoria,
        p.estado
    FROM 
        public.productos p
    LEFT JOIN public.categorias c ON p.id_categoria = c.id_categoria
    WHERE 
        p.estado = 'ACTIVO' AND
        (p_buscar IS NULL OR 
         p.nombre ILIKE '%' || p_buscar || '%' OR 
         p.codigo_interno ILIKE '%' || p_buscar || '%');
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| fn_reporte_inventario_valorado    | CREATE OR REPLACE FUNCTION public.fn_reporte_inventario_valorado()
 RETURNS TABLE(categoria character varying, cantidad_productos integer, stock_total integer, valor_venta_potencial numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        COALESCE(c.nombre, 'Sin Categoría') AS categoria,
        COUNT(p.id_producto)::integer AS cantidad_productos,
        COALESCE(SUM(p.stock_actual), 0)::integer AS stock_total,
        COALESCE(SUM(p.stock_actual * p.precio_venta), 0)::numeric AS valor_venta_potencial
    FROM 
        public.productos p
    LEFT JOIN public.categorias c ON p.id_categoria = c.id_categoria
    WHERE 
        p.estado = 'ACTIVO'
    GROUP BY 
        c.nombre;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_leer_usuarios                  | CREATE OR REPLACE FUNCTION public.fn_leer_usuarios(p_buscar character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id character varying, username character varying, empleado character varying, rol character varying, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        u.id_usuario,
        u.username,
        TRIM(CONCAT(e.nombres, ' ', e.apellido_paterno))::varchar AS empleado,
        r.nombre::varchar AS rol,
        u.estado
    FROM 
        public.usuarios u
    LEFT JOIN public.empleados e ON u.id_empleado = e.id_empleado
    LEFT JOIN public.roles r ON u.id_rol = r.id_rol
    WHERE 
        (p_buscar IS NULL OR 
         u.username ILIKE '%' || p_buscar || '%' OR 
         e.nombres ILIKE '%' || p_buscar || '%');
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_reporte_ventas_periodo         | CREATE OR REPLACE FUNCTION public.fn_reporte_ventas_periodo(p_fecha_inicio date, p_fecha_fin date)
 RETURNS TABLE(fecha date, cantidad_ventas integer, total_vendido numeric, promedio_ticket numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        DATE(v.fecha_hora) as fecha,
        COUNT(*)::integer as cantidad_ventas,
        COALESCE(SUM(v.total), 0)::numeric as total_vendido,
        COALESCE(AVG(v.total), 0)::numeric as promedio_ticket
    FROM public.ventas v
    WHERE DATE(v.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin
      AND UPPER(v.estado) IN ('COMPLETADA', 'ACTIVO')
    GROUP BY DATE(v.fecha_hora)
    ORDER BY fecha ASC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_leer_productos                 | CREATE OR REPLACE FUNCTION public.fn_leer_productos(p_buscar character varying DEFAULT NULL::character varying, p_categoria_id character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id character varying, codigo_interno character varying, codigo_barras character varying, nombre character varying, precio_venta numeric, stock_actual integer, stock_minimo integer, categoria character varying, marca character varying, estado_stock text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.id_producto AS id,
        p.codigo_interno,
        p.codigo_barras,
        p.nombre,
        p.precio_venta,
        p.stock_actual,
        p.stock_minimo,
        c.nombre AS categoria,
        p.marca,
        CASE 
            WHEN p.stock_actual <= 0 THEN 'CRITICO'
            WHEN p.stock_actual <= p.stock_minimo THEN 'BAJO'
            WHEN p.stock_actual > (p.stock_minimo * 3) THEN 'SOBRESTOCK'
            ELSE 'NORMAL'
        END AS estado_stock,
        p.estado
    FROM public.productos p
    LEFT JOIN public.categorias c ON p.id_categoria = c.id_categoria
    WHERE (p_categoria_id IS NULL OR p.id_categoria = p_categoria_id)
      AND (p_buscar IS NULL OR p.nombre ILIKE '%' || p_buscar || '%' OR p.codigo_interno ILIKE '%' || p_buscar || '%');
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_historial_compras              | CREATE OR REPLACE FUNCTION public.fn_historial_compras(p_fecha_inicio date, p_fecha_fin date, p_id_proveedor character varying DEFAULT NULL::character varying)
 RETURNS TABLE(id_compra character varying, proveedor text, fecha timestamp without time zone, total numeric, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        oc.id_orden as id_compra,
        COALESCE(p.nombre_contacto, p.razon_social, 'Sin proveedor')::text as proveedor,
        oc.fecha_emision::timestamp without time zone as fecha,  -- CORREGIDO: fecha_emision
        COALESCE(oc.total, 0)::numeric as total,
        oc.estado
    FROM public.ordenes_compra oc
    LEFT JOIN public.proveedores p ON oc.id_proveedor = p.id_proveedor
    WHERE oc.fecha_emision BETWEEN p_fecha_inicio AND p_fecha_fin  -- CORREGIDO
      AND (p_id_proveedor IS NULL OR oc.id_proveedor = p_id_proveedor)
    ORDER BY oc.fecha_emision DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| fn_listar_empleados               | CREATE OR REPLACE FUNCTION public.fn_listar_empleados()
 RETURNS TABLE(id_empleado character varying, nombre_completo text, cargo text, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        e.id_empleado,
        TRIM(COALESCE(e.nombres, '') || ' ' || COALESCE(e.apellido_paterno, ''))::text as nombre_completo,
        COALESCE(c.nombre, 'Sin cargo')::text as cargo,
        e.estado
    FROM public.empleados e
    LEFT JOIN public.cargos c ON e.id_cargo = c.id_cargo
    WHERE e.estado = 'ACTIVO';  -- Mantener filtro ACTIVO
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| fn_productos_por_vencer           | CREATE OR REPLACE FUNCTION public.fn_productos_por_vencer(p_dias_anticipacion integer DEFAULT 30)
 RETURNS TABLE(id_producto character varying, nombre character varying, fecha_vencimiento date, dias_restantes integer)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.id_producto,
        p.nombre,
        l.fecha_vencimiento,
        (l.fecha_vencimiento - CURRENT_DATE)::integer as dias_restantes
    FROM public.productos p
    JOIN public.lotes l ON p.id_producto = l.id_producto
    WHERE p.estado = 'ACTIVO'
      AND l.cantidad > 0                    -- CORREGIDO: "cantidad" no "cantidad_actual"
      AND l.estado = 'ACTIVO'               -- Solo lotes activos
      AND l.fecha_vencimiento IS NOT NULL
      AND l.fecha_vencimiento <= CURRENT_DATE + p_dias_anticipacion
    ORDER BY l.fecha_vencimiento ASC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| fn_reporte_productos_mas_vendidos | CREATE OR REPLACE FUNCTION public.fn_reporte_productos_mas_vendidos(p_fecha_inicio date, p_fecha_fin date, p_limite integer DEFAULT 10)
 RETURNS TABLE(producto character varying, cantidad_vendida bigint, ingresos_generados numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        p.nombre as producto,                -- CORREGIDO: JOIN con productos para nombre
        SUM(dv.cantidad)::bigint as cantidad_vendida,
        SUM(dv.subtotal)::numeric as ingresos_generados
    FROM public.detalle_ventas dv
    JOIN public.productos p ON dv.id_producto = p.id_producto  -- JOIN para obtener nombre
    JOIN public.ventas v ON dv.id_venta = v.id_venta
    WHERE DATE(v.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin
      AND UPPER(v.estado) IN ('COMPLETADA', 'ACTIVO')
    GROUP BY p.nombre
    ORDER BY ingresos_generados DESC
    LIMIT p_limite;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_leer_ventas                    | CREATE OR REPLACE FUNCTION public.fn_leer_ventas(p_fecha_inicio date, p_fecha_fin date)
 RETURNS TABLE(id character varying, fecha timestamp without time zone, cliente text, comprobante text, total numeric, estado character varying)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        v.id_venta as id,
        v.fecha_hora as fecha,
        COALESCE(c.nombres || ' ' || COALESCE(c.apellido_paterno, ''), v.razon_social, 'Cliente General')::text as cliente,
        COALESCE(v.tipo_comprobante || COALESCE(' - ' || v.numero_factura, ''), 'TICKET')::text as comprobante,
        v.total,
        v.estado
    FROM public.ventas v
    LEFT JOIN public.clientes c ON v.id_cliente = c.id_cliente
    WHERE DATE(v.fecha_hora) BETWEEN p_fecha_inicio AND p_fecha_fin
    ORDER BY v.fecha_hora DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_resumen_caja                   | CREATE OR REPLACE FUNCTION public.fn_resumen_caja(p_fecha date DEFAULT CURRENT_DATE)
 RETURNS TABLE(total_ventas integer, total_recaudado numeric, promedio_venta numeric, total_efectivo numeric, total_tarjeta numeric, total_qr numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        COUNT(v.id_venta)::integer as total_ventas,
        COALESCE(SUM(v.total), 0)::numeric as total_recaudado,
        COALESCE(AVG(v.total), 0)::numeric as promedio_venta,
        COALESCE(SUM(CASE WHEN p.medio = 'EFECTIVO' THEN p.importe ELSE 0 END), 0)::numeric as total_efectivo,
        COALESCE(SUM(CASE WHEN p.medio IN ('DEBITO', 'CREDITO') THEN p.importe ELSE 0 END), 0)::numeric as total_tarjeta,
        COALESCE(SUM(CASE WHEN p.medio = 'QR' THEN p.importe ELSE 0 END), 0)::numeric as total_qr
    FROM public.ventas v
    LEFT JOIN public.pagos p ON v.id_venta = p.id_venta
    WHERE DATE(v.fecha_hora) = p_fecha
      AND v.estado = 'ACTIVO';
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| fn_registrar_cierre_caja          | CREATE OR REPLACE FUNCTION public.fn_registrar_cierre_caja(p_id_usuario character varying, p_fecha date, p_hora_cierre time without time zone, p_total_efectivo numeric, p_diferencia numeric, p_observaciones text DEFAULT NULL::text, p_firma_supervisor character varying DEFAULT NULL::character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
    v_new_data JSONB;
BEGIN
    -- Generar ID
    v_id := 'CIERRE-' || TO_CHAR(p_fecha, 'YYYYMMDD') || '-' || LPAD((
        SELECT COALESCE(MAX(CAST(SUBSTRING(id_cierre FROM 'CIERRE-[0-9]{8}-([0-9]+)') AS INTEGER)), 0) + 1
        FROM public.cierre_caja 
        WHERE fecha = p_fecha
    )::VARCHAR, 2, '0');
    
    -- Insertar cierre
    INSERT INTO public.cierre_caja (
        id_cierre, id_usuario, fecha, hora_cierre, 
        total_efectivo, diferencia, observaciones, firma_supervisor
    ) VALUES (
        v_id, p_id_usuario, p_fecha, p_hora_cierre,
        p_total_efectivo, p_diferencia, p_observaciones, p_firma_supervisor
    );
    
    -- Preparar datos para auditoría
    v_new_data := jsonb_build_object(
        'id_cierre', v_id,
        'fecha', p_fecha,
        'total_efectivo', p_total_efectivo,
        'diferencia', p_diferencia
    );
    
    -- Registrar auditoría
    PERFORM public.fn_registrar_auditoria_completa(
        p_id_usuario,
        'CAJA',
        'CIERRE_CAJA',
        'cierre_caja',
        v_id,
        NULL,
        v_new_data,
        'Cierre de caja del día ' || p_fecha || '. Diferencia: ' || p_diferencia
    );
    
    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| fn_obtener_cierres_caja           | CREATE OR REPLACE FUNCTION public.fn_obtener_cierres_caja(p_fecha_inicio date DEFAULT (CURRENT_DATE - 30), p_fecha_fin date DEFAULT CURRENT_DATE)
 RETURNS TABLE(id_cierre character varying, usuario text, fecha date, hora_cierre time without time zone, total_efectivo numeric, diferencia numeric, observaciones text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        cc.id_cierre,
        COALESCE(e.nombres || ' ' || e.apellido_paterno, u.username)::text as usuario,
        cc.fecha,
        cc.hora_cierre,
        cc.total_efectivo,
        cc.diferencia,
        cc.observaciones::text
    FROM public.cierre_caja cc
    LEFT JOIN public.usuarios u ON cc.id_usuario = u.id_usuario
    LEFT JOIN public.empleados e ON u.id_empleado = e.id_empleado
    WHERE cc.fecha BETWEEN p_fecha_inicio AND p_fecha_fin
    ORDER BY cc.fecha DESC, cc.hora_cierre DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| fn_anular_venta                   | CREATE OR REPLACE FUNCTION public.fn_anular_venta(p_id_venta character varying, p_usuario_auditoria character varying, p_motivo text DEFAULT 'Sin especificar'::text)
 RETURNS boolean
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_old_data JSONB;
    v_new_data JSONB;
BEGIN
    -- Obtener datos anteriores
    SELECT jsonb_build_object(
        'id_venta', id_venta,
        'total', total,
        'estado', estado
    ) INTO v_old_data
    FROM public.ventas WHERE id_venta = p_id_venta;
    
    IF v_old_data IS NULL THEN
        RETURN FALSE;
    END IF;
    
    -- Anular venta
    UPDATE public.ventas 
    SET estado = 'ANULADO'
    WHERE id_venta = p_id_venta;
    
    -- Datos nuevos
    v_new_data := jsonb_build_object(
        'id_venta', p_id_venta,
        'estado', 'ANULADO',
        'motivo', p_motivo
    );
    
    -- Registrar auditoría
    PERFORM public.fn_registrar_auditoria_completa(
        p_usuario_auditoria,
        'VENTAS',
        'ANULAR_VENTA',
        'ventas',
        p_id_venta,
        v_old_data,
        v_new_data,
        'Anulación de venta. Motivo: ' || p_motivo
    );
    
    RETURN TRUE;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_leer_cierres_caja              | CREATE OR REPLACE FUNCTION public.fn_leer_cierres_caja(p_fecha date DEFAULT NULL::date)
 RETURNS TABLE(id character varying, fecha date, hora time without time zone, usuario text, efectivo numeric, diferencia numeric, observaciones text, firma text)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        cc.id_cierre as id,
        cc.fecha,
        cc.hora_cierre as hora,
        COALESCE(e.nombres || ' ' || e.apellido_paterno, u.username, 'Usuario ' || cc.id_usuario)::text as usuario,
        cc.total_efectivo as efectivo,
        cc.diferencia,
        cc.observaciones::text,
        cc.firma_supervisor::text as firma
    FROM public.cierre_caja cc
    LEFT JOIN public.usuarios u ON cc.id_usuario = u.id_usuario
    LEFT JOIN public.empleados e ON u.id_empleado = e.id_empleado
    WHERE (p_fecha IS NULL OR cc.fecha = p_fecha)
    ORDER BY cc.fecha DESC, cc.hora_cierre DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| fn_calcular_sistema_caja          | CREATE OR REPLACE FUNCTION public.fn_calcular_sistema_caja(p_usuario_id character varying DEFAULT NULL::character varying)
 RETURNS numeric
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_total NUMERIC;
BEGIN
    -- Calcular total de ventas en efectivo del día actual
    SELECT COALESCE(SUM(p.importe), 0)
    INTO v_total
    FROM public.ventas v
    JOIN public.pagos p ON v.id_venta = p.id_venta
    WHERE DATE(v.fecha_hora) = CURRENT_DATE
      AND v.estado = 'ACTIVO'
      AND p.medio = 'EFECTIVO';
    
    RETURN v_total;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| fn_crear_cierre_caja              | CREATE OR REPLACE FUNCTION public.fn_crear_cierre_caja(p_usuario_id character varying, p_efectivo_fisico numeric, p_observaciones text DEFAULT NULL::text, p_usuario_auditoria character varying DEFAULT NULL::character varying, p_firma_supervisor character varying DEFAULT NULL::character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
    v_total_sistema NUMERIC;
    v_diferencia NUMERIC;
    v_fecha DATE := CURRENT_DATE;
    v_hora TIME := CURRENT_TIME;
    v_new_data JSONB;
BEGIN
    -- Calcular total del sistema (solo efectivo)
    SELECT COALESCE(SUM(p.importe), 0)
    INTO v_total_sistema
    FROM public.ventas v
    JOIN public.pagos p ON v.id_venta = p.id_venta
    WHERE DATE(v.fecha_hora) = v_fecha
      AND v.estado = 'ACTIVO'
      AND p.medio = 'EFECTIVO';
    
    -- Calcular diferencia
    v_diferencia := p_efectivo_fisico - v_total_sistema;
    
    -- Generar ID con secuencia (CIERRE-001, CIERRE-002, etc.)
    v_id := 'CIERRE-' || LPAD(nextval('public.cierre_caja_seq')::VARCHAR, 3, '0');
    
    -- Insertar cierre CON firma_supervisor
    INSERT INTO public.cierre_caja (
        id_cierre, id_usuario, fecha, hora_cierre, 
        total_efectivo, diferencia, observaciones, firma_supervisor
    ) VALUES (
        v_id, p_usuario_id, v_fecha, v_hora,
        p_efectivo_fisico, v_diferencia, p_observaciones, p_firma_supervisor
    );
    
    -- Preparar datos para auditoría
    v_new_data := jsonb_build_object(
        'id_cierre', v_id,
        'fecha', v_fecha,
        'hora', v_hora,
        'efectivo_fisico', p_efectivo_fisico,
        'total_sistema', v_total_sistema,
        'diferencia', v_diferencia,
        'firma_supervisor', p_firma_supervisor
    );
    
    -- Registrar auditoría
    PERFORM public.fn_registrar_auditoria_completa(
        COALESCE(p_usuario_auditoria, p_usuario_id),
        'CAJA',
        'CIERRE_CAJA',
        'cierre_caja',
        v_id,
        NULL,
        v_new_data,
        'Cierre de caja. Diferencia: ' || v_diferencia || 
        CASE WHEN p_firma_supervisor IS NOT NULL THEN ', Firmado por: ' || p_firma_supervisor ELSE '' END
    );
    
    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| fn_agregar_detalle_cierre         | CREATE OR REPLACE FUNCTION public.fn_agregar_detalle_cierre(p_id_cierre character varying, p_denominacion numeric, p_cantidad integer)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
BEGIN
    -- Generar ID
    v_id := 'DET-' || LPAD(nextval('public.cierre_caja_detalle_seq')::VARCHAR, 5, '0');
    
    -- Insertar detalle
    INSERT INTO public.cierre_caja_detalle (id_detalle, id_cierre, denominacion, cantidad)
    VALUES (v_id, p_id_cierre, p_denominacion, p_cantidad);
    
    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| fn_obtener_detalle_cierre         | CREATE OR REPLACE FUNCTION public.fn_obtener_detalle_cierre(p_id_cierre character varying)
 RETURNS TABLE(id character varying, denominacion numeric, cantidad integer, subtotal numeric)
 LANGUAGE plpgsql
AS $function$
BEGIN
    RETURN QUERY
    SELECT 
        ccd.id_detalle as id,
        ccd.denominacion,
        ccd.cantidad,
        (ccd.denominacion * ccd.cantidad)::numeric as subtotal
    FROM public.cierre_caja_detalle ccd
    WHERE ccd.id_cierre = p_id_cierre
    ORDER BY ccd.denominacion DESC;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| fn_cierre_caja_completo           | CREATE OR REPLACE FUNCTION public.fn_cierre_caja_completo(p_usuario_id character varying, p_detalles jsonb, p_observaciones text DEFAULT NULL::text, p_usuario_auditoria character varying DEFAULT NULL::character varying, p_firma_supervisor character varying DEFAULT NULL::character varying)
 RETURNS character varying
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_id VARCHAR;
    v_total_fisico NUMERIC := 0;
    v_total_sistema NUMERIC;
    v_diferencia NUMERIC;
    v_fecha DATE := CURRENT_DATE;
    v_hora TIME := CURRENT_TIME;
    v_detalle JSONB;
    v_new_data JSONB;
BEGIN
    -- Calcular total físico desde detalles
    FOR v_detalle IN SELECT * FROM jsonb_array_elements(p_detalles)
    LOOP
        v_total_fisico := v_total_fisico + 
            ((v_detalle->>'denominacion')::numeric * (v_detalle->>'cantidad')::integer);
    END LOOP;
    
    -- Calcular total del sistema
    SELECT COALESCE(SUM(p.importe), 0)
    INTO v_total_sistema
    FROM public.ventas v
    JOIN public.pagos p ON v.id_venta = p.id_venta
    WHERE DATE(v.fecha_hora) = v_fecha
      AND v.estado = 'ACTIVO'
      AND p.medio = 'EFECTIVO';
    
    -- Calcular diferencia
    v_diferencia := v_total_fisico - v_total_sistema;
    
    -- Generar ID cierre
    v_id := 'CIERRE-' || LPAD(nextval('public.cierre_caja_seq')::VARCHAR, 3, '0');
    
    -- Insertar cierre
    INSERT INTO public.cierre_caja (
        id_cierre, id_usuario, fecha, hora_cierre, 
        total_efectivo, diferencia, observaciones, firma_supervisor
    ) VALUES (
        v_id, p_usuario_id, v_fecha, v_hora,
        v_total_fisico, v_diferencia, p_observaciones, p_firma_supervisor
    );
    
    -- Insertar detalles
    FOR v_detalle IN SELECT * FROM jsonb_array_elements(p_detalles)
    LOOP
        INSERT INTO public.cierre_caja_detalle (id_detalle, id_cierre, denominacion, cantidad)
        VALUES (
            'DET-' || LPAD(nextval('public.cierre_caja_detalle_seq')::VARCHAR, 5, '0'),
            v_id,
            (v_detalle->>'denominacion')::numeric,
            (v_detalle->>'cantidad')::integer
        );
    END LOOP;
    
    -- Preparar auditoría
    v_new_data := jsonb_build_object(
        'id_cierre', v_id,
        'total_fisico', v_total_fisico,
        'total_sistema', v_total_sistema,
        'diferencia', v_diferencia,
        'detalles', p_detalles,
        'firma_supervisor', p_firma_supervisor
    );
    
    -- Registrar auditoría
    PERFORM public.fn_registrar_auditoria_completa(
        COALESCE(p_usuario_auditoria, p_usuario_id),
        'CAJA',
        'CIERRE_CAJA_COMPLETO',
        'cierre_caja',
        v_id,
        NULL,
        v_new_data,
        'Cierre completo con arqueo. Diferencia: ' || v_diferencia
    );
    
    RETURN v_id;
END;
$function$
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |